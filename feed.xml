<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title></title>
		<description>Udi Cohen's blog</description>
		<link>/</link>
		<atom:link href="/feed.xml" rel="self" type="application/rss+xml" />
		
			<item>
				<title>Building CardFlix – A Modern Twist on the Old Movie Shelf</title>
				<description>&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image11.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image11.jpg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Watching TV is one of my favorite activities, but I noticed it’s become too easy for kids (and adults) to fall into the endless loop of short, addictive YouTube videos instead of enjoying a thoughtful episode of a TV show or diving into an adventure movie. I got tired of seeing my kids glued to the screen watching yet another YouTuber attempt a ridiculous “Fast-Food Challenge.”&lt;/p&gt;

&lt;p&gt;So I decided to make good content more accessible - and fun to play. The result: watching content on the TV by scanning physical &lt;strong&gt;Movie Cards&lt;/strong&gt; with NFC. I call it &lt;strong&gt;CardFlix&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/_sqxoAX3GW0&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	CardFlix in action
&lt;/div&gt;

&lt;p&gt;This project was a great opportunity to involve my kids in electronics, showing them how to make something truly useful by building it together.&lt;/p&gt;

&lt;p&gt;The scanner runs on &lt;a href=&quot;https://esphome.io/&quot;&gt;&lt;u&gt;ESPHome&lt;/u&gt;&lt;/a&gt; - a framework that makes creating custom smart devices surprisingly simple, and connects to my &lt;a href=&quot;https://www.home-assistant.io/&quot;&gt;&lt;u&gt;Home Assistant&lt;/u&gt;&lt;/a&gt; smart home setup. With my kids’ help, we created &lt;strong&gt;over 50 cards&lt;/strong&gt; covering all their favorite shows and movies, and the collection keeps growing. It was such a hit that I built a second scanner for another room in our house. To make the scanner blend in, I designed and 3D-printed a small enclosure that matches the décor of the room while keeping the scanner kid-friendly and accessible.&lt;/p&gt;

&lt;p&gt;Creating the initial version of this scanner was a fun weekend project. I was able to show my kids the process of bringing an idea to life, in addition to me gaining more confidence creating ESPHome projects, which became more useful for other projects that I’ll share soon.&lt;/p&gt;

&lt;h2 id=&quot;building-the-electronics&quot;&gt;Building the electronics&lt;/h2&gt;

&lt;p&gt;The circuit is straightforward: connecting an NFC reader module (&lt;a href=&quot;https://amzn.to/3L6np34&quot;&gt;&lt;u&gt;PN532&lt;/u&gt;&lt;/a&gt;) to a microcontroller (&lt;a href=&quot;https://amzn.to/43rh8oU&quot;&gt;&lt;u&gt;ESP8266&lt;/u&gt; &lt;u&gt;WeMos D1 mini&lt;/u&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image6.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image6.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Circuit diagram showing the PN532 NFC reader connected to the microcontroller
&lt;/div&gt;

&lt;p&gt;To connect a microcontroller, like the Wemos D1 Mini, to an NFC reader (or other peripherals such as sensors, displays etc.) there are 2 common methods: &lt;strong&gt;I²C&lt;/strong&gt; or &lt;strong&gt;SPI&lt;/strong&gt;. SPI can handle higher throughput than I²C and is generally faster, which is good if we connect an LCD display and need to move a lot of pixels quickly for it, but it’s not particularly useful for a simple tag scanner. I chose I²C because it’s simpler to hook up, it needs only 2 wires in compare to 4 wires we need to support SPI connection.&lt;/p&gt;

&lt;p&gt;One critical step to note here: &lt;strong&gt;set the PN532’s mode correctly&lt;/strong&gt;. The board has tiny DIP switches to toggle between I²C and SPI. Make sure these match your chosen mode - otherwise you’ll be staring at a non-responsive scanner and wondering why nothing works. Let’s just say I learned that lesson the hard way…&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image10.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image10.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Flipping the PN532 mode from SPI to I²C
&lt;/div&gt;

&lt;p&gt;Once the correct mode is set, I wired the SDA and SCL pins from the PN532 to the Wemos D1 mini. You can map I²C lines to almost any pins on the microcontroller; I chose &lt;strong&gt;D8&lt;/strong&gt; (for SDA) and &lt;strong&gt;D7&lt;/strong&gt; (for SCL). These need to match what we’ll later declare in the ESPHome config:&lt;/p&gt;

&lt;p&gt;After confirming the wiring, I soldered everything together. A pair of &lt;em&gt;helping hands&lt;/em&gt; was invaluable here - keeping the boards aligned so I could stack them neatly and compactly. That’s important, since they need to fit snugly inside the enclosure, as we’ll see later.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image17.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image17.jpg&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Soldered electronics stack help by the helping hands
&lt;/div&gt;

&lt;p&gt;BTW, the reason I picked the &lt;em&gt;Wemos D1 mini&lt;/em&gt; as the microcontroller for this project is because of its size. I knew I would need to eventually mount the device near the TV, so having a small form-factor is a useful feature. ESPHome, which we’ll talk about next, supports several other microcontroller types in different shapes and with varied capabilities. Even &lt;a href=&quot;https://amzn.to/434jtWK&quot;&gt;&lt;u&gt;this baby-chip&lt;/u&gt;&lt;/a&gt; is supported.&lt;/p&gt;

&lt;h2 id=&quot;smart-home-integration&quot;&gt;Smart Home Integration&lt;/h2&gt;

&lt;p&gt;With the hardware stacked and soldered, it was ready for the fun part - bringing it to life through ESPHome and tying it into Home Assistant, where we’ll write an automation to make the scanner react to different cards.&lt;/p&gt;

&lt;p&gt;If you’re not already using &lt;a href=&quot;https://www.home-assistant.io/&quot;&gt;Home Assistant&lt;/a&gt;, it’s an open-source smart-home platform that brings all your devices together - TVs, phones, sensors, air conditioners, and much more. You can easily run it on a Raspberry Pi, an old PC, or a virtual machine, so even if this is your first smart-home experiment, you can still install it just for this project&lt;/p&gt;
&lt;h3 id=&quot;esphome-config-basics&quot;&gt;ESPHome Config Basics&lt;/h3&gt;

&lt;p&gt;The scanner runs on &lt;a href=&quot;https://esphome.io/&quot;&gt;&lt;u&gt;ESPHome&lt;/u&gt;&lt;/a&gt;, which makes connecting hardware like the PN532 reader almost trivial. Instead of writing firmware, you just declare the pins and components in YAML, and ESPHome takes care of the rest.&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;esphome&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cardflix_scanner&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;platform&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ESP8266&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;board&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;d1_mini&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;i2c&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;sda&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;D8&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# The pins we connected earlier&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;scl&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;D7&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;scan&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# optional, helps confirm wiring&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;pn532_i2c&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nfc_reader&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(&lt;a href=&quot;https://gist.github.com/Udinic/dd0198f7b6b6fc5699ca6cc5079ad70f&quot;&gt;&lt;u&gt;Full ESPSHome config yaml code&lt;/u&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;“Installing” this config on our microcontroller involves connecting it to the computer and using 2 web tools that do everything. The first tool, &lt;em&gt;ESPHome Builder&lt;/em&gt; (a Home Assistant Add-on), parses the yaml config and generates the firmware based on the info on that config. The second tool, &lt;a href=&quot;https://web.esphome.io/?dashboard_wizard&quot;&gt;&lt;u&gt;ESPHome Web&lt;/u&gt;&lt;/a&gt;, connects to your device via USB cable and flashes the firmware onto it. There are plenty of good instructions for the process, such as &lt;a href=&quot;https://www.youtube.com/watch?v=cfkW7ZmiMEw&amp;amp;t=759s&quot;&gt;&lt;u&gt;this youtube video&lt;/u&gt;&lt;/a&gt; or the &lt;a href=&quot;https://esphome.io/guides/getting_started_hassio/&quot;&gt;&lt;u&gt;official ESPHome instructions&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;from-esphome--home-assistant&quot;&gt;From ESPHome → Home Assistant&lt;/h3&gt;

&lt;p&gt;Once the firmware is loaded onto the Wemos D1 mini, Home Assistant automatically detects the device and prompts you to add it as an integration.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image5.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image5.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Home Assistant integration setup screen
&lt;/div&gt;

&lt;p&gt;From there, the scanner can report any NFC tags it detects. Home Assistant has an Event Listening feature under Developer Tools, a quick scan of any card, while listening to “tag_scanned” events, will show some useful data for the card and the tag scanner. &lt;em&gt;tag_id&lt;/em&gt; is the card’s unique ID and &lt;em&gt;device_id&lt;/em&gt; is the tag scanner’s unique ID.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image19.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image19.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Event Listener showing tag_scanned event data
&lt;/div&gt;

&lt;p&gt;We &lt;em&gt;could&lt;/em&gt; also write data onto the cards, but we won’t do that here. There’s no need to complicate the process of onboarding new movie cards, since each card already has a permanent unique identifier (the &lt;em&gt;tag_id&lt;/em&gt; we see above). We’ll design an automation that maps each card’s Tag ID to the content we need to play.&lt;/p&gt;

&lt;h3 id=&quot;writing-the-automation&quot;&gt;Writing the Automation&lt;/h3&gt;

&lt;p&gt;There are a few ways to set up the automation. I liked the structure Xavier at &lt;a href=&quot;https://simplyexplained.com/blog/how-i-built-an-nfc-movie-library-for-my-kids/&quot;&gt;&lt;em&gt;&lt;u&gt;Simply Explained&lt;/u&gt;&lt;/em&gt;&lt;/a&gt; shared, it keeps the mapping of Tag IDs to content easy to read and update.&lt;/p&gt;

&lt;p&gt;I made a few changes of my own:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Support for multiple scanners (so different rooms can have their own devices).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Some tweaks to handle different types of content (Plex, Netflix, etc.).&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here’s how it works.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;1. The automation’s trigger - scanning a card.&lt;/strong&gt;&lt;br /&gt;
The trigger is a &lt;em&gt;tag_scanned&lt;/em&gt; event, the same one we saw earlier when testing the scanner using the Developer Tools. The automation will be triggered when such an event is fired.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image7.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image7.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The Automation&apos;s trigger configuration for tag_scanned events
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;2. Defining the variables we need.&lt;/strong&gt;&lt;br /&gt;
These are the variables the automation uses:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;SCANNER_MAPPING&lt;/strong&gt; - A simple mapping between Scanner IDs to the TV entity they should operate on. This will ensure that the scanner in the bedroom will start any playback on the Bedroom TV and not other TVs. We can get the Scanner ID using the Event Listener tool we saw earlier.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;TARGET_TV&lt;/strong&gt; - This variable resolves to the TV entity the automation needs to target, based on the Scanner ID that was provided by the &lt;em&gt;tag_scanned&lt;/em&gt; event (&lt;em&gt;trigger.event.data.device_id&lt;/em&gt; = The Scanner ID). This also defines the default TV in case the scanner is not mapped to any specific TV (In this case, the default is Living Room TV).&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;CARD_MAPPING&lt;/strong&gt; - Maps each card’s Tag ID to the content it should play.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image2.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image2.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The automation&apos;s variables, we&apos;ll mostly update CARD_MAPPING with Tag IDs and content IDs
&lt;/div&gt;

&lt;p&gt;Each card mapping includes the Tag ID, a name (just for readability) and the Content ID. The automation supports a few content types, for several streaming services and Plex. We’ll see below how we deep link to open the content.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;3. Turning on the TV, if needed&lt;/strong&gt;&lt;br /&gt;
The TARGET_TV variable holds the TV we’re targeting, we’ll check its status and turn it on if needed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image18.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image18.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	TV power control logic in the automation
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;4. Start the requested content using the content mapping defined in CARD_MAPPING&lt;/strong&gt;&lt;br /&gt;
Each streaming service has its own Deep Link format. For each content we’ll check the streaming service it’s using, retrieve the correct deep link format and use it with the content’s ID to start the playback.&lt;/p&gt;

&lt;p&gt;In the example below, looking up the Tag ID in CARD_MAPPING provided a “netflix_id”, which we used as part of the Netflix Deep Link URL, like this:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;https://www.netflix.com/watch/&amp;lt; CARD_MAPPING[trigger.event.data.tag_id].netflix_id &amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The URL is sent to my Apple TV as a “Play Media” request.&lt;/p&gt;

&lt;p&gt;This URL works on an Apple TV, which is connected to my TV. It’s possible other media devices, such as Smart TVs, would have different requirements to deep link to a specific content.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image20.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image20.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The flow of playing a Netflix content in the automation
&lt;/div&gt;

&lt;p&gt;These are the main logic of the automation, the full yaml code is &lt;a href=&quot;https://gist.github.com/Udinic/5686171f45b45baca0a10299ac2c6852&quot;&gt;&lt;u&gt;available here&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;h4 id=&quot;deep-linking-to-content&quot;&gt;Deep Linking to Content&lt;/h4&gt;

&lt;p&gt;Deep links are URLs that open a specific content on a specific streaming service. Not all of them are properly documented and some of them might not work on every streaming device (e.g. Apple TV, Smart TVs, Roku device). These are the Deep Link URLs that I found to be working on an Apple TV:&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;strong&gt;Service&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;URL Format&lt;/strong&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Disney+&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://www.disneyplus.com/en-gb/play/&amp;lt;Content ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Netflix&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://www.netflix.com/watch/&amp;lt;Content ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Hulu&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hulu://watch/&amp;lt;Content ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Plex Movie/TV&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plex://play/?metadataKey=%2Flibrary%2Fmetadata%2F&amp;lt;Content ID&amp;gt;&amp;amp;server=&amp;lt;Plex server ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Plex Playlist&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plex://play/?metadataKey=%2Fplaylists%2F&amp;lt;Content ID&amp;gt;&amp;amp;server=&amp;lt;Plex server ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;The Content ID can be retrieved by opening the content on your browser and checking the URL.&lt;/p&gt;

&lt;p&gt;Tip: Using a Plex playlist is a great way to watch random episodes of some TV Show(s), perfect for shows the kids have already watched a hundred times. &lt;a href=&quot;https://forums.plex.tv/t/tip-how-to-create-an-autoplaylist-with-random-sort/472823&quot;&gt;&lt;u&gt;Instructions on how to do that&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;And here’s the automation in action:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/Z5VRNPnNeZE&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Demo video testing the automation
&lt;/div&gt;

&lt;h2 id=&quot;creating-the-content-cards&quot;&gt;Creating the Content Cards&lt;/h2&gt;

&lt;p&gt;The electronics and automations are only half the story — the real magic (and the part my kids loved most) was creating the movie cards themselves.&lt;/p&gt;

&lt;p&gt;Each card is laminated with the TV/Movie’s artwork. The laminate not only makes the cards sturdy enough for repeated use, but also gives them that satisfying “real card” feel&lt;/p&gt;

&lt;p&gt;We used &lt;a href=&quot;https://fanart.tv/&quot;&gt;&lt;u&gt;fanart.tv&lt;/u&gt;&lt;/a&gt; as our main source for high-quality TV and movie artwork. It has a huge collection of posters, logos, and backgrounds that work perfectly for this kind of project. Once we picked the right art, we copied it into a Google Doc and resized it to the dimensions of a credit card (Tip: resize to Width 2.12 inch, Height: 3.36 inch, Ratio: 1.583333). We put a few posters on a single page and printed it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image12.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image12.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Arranging the movie posters for printing
&lt;/div&gt;

&lt;p&gt;The printed poster we put on top of the card, slipped into a &lt;a href=&quot;https://amzn.to/4htrRoL&quot;&gt;&lt;u&gt;Laminating Pouch&lt;/u&gt;&lt;/a&gt; and from there straight to the laminating machine. The &lt;a href=&quot;https://amzn.to/47kbCad&quot;&gt;&lt;u&gt;one I got&lt;/u&gt;&lt;/a&gt; is cheap (under $20) and it served us well in several projects, definitely nice to have around the house.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image21.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image21.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	My daughter Emma is showing how we lamindate a movie card
&lt;/div&gt;

&lt;h3 id=&quot;onboarding-a-new-card&quot;&gt;Onboarding a New Card&lt;/h3&gt;

&lt;p&gt;Once the physical card is ready, the final step is onboarding it into Home Assistant. To make things easier, I’ve added to the automation a fallback in case we scan a card that’s not assigned to any content, which prints the card’s Tag ID to Home Assistant’s Logbook.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image1.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image1.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The &quot;Else&quot; clause of the automation, printing the card&apos;s Tag ID to the Logbook
&lt;/div&gt;

&lt;p&gt;This is how the Logbook entry looks like:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image3.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image3.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Home Assistant&apos;s Logbook entry detailing the Tag ID of a new card to onboard
&lt;/div&gt;

&lt;p&gt;Then all we need is to add a new entry in the CARD_MAPPING variable inside our automation:&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;CARD_MAPPING&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;3D-1A-D6-FD&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Octonauts&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;netflix_id&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80023363&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By streamlining this process we made it very easy to grow the collection. Every time we want to add a few new TV Shows or Movies - I would search the content IDs in the streaming services, while my kids handle the card laminating step and we would meet at the end by scanning the cards and adding the new mapping for each new card. We don’t need to leave the house for a fun family activity.&lt;/p&gt;

&lt;h2 id=&quot;3d-printing-the-enclosureand-more&quot;&gt;3D Printing the Enclosure..and more&lt;/h2&gt;

&lt;p&gt;With the electronics and cards ready, the last step was giving the scanner a proper home. I wanted it to be accessible for the kids while being subtle enough to blend into the room’s décor.&lt;/p&gt;

&lt;p&gt;Instead of designing something from scratch, I started with an existing enclosure I found online and personalized it with a simple logo that ChatGPT helped create. The result was a clean, kid-friendly enclosure with a custom logo that makes it feel like a finished product.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image4.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image4.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Desgining a 3D printed enclosure with a custom CardFlix logo on the BambuLab Slicer
&lt;/div&gt;

&lt;p&gt;I printed the design on my Bambu Lab printer, using standard PLA. The compact stack of the electronics fit snugly inside, with just enough room for the wires and solder joints.&lt;/p&gt;

&lt;table class=&quot;side-by-side&quot;&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image15.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image15.jpg&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image16.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image16.jpg&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	3D printed enclosure assembly and final mounted scanner
&lt;/div&gt;

&lt;p&gt;You can download the enclosure from &lt;a href=&quot;https://makerworld.com/en/models/1924849-cardflix-enclosure#profileId-2065641&quot;&gt;&lt;u&gt;here&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To keep the cards organized and accessible I created 2 boxes - one to hold a large group of cards, another for holding a small group of “most favorite” cards next to the reader.&lt;/p&gt;

&lt;table class=&quot;side-by-side&quot;&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image8.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image8.png&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image9.png&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image9.png&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Card storage boxes - large collection box and slim favorites box
&lt;/div&gt;
&lt;p&gt;And in case you wonder, there are 4 Bluey cards in those boxes…&lt;/p&gt;

&lt;p&gt;Links to the 3D models: &lt;a href=&quot;https://makerworld.com/en/models/1924938-card-box-for-cardflix#profileId-2065737&quot;&gt;&lt;u&gt;Cards box&lt;/u&gt;&lt;/a&gt; / &lt;a href=&quot;https://makerworld.com/en/models/1924909-card-box-for-cardflix-slim#profileId-2065705&quot;&gt;&lt;u&gt;Cards box (slim)&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;bringing-it-all-together&quot;&gt;Bringing It All Together&lt;/h2&gt;

&lt;p&gt;With the hardware soldered, the enclosure printed, the Movie Cards laminated, and the automation wired into Home Assistant - it was time for the payoff.&lt;/p&gt;

&lt;table class=&quot;side-by-side&quot;&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image13.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image13.jpg&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
    &lt;td&gt;
      &lt;a href=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image14.jpg&quot;&gt;&lt;img src=&quot;/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image14.jpg&quot; /&gt;&lt;/a&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Complete CardFlix setup showing scanner and card collection
&lt;/div&gt;

&lt;p&gt;Here’s a short demo of the scanner in action:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/jGjedY8tdiY&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Final demo video - this is how we usually play content, using the &quot;most favorites&quot; box.
&lt;/div&gt;

&lt;p&gt;No menus, no remotes, no digging through apps. Just the card, the scanner, and the content.&lt;/p&gt;

&lt;p&gt;It’s been a huge success in our house - my kids love the ritual of picking a card and watching it come to life, and it gives them a healthier, more intentional way to choose what to watch.&lt;/p&gt;

&lt;h2 id=&quot;closing-thoughts&quot;&gt;Closing Thoughts&lt;/h2&gt;

&lt;p&gt;This project started as a way to combine electronics tinkering with something useful for the family, and it turned into one of our favorite weekend builds. Between the hands-on soldering, designing the cards, and the 3D-printed enclosure, everyone got a part to play - and the end result is something truly useful.&lt;/p&gt;

&lt;p&gt;If you’d like to build your own, all the relevant links to get you through that are below. And if you do make one - I’d love to hear about it!&lt;/p&gt;

&lt;h3 id=&quot;links&quot;&gt;Links&lt;/h3&gt;

&lt;p&gt;Electronics:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://amzn.to/43rh8oU&quot;&gt;&lt;u&gt;Microcontroller: WeMos D1 Mini&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://amzn.to/3L6np34&quot;&gt;&lt;u&gt;NFC Reader: PN532&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://amzn.to/4nU79jk&quot;&gt;&lt;u&gt;NFC Cards&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Code:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://gist.github.com/Udinic/dd0198f7b6b6fc5699ca6cc5079ad70f&quot;&gt;&lt;u&gt;ESPHome config yaml&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://gist.github.com/Udinic/5686171f45b45baca0a10299ac2c6852&quot;&gt;&lt;u&gt;Home Assistant Automation yaml&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Lamination:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://amzn.to/47kbCad&quot;&gt;&lt;u&gt;Crenova Laminator Machine&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://amzn.to/4htrRoL&quot;&gt;&lt;u&gt;Laminating Pouches, card-sized&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;3D Print Models:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://makerworld.com/en/models/1924849-cardflix-enclosure#profileId-2065641&quot;&gt;&lt;u&gt;Enclosure&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://makerworld.com/en/models/1924938-card-box-for-cardflix#profileId-2065737&quot;&gt;&lt;u&gt;Card Box (Large)&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://makerworld.com/en/models/1924909-card-box-for-cardflix-slim#profileId-2065705&quot;&gt;&lt;u&gt;Card Box (Slim)&lt;/u&gt;&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;
</description>
				<pubDate>Sat, 01 Nov 2025 00:00:00 -0400</pubDate>
				<link>/2025/11/01/building-cardflix-a-modern-twist-on-the-old-movie-shelf/</link>
				<guid isPermaLink="true">/2025/11/01/building-cardflix-a-modern-twist-on-the-old-movie-shelf/</guid>
			</item>
		
			<item>
				<title>Automating my balcony shade... with NFC!</title>
				<description>&lt;p&gt;These past few months I spent mostly at home, as everyone else, and decided to take on a project to improve my time there. With three kids at our cozy apartment, it’s no wonder I loved spending a lot of time on our balcony. While I like the breeze and the view, I hated lowering and raising the sun shade. It’s a heavy shade, so it took more effort and time to operate than a regular bedroom window shade/blinds. I challenged myself to automate this shade by any means necessary!&lt;/p&gt;

&lt;p&gt;I found a strong motor, designed a circuit and programmed a microcontroller to run the show. I mounted a switch box with up/down buttons and used NFC to support “shade presets”. Finally, I got everything connected to the internet and respond to voice commands from Google Assistant. The result:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/intro-circuit.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/intro-circuit.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The complete smart shade controller circuit
&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/f4yYC6kvG9Y&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Demo of the smart shade controller
&lt;/div&gt;

&lt;p&gt;That was quite a journey.&lt;/p&gt;

&lt;p&gt;I dived into the world of Arduino, where I learned how to design and program circuits. I also gained a better grasp on mechanical engineering concepts and got some experience applying them in real life. At the end, I had a polished Shade Controller that works reliably and safe for everyone to use, including my kids.&lt;/p&gt;

&lt;p&gt;In this post I wanted to share my experience &lt;strong&gt;building a smart shade controller from scratch&lt;/strong&gt;. Here’s an overview of the steps I’ll cover:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Finding a suitable motor and figuring out how to attach it to the shade.&lt;/li&gt;
  &lt;li&gt;Building the circuit and testing it in my balcony.&lt;/li&gt;
  &lt;li&gt;Taking automation to the next level by using NFC (Near-Field Communication).&lt;/li&gt;
  &lt;li&gt;Improving the appearance of the shade controller.&lt;/li&gt;
  &lt;li&gt;Supporting voice commands using Google Assistant.&lt;/li&gt;
  &lt;li&gt;Tips and lessons learned.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I think the creation process was a cool experience that’s worth the read on it’s own, but I also hope that some of my methods, research and learnings will help others undertake similar projects.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;setting-up-the-motor&quot;&gt;Setting up the Motor&lt;/h2&gt;

&lt;p&gt;Building a custom smart shade/blinds is a pretty common project, but as I researched this subject I didn’t find a solution that fits the type of shade I have. In most of these examples, the motor was moving the blinds by pulling a chain or rotating a small twist shaft.&lt;/p&gt;

&lt;div class=&quot;outer-grid&quot;&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
  		&lt;a href=&quot;http://www.roberttrescott.com/shadesblinds.html&quot;&gt;
  			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/other-shaft.jpg&quot; /&gt; 
  		&lt;/a&gt;
	&lt;/div&gt;
  	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;https://github.com/vietquocnguyen/NodeMCU-ESP8266-Servo-Smart-Blinds&quot;&gt;
  			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/other-ballchain.jpg&quot; /&gt;
  		&lt;/a&gt;
  		&lt;a href=&quot;http://energydefender.blogspot.com/2010/02/arduino-controlled-electric-blinds.html&quot;&gt;
  			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/other-twist.jpg&quot; style=&quot;padding-top: 8px;&quot; /&gt;  	
  		&lt;/a&gt;
  	&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Examples for other smart shade projects. Click on each image to see the relevant project.
&lt;/div&gt;

&lt;p&gt;The shade I installed in my balcony is much bigger and heavier than most of these shades. It’s 8 feet wide, weighs 8 pounds and uses a crank and a wand to operate.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;https://www.amazon.com/gp/product/B00IWMLEZS/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/shade-amazon.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The shade I have on my balcony
&lt;/div&gt;

&lt;p&gt;To start, I need to find a strong motor that can actually move this shade. There are ways to measure the force needed to move the shade (like using a &lt;a href=&quot;https://www.engineeringtoolbox.com/torque-wrench-luggage-scale-d_1909.html&quot;&gt;luggage scale&lt;/a&gt;), but I ended up consulting my mechanical engineer brother, who helped me pick a motor that should be strong enough for the job. I found a &lt;a href=&quot;https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/&quot;&gt;Servo motor&lt;/a&gt; that’s strong by itself, but it also comes inside a gearbox that increases its torque (and I could use all the torque I can get!). The gearbox has 2 gears in a 2:1 ratio, which produces half the speed of the original servo motor, but with twice the torque. To close or open the shade we need to rotate the crank 60 times, so with the 31 RPM the motor can do - it’ll take about 2 minutes. That’s reasonable enough.&lt;/p&gt;

&lt;p&gt;Now that I have a motor, I needed to find a way to mount it on the roller and get it to rotate the crank. I took measurements and started researching…&lt;/p&gt;

&lt;div class=&quot;outer-grid&quot;&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/measure1.jpg&quot; /&gt; 
	&lt;/div&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/measure2.jpg&quot; /&gt; 
	&lt;/div&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/measure3.jpg&quot; /&gt; 
	&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Taking measurements
&lt;/div&gt;

&lt;p&gt;Connecting the motor to the crank and rotating it was also not trivial. I took some measurements, but I don’t have a 3D printer so I can’t just print a perfect adapter. Luckily, after some online searching I found a &lt;a href=&quot;https://www.servocity.com/lightweight-linear-actuator-mounting-bracket/&quot;&gt;bracket&lt;/a&gt; that fits perfectly! To celebrate, I did an initial test to verify the motor can actually move the shade in both directions:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/FIFcKEm9gtY&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Testing the motor
&lt;/div&gt;

&lt;p&gt;A successful mount of the motor needs to produce a smooth crank rotation while the motor spins, any misalignment between the rotation planes of the motor and the crank could cause friction that damages the shade’s mechanism or the motor. Getting this alignment right was found to be quite challenging.&lt;/p&gt;

&lt;p&gt;Since I don’t have a 3D printer, I had to improvise a setup with existing structural components. I found &lt;a href=&quot;https://www.servocity.com/&quot;&gt;ServoCity&lt;/a&gt;, a well-organized website that sells parts for projects like this. On the site, I found and ordered a bunch of different structural components that might help me. I used various metal plates and brackets to mount the motor in different ways, testing the crank’s rotation and making adjustments. After some trial and error, and a bunch of new holes in my wall, I eventually found an arrangement that worked.&lt;/p&gt;

&lt;div class=&quot;outer-grid&quot;&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/mount1.jpg&quot;&gt;
			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/mount1.jpg&quot; /&gt; 
		&lt;/a&gt;
	&lt;/div&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/mount2.jpg&quot;&gt;
			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/mount2.jpg&quot; /&gt; 
		&lt;/a&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Mounting the motor. First attempt on the left, final position on the right.
&lt;/div&gt;

&lt;p&gt;Cool, now that I have the motor in place - I need to build the circuit that controls it.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;building-the-shade-controller-circuit&quot;&gt;Building the Shade Controller Circuit&lt;/h2&gt;

&lt;p&gt;My initial requirement for the shade controller was simple: have 2 buttons that can spin the motor in both directions. That was a great excuse to start tinkering with Arduino, something I wanted to do for a while.  So I dived right in.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/arduino-simple.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/arduino-simple.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Simple circuit to spin the motor in both directions.
&lt;/div&gt;

&lt;p&gt;The 2 buttons are connected to the Arduino through the breadboard, each one is connected to a different pin on the Arduino board. The code constantly reads the value of these pins to detect when a button was pressed. By default, each pin returns the value HIGH but during the time a button is pressed the pin’s value will be LOW. The code ignores long presses and acts only when a button changes state, which is why we compare the current pin’s value to the previous one.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cpp&quot; data-lang=&quot;cpp&quot;&gt;&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&amp;lt;Servo.h&amp;gt;&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt; &lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;
&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// Pin definitions&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#define PIN_SERVO (13)
#define PIN_UP_BTN (5)
#define PIN_DOWN_BTN (15)
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Servo&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Setting up the button with the pins they&apos;re wired to&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;pinMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_UP_BTN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;INPUT_PULLUP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;pinMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_DOWN_BTN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;INPUT_PULLUP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Main function that loops as long as the controller is powered on&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Reading the value in the pins connected to the buttons.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// The default read will be HIGH, while pressing a button it&apos;s changed to LOW&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;btnUpCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;digitalRead&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_UP_BTN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;btnDownCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;digitalRead&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_DOWN_BTN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The UP button is pressed &lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;btnUpCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnUpPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HIGH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// If the motor is already spinning - stop it&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;raiseShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;  

  &lt;span class=&quot;c1&quot;&gt;// The DOWN button is pressed  &lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;btnDownCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnDownPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HIGH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;lowerShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;btnUpPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnUpCurr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;btnDownPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnDownCurr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The Servo motor is also connected to one of the Arduino’s pins, using the yellow/white wire. Controlling the motor is done using an API that’s part of a Servo library.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cpp&quot; data-lang=&quot;cpp&quot;&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;lowerShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;attach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_SERVO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Value smaller than 1500 will spin the motor counter-clockwise&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writeMicroseconds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;850&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;  
  &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;raiseShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;attach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PIN_SERVO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Value larger than 1500 will spin the motor clockwise&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;writeMicroseconds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;  
  &lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;myServo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;detach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Internally, the Servo library is controlling the motor by sending it signals in “different formats”, which contain the position and direction the motor should be spinning. For more on that, check out &lt;a href=&quot;https://en.wikipedia.org/wiki/Servo_control&quot;&gt;how Pulse-Width Modulation works&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After getting this simple circuit to work, I decided to replace the Arduino board with a smaller microcontroller - the ESP32.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/esp32-comparison.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/esp32-comparison.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Arduino vs. ESP32
&lt;/div&gt;

&lt;p&gt;Arduino is an open source hardware and software for electronics hobbyists. The board I have, the MEGA 2560, is Arduino-compatible. It was not manufactured by the Arduino company but it did use the same open source Arduino hardware design. This means I can use the Arduino IDE to program my board and utilize the great variety of Arduino libraries to integrate with external sensors and peripherals. The ESP32 hardware was not built by the same Arduino specification, but its software bridges the gap between the 2 hardware designs. This means we can program the ESP32 almost exactly the same as an Arduino board or an Arduino-compatible board, even though they are very different.&lt;/p&gt;

&lt;p&gt;Why choose ESP32 over an Arduino board? Well, Arduino is great for beginners because it’s simpler to use and easier to get started. However, the ESP32 is more powerful, smaller, cheaper and supports Bluetooth and WiFI, which the Arduino doesn’t. To make it easier to work with, the ESP32 chip comes integrated in a small dev-board that has features like micro-USB connector and voltage regulator, as well as easier access to all its pins (like an Arduino board has).&lt;/p&gt;

&lt;p&gt;I wanted my circuit to have a small footprint and I also had plans for using the WiFI feature, so I bought a couple of &lt;a href=&quot;https://www.amazon.com/gp/product/B07Q576VWZ/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&quot;&gt;ESP32 dev boards&lt;/a&gt;. I migrated my code to be compatible with ESP32, which basically was just updating to an ESP32-flavored Servo library.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/esp32-breadboard.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/esp32-breadboard.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Using an ESP32 to control the motor.
&lt;/div&gt;

&lt;p&gt;I also updated the circuit to power the motor and the ESP32 from a single battery, but more on that later.&lt;/p&gt;

&lt;p&gt;Now that I have the basic circuit for my shade controller, I can start testing it at my balcony. So far I tested my circuit on a breadboard, but I want something more reliable for my first prototype. I took out my soldering iron and built the circuit on a perfboard.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/soldering.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/soldering.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Soldering the components for the shade controller prototype.
&lt;/div&gt;

&lt;p&gt;To test it, I hung the shade controller circuit next to the motor with zip-ties and connected the motor to it. The battery is also there at the back, inside a ziplock bag. Nothing too fancy for a first prototype.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/prototype-combina-big.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/prototype-combina-big.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The first shade controller prototype.
&lt;/div&gt;

&lt;p&gt;I also added a 2-button remote, for a better accessibility when trying to operate the shade from my balcony chair.&lt;/p&gt;

&lt;p&gt;Now that everything is in place, I can test the first prototype:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/rQhZ0Q_558M&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Testing the prototype
&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;the-first-prototype&quot;&gt;The First Prototype&lt;/h2&gt;
&lt;p&gt;It was a real treat using my prototype for a couple of weeks! The shade controller worked well - it was responsive and the motor raised that shade like a champ! There was only one problem I found, but before diving into that - let’s first get to know the prototype a little better.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/diagram-prototype.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/diagram-prototype.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Diagram of the shade controller prototype circuit.
&lt;/div&gt;

&lt;p&gt;In the diagram on the right there’s the remote, with 2 buttons - up and down. Like we saw earlier in the basic circuit, each button is responsible to spin the motor in a different direction (i.e. clockwise/counter-clockwise). The motor receives the commands from the ESP32 using the cyan/yellow wire.&lt;/p&gt;

&lt;p&gt;The circuit is powered by a single 7.4v battery. The motor can run with 5v, but it’ll run faster and provide more torque with a higher voltage. According to its &lt;a href=&quot;https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/&quot;&gt;spec&lt;/a&gt;, the motor’s safest maximum voltage is 7.4v, which is why I picked a 7.4v battery for the job. The motor is connected directly to the battery, but the ESP32 is more sensitive and could be damaged by voltage too high. To be on the safe side, I added a &lt;a href=&quot;https://www.adafruit.com/product/1385&quot;&gt;DC step-down convertor&lt;/a&gt; (a.k.a Buck Converter or BEC - Battery Eliminator Circuit) that will convert the battery’s 7.4v to a steady 5v that will power the ESP32.&lt;/p&gt;

&lt;p&gt;The ESP32 chip itself is powered using 3.3v, but the dev-board it comes with has a built-in voltage regulator that can take a higher voltage and step it down to the needed 3.3v. That’s why it’s possible to power it via micro-USB, which provides 5v. When using an ESP32 dev-board, I can either connect a 3.3v power supply to the 3v3 pin, or I can connect 5v to the VIN pin which will first go through the built-in regulator. In the diagram, the DC step-down converter is connected to the battery on one side, where it receives 7.4v, and outputs 5v on the other side, which is connected to the VIN pin using the red wire.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/prototype-mounted-big.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/prototype-mounted-big.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The prototype with the battery powering it.
&lt;/div&gt;

&lt;p&gt;After using the prototype for some time, I noticed a problem - the &lt;strong&gt;battery life isn’t great&lt;/strong&gt;, a full battery lasted only 5 days.&lt;/p&gt;

&lt;p&gt;I got a pretty strong battery, a 6200mAh LiPo 7.4v battery, which is intended for Remote Control race cars. The motor draws between 200mA-3000mA while running, which the battery can handle as it’s designed for operating strong race car motors, but the majority of time the circuit is on standby. While on standby, the ESP32 is powered on and waiting for input from one of the buttons, which consumes about 50mA. The battery’s capacity is 6200mAh, meaning it can power a 50mA device for 124 hours (6200 / 50 = 124), which is a little over 5 days. This aligns with what I saw in practice and explains why the battery doesn’t last that long.&lt;/p&gt;

&lt;p&gt;I decided that the best solution is to simply ditch the battery. Why? I can’t see myself optimizing the battery consumption in a significant way. In addition, even if the battery will last a few weeks or a month, I still need to recharge it from time to time and risk having a dead battery when I need the shade. I don’t want to think about it, I want it to &lt;strong&gt;Just Work&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/circuit-barreljack.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/circuit-barreljack.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Connecting the circuit to a power adapter.
&lt;/div&gt;

&lt;p&gt;To support a power adapter, I added a &lt;a href=&quot;https://www.adafruit.com/product/373?gclid=Cj0KCQiArvX_BRCyARIsAKsnTxOEqPoVS5H8MBUYNwGpgpWzCSj7SRv3-nlrttM9-tQ5JrCaKR-fR9EaAu2mEALw_wcB&quot;&gt;barrel-jack port&lt;/a&gt; to my circuit and got a power adapter that supplies 7.5v. A pretty simple modification that means I don’t need to worry about sitting in the sun because I forgot to charge the battery in time.&lt;/p&gt;

&lt;p&gt;That was the first modification I made to the shade controller’s circuit, but it was just the beginning. In the next section, I’ll go over a new feature for my shade controller that would require bigger changes, including communicating with an external chip.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;supporting-automatic-stops-using-nfc&quot;&gt;Supporting Automatic Stops Using NFC&lt;/h2&gt;
&lt;p&gt;At this point of the project I got the minimal features for a fully working motorized shade, but I wanted to take this a step further. It takes a single button press to start lowering/raising the shade, but I still need to wait and press the button again in order to stop it.&lt;/p&gt;

&lt;p&gt;In most cases, I want to fully lower the shade or fully open it, so it makes sense the controller should know when to stop instead of waiting for me to do it manually. In addition, the shade I have installed in my balcony is larger than the area it needs to cover, so I need to set clear boundaries and prevent lowering it too low or raising it higher than necessary. Otherwise, the motor or the shade’s roller could be damaged, or worse - my downstairs neighbor will come over to complain about the shade dangling above his head. By having a reliable way to know the shade’s position, I can &lt;strong&gt;program the shade controller to stop automatically when reaching a specific position&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;There are several ways this can be accomplished. One way could be calibrating the controller with the time it takes to fully lower / raise the shade, then use this time to know how long the controller should spin the motor  before stopping it. This method is simple to implement but also unreliable, since the duration of lowering/raising the shade could skew over time and require frequent calibrations (e.g. strong winds could pull the shade and create resistance to the motor, which slows it down). Another option is to stick 2 magnets on the shade itself, one at the top and the other at the bottom, then use a &lt;a href=&quot;https://www.electronics-tutorials.ws/electromagnetism/hall-effect.html&quot;&gt;Hall effect sensor&lt;/a&gt; to detect these magnets and stop the motor from rolling the shade past these points. While this could work for simple use cases, it won’t prevent moving the shade past the boundaries the magnets created. For example, pressing “down” will lower the shade until the magnet is reached, but afterwards I can press “down” again to lower the shade further, past the lowest position allowed.&lt;/p&gt;

&lt;p&gt;I decided to try an interesting approach - using NFC to read position markers on the shade. The problem with the magnets approach is the fact they aren’t distinguishable, so the shade controller can’t know which magnet is caught by the Hall effect sensor. Using an NFC reader, the shade controller can read NFC tags placed on the shade in different places and decide whether to stop or continue raising/lowering the shade. The NFC tags are distinguishable by their ID, but they also allow writing data in them, which can be used for storing in each NFC tag the position it represents (e.g. “100% open”, “50% open”).&lt;/p&gt;

&lt;p&gt;The PN532 is the most popular NFC/RFID chip. Pretty much all the mobile phones who support NFC use this chip, or other chips from the same company, to do things like wireless payments or sharing data between nearby devices. When I started tinkering with NFC I got the &lt;a href=&quot;https://www.adafruit.com/product/364&quot;&gt;Adafruit PN532 breakout board&lt;/a&gt;, but I later got me a &lt;a href=&quot;https://www.amazon.com/gp/product/B01I1J17LC/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&quot;&gt;much smaller PN532 module&lt;/a&gt;, which works the same and will be easier to mount next to the shade controller.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/pn532.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/pn532.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The PN532 NFC Module.
&lt;/div&gt;

&lt;p&gt;There are several ways to connect peripherals to microcontrollers such as the ESP32 or Arduino. A peripheral can be a temperature sensor, LCD display or an external NFC module such as the PN532. Both Arduino and ESP32 support 3 common communication protocols - UART, SPI and I2C. Each protocol has its own benefits/drawbacks and picking which one to use really depends on the use case. SPI for example is much faster than I2C, which means it’s probably better for communicating with LCD displays or sensors that are sampled frequently, but with I2C we can connect a lot more external devices at once.&lt;/p&gt;

&lt;p&gt;I decided to connect the PN532 NFC module using I2C ( = inter-integrated circuit), because it’s a simpler connection but also for a reason I’ll cover a little later. Here’s a diagram showing how everything is connected:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/diagram-final.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/diagram-final.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Diagram of the main circuit connected to the PN532 NFC module.
&lt;/div&gt;

&lt;p&gt;There are 4 main wires necessary to connect the PN532 to the ESP32. First the power pins, VCC and GND, are connected using the blue and green wires to the 3v3 and GND pins on the ESP32. These will give the PN532 the 3v it needs to be powered. Next are the communication pins - for the I2C protocol we need to connect the SCL (clock line) and SDA (data line) pins to the equivalent pins on the microcontroller, which for the ESP32 are the D22 and D24 pins. In the diagram, these are represented by the white and purple wires. The orange wire is connected to the RESET pin, it’s optional and used to reset the device if needed. The yellow wire is connected to the IRQ pin, which will be discussed a bit later.&lt;/p&gt;

&lt;p&gt;There’s another connection we need to make for the I2C interface to work properly - the SCL and SDA pins also need to be connected to the power line (i.e. the 3v3 pin). This is necessary due to the open drain design of I2C - during data transfer the SDA/SCL lines are pulled low, which is a problem if other devices also try to communicate. To make I2C work, we need to keep these lines high by allowing power from the 3v3 pin to come through. But, the power can be too strong, which is why I had to connect 1.5kΩ resistors per line (I didn’t have a single 1.5kΩ resistor, so I just connected 3 that totaled in 1.5kΩ). There’s more discussion on this subject &lt;a href=&quot;https://forums.adafruit.com/viewtopic.php?f=19&amp;amp;t=88591&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Writing the code to interact with the NFC chip was pretty straightforward using the &lt;a href=&quot;https://github.com/adafruit/Adafruit-PN532&quot;&gt;Adafruit PN532 library&lt;/a&gt; - there’s an API method that starts listening for cards/tags, waits for a card to come close to the reader and reads its data when that happens. It looks simple, but there’s one major problem for my use-case - the command that starts listening for NFC cards &lt;strong&gt;is a blocking call&lt;/strong&gt;. This means my microcontroller, the ESP32, is essentially stuck waiting for NFC tags and can’t respond to other inputs, such as button presses. Here’s how this looks in the code:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cpp&quot; data-lang=&quot;cpp&quot;&gt;&lt;span class=&quot;c1&quot;&gt;// Pin definitions&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#define PN532_IRQ   (2)
#define PN532_RESET (4)
&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The DOWN button is pressed  &lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;btnDownCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnDownPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HIGH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;lowerShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// Wait for the NFC module to detect a card or a tag and read it.&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// This is a BLOCKING call.&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nfc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readPassiveTargetID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_MIFARE_ISO14443A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uidLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;success&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Get card ID and check if we need to stop the motor&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;For example, say I press the “down” button to lower the shade all the way down. While the motor is running, the ESP32 will activate the NFC module and wait for the NFC tag that signals the end of the shade. But, during this time the buttons aren’t responsive, which means there’s nothing I can do to stop lowering the shade before it reaches the end.&lt;/p&gt;

&lt;p&gt;I needed to find a way to make the microcontroller wait for NFC tags and &lt;strong&gt;still be responsive&lt;/strong&gt; to new commands, but there were no API methods to help with that. I saw others use a second ESP32 with the sole purpose of waiting for NFC cards, then communicating that to the first ESP32. That’s probably an overkill.. I decided to dig a little deeper into the NFC module’s spec sheet and find a better solution.&lt;/p&gt;

&lt;p&gt;According to the &lt;a href=&quot;https://www.nxp.com/docs/en/user-guide/141520.pdf&quot;&gt;PN532 user manual&lt;/a&gt;, we can use the chip’s IRQ pin in order to be notified asynchronously when a card is detected. The IRQ line is an optional connection we can make between the host controller (i.e. The ESP32) and the PN532 NFC module. When everything is connected and working, the PN532 will continuously send high voltage in the IRQ line, which essentially means we’ll get a binary 1 value whenever we read from that pin. When the PN532 has some response it wants to notify the host controller about (e.g. new NFC card/tag was detected) - it momentarily drives this line low ( = sends a binary 0 instead of 1 for a short amount of time).&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/pn532-sequence.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/pn532-sequence.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Sequence diagram showing the changes in the IRQ line when messages are sent and received between the ESP32 and PN532.
&lt;/div&gt;

&lt;p&gt;I connected the IRQ pin using the yellow wire in the diagram above, then updated my code to keep track of its value. The ability to use the IRQ line is the reason I chose the I2C protocol over SPI and UART - the Adafruit PN532 library supports the IRQ pin only when connected using I2C. However, this library didn’t include a non-blocking API to put the NFC module in a card detection state. So.. I just added new API methods myself! Here’s the updated code:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cpp&quot; data-lang=&quot;cpp&quot;&gt;&lt;span class=&quot;c1&quot;&gt;// API for the NFC module (PN532 chip)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Adafruit_PN532&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;nfc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_IRQ&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PN532_RESET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Supported NFC tags for each shade position (0%, 100% etc.)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CARDID_100_PERCENT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3952824665&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CARDID_0_PERCENT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;913822226&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// ..&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;pinMode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_IRQ&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;INPUT_PULLUP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Main function that loops as long as the controller is powered on&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;irqCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;digitalRead&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_IRQ&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// The DOWN button is pressed&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;btnDownCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;btnDownPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HIGH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;lowerShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// Puts the NFC module on a listening mode, a NON-BLOCKING call&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;nfc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;startPassiveTargetIDDetection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_MIFARE_ISO14443A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;listeningToNFC&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// If the NFC module is currently listening and we’re notified via the&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// IRQ line that a card was detected&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;listeningToNFC&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;irqCurr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;LOW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;irqPrev&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HIGH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Read the detected NFC tag&apos;s info&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;success&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nfc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readDetectedPassiveTargetID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uidLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;success&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// If the tag is valid, we&apos;ll read its ID&lt;/span&gt;
      &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cardId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getCardId&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uidLength&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cardId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CARDID_0_PERCENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;loweringShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// Found the &quot;0% open&quot; position tag while lowering the shade, &lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// we can stop because the shade is now fully closed&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;stopShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;listeningToNFC&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;raisingShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// Ignoring.. &lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cardId&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CARDID_100_PERCENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Similar implementation as above.&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// Stop raising the shade when the CARDID_100_PERCENT tag is detected, &lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// since the shade is now fully open.&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// If we didn&apos;t stop the motor and still need to listen to NFC tags&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;listeningToNFC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// Puts the NFC module on a listening mode again&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;nfc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;startPassiveTargetIDDetection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PN532_MIFARE_ISO14443A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Using the new API, I put the NFC module in a detection mode without blocking. During this time, if the IRQ value changes from HIGH to LOW - we know a card/tag was detected and it’s time to try reading it. Each NFC tag represents a shade position (e.g. 0% opened), which will help determine whether the motor needs to be stopped. We can attach more NFC tags to the shade and support more “shade presets”, like 50% or 25% open.&lt;/p&gt;

&lt;p&gt;The new API methods I added were merged into the PN532 library, now everyone can use them! There’s more info in the  &lt;a href=&quot;https://github.com/adafruit/Adafruit-PN532/pull/82&quot;&gt;pull-request I made on Github&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;With these changes, the up/down buttons are always responsive and the motor can be stopped either by pressing any of the buttons or when the NFC module is reading the appropriate NFC tag. The next video demonstrate this in my development environment, note how I use a different NFC tag to stop each spin direction:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/5fkpSk1L73I&quot; width=&quot;700&quot; height=&quot;480&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Testing the new NFC-based auto-stop mechanism
&lt;/div&gt;

&lt;p&gt;By the way, I could’ve used another Arduino feature called &lt;a href=&quot;https://learn.sparkfun.com/tutorials/processor-interrupts-with-arduino/all&quot;&gt;Interrupts&lt;/a&gt; to listen and react to changes in the IRQ line. While interrupts might seem as a more elegant implementation, they also cause disruptions to the execution flow which made the shade controller unreliable in some situations. With more effort, I might be able to get interrupts to work for me, but for now I chose the approach above for its flexibility and consistency.&lt;/p&gt;

&lt;p&gt;To test this NFC-based positioning system on my balcony shade, I need to put it close to the shade. For that, I got a plastic sheet &lt;a href=&quot;https://www.amazon.com/gp/product/B07MG8KTBX/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;th=1&quot;&gt;from Amazon&lt;/a&gt; to hold the NFC module on one side and supports the shade on the other. The shade rests on this plastic sheet as it moves up or down, allowing the NFC module to read the NFC tag that’s on the shade. In my first test, I attached an NFC tag on the shade using 2 of my daughter’s hair clips (I couldn’t find a stapler ¯\_(ツ)_/¯ ), and verified the shade controller stops the motor after detecting the NFC tag.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/pWtwcLzs28E&quot; width=&quot;700&quot; height=&quot;480&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Testing the shade controller auto-stops when reaching the end.
&lt;/div&gt;

&lt;p&gt;The NFC module can read tags that are up to 2 inches away, which is more than enough for my setup, as long as the reader is aligned with the NFC tag attached to the shade.&lt;/p&gt;

&lt;p&gt;Supporting automatic stops is a big step up for my shade controller. This new feature is making the shade controller more user friendly, robust and reliable. It’s also the foundation for the next major feature - voice command.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;hardware-facelift&quot;&gt;Hardware facelift&lt;/h2&gt;
&lt;p&gt;My shade controller is more automatic now, but how about making it look more professional? It’s a little too fragile (especially with children around), not weather resistant and looks kinda hacky. Before adding more software features, I decided to spend some time polishing the hardware side, making it more user friendly and sustainable.&lt;/p&gt;

&lt;p&gt;As a first step, I created a switch box to replace the remote I created earlier.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-btns.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-btns.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The old remote alongside the new waterproof switch box.
&lt;/div&gt;

&lt;p&gt;I drilled a couple of holes into a waterproof plastic box, where I installed the 2 waterproof buttons. I organized all the wires inside cable channels to protect them from the rain, and more importantly - my kids. Besides the robustness of the new switch box, it’s also a lot nicer than that hacky-looking remote.&lt;/p&gt;

&lt;p&gt;The main circuit used to sit inside its own box next to the motor, but that was before I added the NFC module. For a cleaner look, I put both of them in the same box and mounted it on that plastic sheet the shade is resting on. The NFC module is still positioned close enough to read NFC tags from the shade.&lt;/p&gt;

&lt;p&gt;While I was doing that, I figured I could reduce the footprint even further by trimming the plastic sheet, since I don’t really need it to be this big. I took a hacksaw and removed a significant chunk of it.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-main-before.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-main-before.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-spacer&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-main-after.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-main-after.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Before and after the changes to the main circuit housing.
&lt;/div&gt;

&lt;p&gt;Now I have the same shade controller, just better looking and with a much smaller footprint. This will be useful when I’ll need to explain all this to my wife&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-wall.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/improve-wall.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Now that looks a lot nicer!.
&lt;/div&gt;

&lt;p&gt;As one last improvement, I wanted to polish my circuit and create a PCB (Printed Circuit Board) to replace the perfboard I was using this far. Perfboards are a great way to quickly create and iterate on a prototype; they are less flexible than breadboards, but more sustainable and reliable. Now that I’m done with hardware changes, at least for the near future, a PCB will look a lot nicer and reduces the amount of loose wires that could be accidentally damaged.&lt;/p&gt;

&lt;p&gt;I never designed PCBs before, but it was simpler than I thought. I found &lt;a href=&quot;https://easyeda.com/&quot;&gt;EasyEDA&lt;/a&gt;, which is an online tool (and a Mac app) for designing PCBs and also ordering them directly from the tool. I started by creating the schematic design of my circuit:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/easyeda-schematic.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/easyeda-schematic.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The schematic design of the shade controller circuit.
&lt;/div&gt;

&lt;p&gt;The schematic is then used by EasyEDA to generate a PCB design. The design has all the components connected to each other, so I just moved components around to arrange them a little better, added labels and other small tweaks. Here’s what I came up with:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/easyeda-pcb.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/easyeda-pcb.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-spacer&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-empty.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-empty.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The PCB design in EasyEDA and the PCB I received.
&lt;/div&gt;

&lt;p&gt;The red and blue lines, in the PCB design, are the wires that connect the different components on the PCB and are generated based on the circuit’s schematic design. The reds are on the top layer of the PCB and the blues are on the bottom layer. This layer separation is necessary because the wires cannot cross each other and there isn’t always a way around to get the wire where it needs to go. Complex circuits might require moving components around in order to allow all the wires to be connected. There’s also an option to add images and text to the PCB, so I added a small logo and versioning information.&lt;/p&gt;

&lt;p&gt;EasyEDA has the option to directly order the PCB from &lt;a href=&quot;https://jlcpcb.com/&quot;&gt;JLCPCB&lt;/a&gt;, a Chinese company that manufactures PCBs. I picked the color I wanted (there are 6 options!) and paid the $2 the PCBs cost (+ $16 shipping to the US), then waited about a week until they arrived (min. of 5 PCBs per order). After some quality time with my soldering iron, I got me a slick new shade controller circuit:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-migration-front.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-migration-front.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-spacer&quot;&gt;&lt;/div&gt;
&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-migration-back.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/pcb-migration-back.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The old circuit compared to the PCB I designed.
&lt;/div&gt;

&lt;p&gt;Improving the look and feel of a product is not just a cosmetic change best saved for last, it can be an important step in the testing phase. With these improvements, I made the shade controller more accessible and user friendly. I feel more confident letting my kids use it now, which might expose usage problems I didn’t see before. Plus, it’s nice to clean up a bit before moving forward, it’s more fun to use a polished product and it helps seeing potential problems more clearly.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;supporting-voice-commands-via-google-assistant&quot;&gt;Supporting Voice Commands via Google Assistant&lt;/h2&gt;
&lt;p&gt;One of the reasons I switched very early on from an Arduino board to ESP32, is the WiFi support. This opens up new possibilities for my shade controller, the main one I was after is supporting Google Assistant and responding to voice commands. This is the change that will upgrade the shade controller to be a “smart shade controller” 😎.&lt;/p&gt;

&lt;p&gt;There are a couple of ways I could use the WiFi support for controlling my circuit remotely. With a web server running on the ESP32, I can connect clients directly to it and communicate over HTTP requests/responses. The web server can be accessible on the internet or by a direct connection (&lt;a href=&quot;https://randomnerdtutorials.com/esp32-client-server-wi-fi/&quot;&gt;example project&lt;/a&gt; that connects two ESP32s to each other without internet). While creating a web server on the ESP32 is a powerful feature, it has a few disadvantages such as a large overhead per message, speed and battery performance.&lt;/p&gt;

&lt;p&gt;Another way to communicate with an ESP32 via WiFi is by using MQTT, a lightweight messaging protocol. MQTT is more performant and lightweight than HTTP, it also provides a simpler two-way communication mechanism between the ESP32 and its clients. For these reasons, MQTT is the preferred method for communicating with IoT devices. To use MQTT we first need an MQTT broker, which is a fancy name for an MQTT server. Any message sent to the broker needs to include a “topic”, then only clients subscribed to that topic will receive that message.&lt;/p&gt;

&lt;p&gt;To set up MQTT for my shade controller, I can create an MQTT server in my local network (using &lt;a href=&quot;https://mosquitto.org/&quot;&gt;Mosquitto&lt;/a&gt;) or use a cloud service such as &lt;a href=&quot;https://blynk.io/&quot;&gt;Blynk&lt;/a&gt; or &lt;a href=&quot;https://learn.adafruit.com/welcome-to-adafruit-io&quot;&gt;Adafruit IO&lt;/a&gt;. My needs are very simple and the free tier of a cloud service should suffice. I picked Adafruit IO, set up my account and added a new feed (i.e. MQTT Topic) for my project, called “shade-open”. In the web console, I can create a dashboard and see the latest value sent to that feed.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/adafruitio-dashboard.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/adafruitio-dashboard.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	My shade controller dashboard on Adafruit IO.
&lt;/div&gt;

&lt;p&gt;To integrate and use Adafruit IO in the shade controller, I added their Arduino library into my project and made some changes:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cpp&quot; data-lang=&quot;cpp&quot;&gt;&lt;span class=&quot;cp&quot;&gt;#define IO_USERNAME  &quot;&amp;lt; AIO Username &amp;gt;&quot;
#define IO_KEY       &quot;&amp;lt; AIO KEY &amp;gt;&quot;
&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#define WIFI_SSID &quot;&amp;lt; Wifi SSID &amp;gt;&quot;
#define WIFI_PASS &quot;&amp;lt; Wifi password &amp;gt;&quot;
&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#include&lt;/span&gt; &lt;span class=&quot;cpf&quot;&gt;&quot;AdafruitIO_WiFi.h&quot;&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;AdafruitIO_WiFi&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IO_USERNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IO_KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIFI_SSID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIFI_PASS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Adafruit IO feed showing how much the shade should be open (either 0% or 100%)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;AdafruitIO_Feed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;balconyShade&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;feed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;shade-open&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;connectingInProgress&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// …&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Keep the connection alive, if already connected.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Times-out after 400ms to keep the microcontroller responsive.&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;aio_status_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioStatus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Connect to Adafruit IO, if connected then subscribe to the feed&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ioStatus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AIO_CONNECTED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;connectingInProgress&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;connectingInProgress&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;       
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ioStatus&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AIO_CONNECTED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;connectingInProgress&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;connectingInProgress&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	
    &lt;span class=&quot;c1&quot;&gt;// Subscribe to the &quot;shade-open&quot; feed&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;balconyShade&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;onMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;handleShadeLevelMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// This function is called when a new message is sent to the “shade-open” feed.&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handleShadeLevelMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AdafruitIO_Data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Got a new message with the percent the shade should be open &lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;percentOpen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atoi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
  
  &lt;span class=&quot;c1&quot;&gt;// If we&apos;re asked to open the shade to 100%, then raise it. Open to 0% means closing/lowering the shade.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;percentOpen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;raiseShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;percentOpen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;lowerShade&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The code connects to Adafruit IO cloud service and keeps the connection alive by calling the &lt;em&gt;io.run()&lt;/em&gt; method in the main loop function. When a new message is posted to the “shade-open” feed, the callback function is called and sends the appropriate command to the motor.&lt;/p&gt;

&lt;p&gt;I implemented the Adafruit IO integration a little bit differently than the examples they provide. In their &lt;a href=&quot;https://github.com/adafruit/Adafruit_IO_Arduino/blob/master/examples/adafruitio_00_publish/adafruitio_00_publish.ino&quot;&gt;examples&lt;/a&gt;, the microcontroller is blocked from doing anything until it’s connected to the cloud. I didn’t like the fact I won’t be able to use the physical buttons to control the shade while the controller is trying to connect to the cloud (do I really need to sit in the sun if my network is down or very slow?!). The code I wrote is more responsive and allows the controller to work offline, while still trying to regain connectivity. I tested the integration worked by sending MQTT messages from the Adafruit IO web console and verified they were received by the ESP32.&lt;/p&gt;

&lt;p&gt;Now let’s move to the final part - controlling the shade from Google Assistant. This was probably the easiest part of this entire project. The shade controller can already take commands from the web using MQTT, so if we want Google Assistant to control it - we need to connect the two.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ifttt.com/adafruit&quot;&gt;IFTTT&lt;/a&gt; (If-this-then-that) is a great tool for connecting different web services and products to each other. It supports integrations with Google Assistance and  Adafruit IO, so all I needed to do is authenticate to both services and create rules (called “Applets”) to communicate between them. For my use case, I created an applet that reacts to a Google Assistant command to open or close the shade and sends data to a specific feed on my Adafruit IO account.&lt;/p&gt;

&lt;div class=&quot;outer-grid&quot;&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt1.png&quot;&gt;
			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt1.png&quot; /&gt; 
		&lt;/a&gt;
	&lt;/div&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt2.png&quot;&gt;
			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt2.png&quot; /&gt; 
		&lt;/a&gt;
	&lt;/div&gt;
	&lt;div class=&quot;inner-grid&quot;&gt;
		&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt3.png&quot;&gt;
			&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/ifttt3.png&quot; /&gt; 
		&lt;/a&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	My IFTTT configuration for opening the shade from Google Assistant.
&lt;/div&gt;

&lt;p&gt;When I say “OK Google, Open the balcony shade”, Google Assistant will send the value “100” to the “shade-open” feed. The shade controller receives this message through Adafruit IO and raises the shade until it reaches the NFC tag that signals the shade is 100% open.&lt;/p&gt;

&lt;p&gt;Here’s everything in action:&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/lLbN8Sc2E9Q&quot; width=&quot;540&quot; height=&quot;960&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;video-caption&quot;&gt;
	Testing voice command from Google Assistant.
&lt;/div&gt;

&lt;p&gt;Nice!&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;final-thoughts-and-tips&quot;&gt;Final thoughts and tips&lt;/h2&gt;
&lt;p&gt;I spent weeks working on this project, I love how it turned out and what I gained from it. Operating my balcony shade is more convenient for sure, but that’s not even the most useful outcome of this project. For years, I’ve used software to improve different aspects of my life, but now I’ve gained the experience and confidence to build custom electrical products and unlocked a new type of solutions I can improve my life with. The potential is huge and I’m excited to see what I will do with it next.&lt;/p&gt;

&lt;p&gt;I learned a lot of new things in this project, not all about electronics, and I think the best way to learn is to simply get your hands dirty and dig deeper as problems arise. I figured it’s worth mentioning a few quick tips from my experience working on this project, some I learned the hard way:&lt;/p&gt;

&lt;p&gt;While I knew I wanted to add NFC support from the beginning, I went with an &lt;strong&gt;iterative approach&lt;/strong&gt; - started with a simple circuit and made changes in steps. This might take a bit longer than completing the vision in one go, but it helps seeing and fixing problems early, before they become bigger or harder to pinpoint. The battery life problem is a good example for something I didn’t put too much thought into, but I was able to fix it before getting into the more complex NFC issues that came later.&lt;/p&gt;

&lt;p&gt;I also recommend having a simple way to use the circuit in a &lt;strong&gt;development environment&lt;/strong&gt;. After I mounted the motor and the switch box, I was still able to take the main circuit to my desk and debug problems using a simpler motor and remote. I also added a flag in the code for disabling the NFC, so I won’t have to connect an NFC module in my development environment unless I need to. This was really convenient and greatly improved my development process.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Breadboards can be unreliable&lt;/strong&gt;, take that into account when testing your circuits. I spent hours on a problem with the NFC module, which turned out to be a result of jumper cables that got momentarily disconnected and caused weird state issues. If the circuit is not expected to change much, consider doing it on a perfboard.&lt;/p&gt;

&lt;p&gt;Soldering is an important skill and having the right tools can make a big difference. My circuits looked a lot more professional and less frustrating to make after I got me a &lt;a href=&quot;https://www.amazon.com/gp/product/B07LGLWGZ5/ref=ppx_yo_dt_b_search_asin_image?ie=UTF8&amp;amp;psc=1&quot;&gt;helping hand&lt;/a&gt; - a &lt;strong&gt;soldering tool&lt;/strong&gt; with arms for holding the circuit and other components while soldering. It also includes a strong light and magnifying glass.&lt;/p&gt;

&lt;p&gt;One more soldering tip - some components are just hard to solder straight (I’m looking at you headers!). I learned I can use &lt;a href=&quot;https://www.amazon.com/dp/B074R75LH1/ref=cm_sw_em_r_mt_dp_Ogp7FbP40B436?_encoding=UTF8&amp;amp;psc=1&quot;&gt;sticky mounting tabs&lt;/a&gt; to &lt;strong&gt;steadily position the components while soldering them&lt;/strong&gt;. Really useful and made my circuits look more professional.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/tips-mounting-tabs.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/tips-mounting-tabs.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	Soldering headers with mounting tabs.
&lt;/div&gt;

&lt;p&gt;There was a lot of drilling in this project, and I learned a lot about types of surfaces and drills, but I think the highlight is getting to know the &lt;a href=&quot;https://www.amazon.com/dp/B07NKXLTCB/ref=cm_sw_em_r_mt_dp_R6xWFbNZJNW16&quot;&gt;Step Drill&lt;/a&gt; for &lt;strong&gt;drilling perfect round holes&lt;/strong&gt; in plastic boxes. I found out about this awesome drill bit after spending way too much time drilling holes in the switch box, for inserting the 2 up/down buttons. The Step drill can make the same holes in seconds, and perfectly round too. I think it’s a must for projects like this.&lt;/p&gt;

&lt;div class=&quot;media-center&quot;&gt;
	&lt;a href=&quot;/assets/images/automating-balcony-shade-with-nfc/step-drill.jpg&quot;&gt;
		&lt;img src=&quot;/assets/images/automating-balcony-shade-with-nfc/step-drill.jpg&quot; /&gt; 
	&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;image-caption&quot;&gt;
	The Step drill bit and the clean hole I made with it.
&lt;/div&gt;

&lt;p&gt;That’s all! The source code and designs are available in the Resources section below, in addition to the list of components I used and other useful resources for this and similar projects.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;resources&quot;&gt;Resources&lt;/h2&gt;
&lt;p&gt;The source files are available on Github, including the Fritzing diagrams, PCB schematic and Gerber files.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/Udinic/smartShadeController&quot;&gt;https://github.com/Udinic/smartShadeController&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The full parts list:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;ESP32 Dev-board [&lt;a href=&quot;https://www.amazon.com/gp/product/B07Q576VWZ/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&amp;amp;fpw=alm&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;PN532 NFC module [&lt;a href=&quot;https://www.amazon.com/HiLetgo-Communication-Arduino-Raspberry-Android/dp/B01I1J17LC/ref=sxts_sxwds-bia-wc-drs1_0?cv_ct_cx=pn532&amp;amp;dchild=1&amp;amp;keywords=pn532&amp;amp;pd_rd_i=B01I1J17LC&amp;amp;pd_rd_r=625c7ef6-462a-4aa4-9587-8b7ff990436d&amp;amp;pd_rd_w=O7fj7&amp;amp;pd_rd_wg=jacP8&amp;amp;pf_rd_p=c33e4373-edb9-47f9-a7e6-5d3d6a7a4ad0&amp;amp;pf_rd_r=AMD8MZN7FS1WPQTJGH86&amp;amp;psc=1&amp;amp;qid=1607317072&amp;amp;sr=1-1-5e875a02-02b1-4426-9916-8a5c26cd5a14&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Servo motor [&lt;a href=&quot;https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/&quot;&gt;ServoCity&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Waterproof plastic box [&lt;a href=&quot;https://www.amazon.com/gp/product/B07C6W5MN4/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Bracket for connecting the motor to the crank [&lt;a href=&quot;https://www.servocity.com/lightweight-linear-actuator-mounting-bracket/&quot;&gt;ServoCity&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Structural components for mounting [&lt;a href=&quot;https://www.servocity.com/structure/&quot;&gt;ServoCity&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Servo extension cords [&lt;a href=&quot;https://www.amazon.com/dp/B07BQMS1JV/ref=cm_sw_r_tw_dp_h5BZFbQ86XA19?_x_encoding=UTF8&amp;amp;psc=1&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Barrel jack connector [&lt;a href=&quot;https://www.adafruit.com/product/373?gclid=CjwKCAiAn7L-BRBbEiwAl9UtkJhH8XqXyK7Sm-5B5ml_mp9IU7h-2Blk8scO0Ig0RNnKCLC5b1yfmxoCOhMQAvD_BwE&quot;&gt;Adafruit&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;2x 330Ω, 220Ω and1kΩ resistors [&lt;a href=&quot;https://www.amazon.com/Elegoo-Values-Resistor-Assortment-Compliant/dp/B072BL2VX1/ref=sr_1_3?crid=3CIQCTPZLFIGO&amp;amp;dchild=1&amp;amp;keywords=resistors&amp;amp;qid=1607317189&amp;amp;s=industrial&amp;amp;sprefix=resis%2Cindustrial%2C154&amp;amp;sr=1-3&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Buck Converter [&lt;a href=&quot;https://www.adafruit.com/product/1385&quot;&gt;Adafruit&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Headers [&lt;a href=&quot;https://www.amazon.com/Header-Lystaii-Pin-Connector-Electronic/dp/B06ZZN8L9S/ref=sr_1_2?crid=2YEXP032IUD8O&amp;amp;dchild=1&amp;amp;keywords=headers+electronics&amp;amp;qid=1607317221&amp;amp;sprefix=headers+elec%2Caps%2C165&amp;amp;sr=8-2&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Terminal block [&lt;a href=&quot;https://www.amazon.com/dp/B01MT4LC0F/ref=cm_sw_em_r_mt_dp_xEBZFbGJ0RPX3&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Waterproof buttons [&lt;a href=&quot;https://www.amazon.com/gp/product/B079HR5Q4R/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&amp;amp;fpw=alm&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Switch box [&lt;a href=&quot;https://www.amazon.com/gp/product/B07C6S4Y7D/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&amp;amp;fpw=alm&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Acrylic sheet [&lt;a href=&quot;https://www.amazon.com/gp/product/B07MG8KTBX/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&amp;amp;fpw=alm&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Power adapter [&lt;a href=&quot;https://www.amazon.com/gp/product/B01MT5WVCG/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;amp;psc=1&amp;amp;fpw=alm&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
  &lt;li&gt;Perfboard [&lt;a href=&quot;https://www.amazon.com/dp/B01KJMN7OY/ref=cm_sw_r_tw_dp_x_AQBZFb7THRB8W&quot;&gt;Amazon&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;A few useful places that helped me along the way:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.servocity.com/&quot;&gt;ServoCity&lt;/a&gt; - Where I bought the motor and a lot of other structural components that helped me mount the motor. Great site to look for interesting parts for different types of projects.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.adafruit.com/&quot;&gt;Adafruit&lt;/a&gt; - I got many of my components from Adafruit, they open-sourced great Arduino libraries and operate helpful forums. A must have for any hobbyist.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.sparkfun.com/&quot;&gt;SparkFun&lt;/a&gt; - I liked their &lt;a href=&quot;https://learn.sparkfun.com/tutorials/where-do-i-start#starter-tutorials&quot;&gt;“where do I start” tutorials&lt;/a&gt;, which are a great refresher for the basics. SparkFun also makes and sells components, much like Adafruit.&lt;/p&gt;

</description>
				<pubDate>Wed, 13 Jan 2021 04:30:00 -0500</pubDate>
				<link>/2021/01/13/automating-balcony-shade-with-nfc/</link>
				<guid isPermaLink="true">/2021/01/13/automating-balcony-shade-with-nfc/</guid>
			</item>
		
			<item>
				<title>Introducing "Grabag" - a simple way to watch TV.</title>
				<description>&lt;p&gt;&lt;em&gt;UPDATE (09/2020): While I discontinued working on Grabag, this might still worth the read as the idea still lives on. To this day, I keep seeing this type of product being requested by people.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;About a year ago, I cut the cords and canceled my cable subscription. I watch a lot of TV shows, but I stream everything anyway, and avoiding all the commercial breaks is a bliss.&lt;/p&gt;

&lt;p&gt;But there was one thing I found hard to do after that - finding something random to watch.&lt;/p&gt;

&lt;p&gt;I often like to watch an episode of something while eating dinner, or put in the background while I’m working on my computer. When I had cable, I would just put on a channel that plays South Park, Family Guy or some other light TV show episode. But without cable, I’d find myself open each streaming app and browse the episodes for the shows I like. In many occasions, I didn’t even care what should I watch, but the process still took me a few minutes each time (see &lt;a href=&quot;http://www.ted.com/talks/barry_schwartz_on_the_paradox_of_choice&quot;&gt;The Paradox of Choice&lt;/a&gt;). That gave me the idea for an app that liberates me from making that decision over and over again, and that’s how Grabag was born.&lt;/p&gt;

&lt;p&gt;Grabag (&lt;a href=&quot;http://www.merriam-webster.com/dictionary/grab%20bag&quot;&gt;Grab Bag&lt;/a&gt;) is very simple - pick the shows you like, and the app will randomly select an episode for you, along with a short description and a direct link to open it on an app that streams it (e.g. Hulu, HBO Go, Google Play). Here’s the main screen, where all the selected shows are listed:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/introducing-grabag/main_screen.png&quot;&gt;&lt;img src=&quot;/assets/images/introducing-grabag/main_screen_sm.png&quot; alt=&quot;img&quot; class=&quot;center-image&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Clicking on each banner will pick a random episode for that show, and picking a random episode from all the shows is done using the bottom-right “random” button. Here’s an example for an episode:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/introducing-grabag/episode-familyguy.png&quot;&gt;&lt;img src=&quot;/assets/images/introducing-grabag/episode-familyguy_sm.png&quot; alt=&quot;img&quot; class=&quot;center-image&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Don’t like that one? No worries, just scroll right and get more.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/introducing-grabag/vid_episodes_scroll.gif&quot;&gt;&lt;img src=&quot;/assets/images/introducing-grabag/vid_episodes_scroll.gif&quot; alt=&quot;img&quot; class=&quot;center-image&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To watch it, click on the streaming service button. That’s a direct link to play the episode on that app. You can later cast it to your TV, if you’d like.&lt;/p&gt;

&lt;p&gt;There’s no sign-in requirement and the app is free.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h2 id=&quot;beta-testing&quot;&gt;Beta testing&lt;/h2&gt;

&lt;p&gt;I’ve been working on this app for a while now, and I’ve used it myself many times. I decided to make a beta release, getting users’ feedback, and later release it to the public. If you’re interested in joining the beta, just use this link to become a tester and download the app:&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p style=&quot;font-size: 150%; text-align: center;&quot;&gt;&lt;a href=&quot;https://play.google.com/apps/testing/com.udinic.grabag&quot;&gt;BECOME A TESTER&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;Note: it takes a minute to be added to the beta testing program, so if you can’t download the app - try again in a minute or two.&lt;/p&gt;

&lt;p&gt;Your feedback is very important to me, so I made it very simple for you. You can send your feedback in 2 ways:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;From the app, press the feedback button and write a direct email to me.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/introducing-grabag/feedback2.png&quot;&gt;&lt;img src=&quot;/assets/images/introducing-grabag/feedback2.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Using the Google+ &lt;a href=&quot;https://plus.google.com/communities/113984360926167804714&quot;&gt;Grabag Beta Testers community&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;The app currently supports only “Hulu” and “Google Play Movies”, but other streaming services will be added real soon.&lt;/p&gt;

&lt;p&gt;I hope this app will make your TV shows watching experience much simpler and relaxed, as it did for me. If you have an idea how to make it even better - don’t hesitate to contact me.&lt;/p&gt;

&lt;p&gt;Oh yeah - and tell your friends!&lt;/p&gt;
</description>
				<pubDate>Thu, 29 Oct 2015 06:00:00 -0400</pubDate>
				<link>/2015/10/29/introducing-grabag/</link>
				<guid isPermaLink="true">/2015/10/29/introducing-grabag/</guid>
			</item>
		
			<item>
				<title>Speed up your app (DroidCon Talk)</title>
				<description>&lt;p&gt;A few weeks ago, I gave a talk about Android Performance Optimization, at Droidcon NYC.&lt;/p&gt;

&lt;p&gt;I invested a lot of time in this presentation, since I wanted to show real examples for performance issues, and how to identify them with the available tools. I had to cut down about a half of my slides because I didn’t have enough time to show everything. In this post, I’ll summarize everything I was talking about, and show examples I didn’t have time to go over.&lt;/p&gt;

&lt;p&gt;The talk was recorded and you can watch it here:&lt;/p&gt;
&lt;div class=&quot;embed-container&quot;&gt;
  &lt;iframe src=&quot;https://www.youtube.com/embed/v3DlGOQAIbw&quot; width=&quot;700&quot; height=&quot;480&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;&quot;&gt;
  &lt;/iframe&gt;
&lt;/div&gt;

&lt;p&gt;The slides are also available:&lt;/p&gt;

&lt;div style=&quot;width: 70%&quot;&gt;
&lt;script async=&quot;&quot; class=&quot;speakerdeck-embed&quot; data-id=&quot;596740dd42254419935aa604d098f2d3&quot; data-ratio=&quot;1.77777777777778&quot; src=&quot;//speakerdeck.com/assets/embed.js&quot;&gt;&lt;/script&gt;
&lt;/div&gt;

&lt;p&gt;Now, Let’s go over some of the important things I was talking about, hopefully I can give a deeper explanation for everything, starting with the basic rules I follow when I work on optimizations:&lt;/p&gt;

&lt;!--break--&gt;

&lt;h2 id=&quot;my-rules&quot;&gt;My Rules&lt;/h2&gt;

&lt;p&gt;Everytime I approach a performance problem, or looking for performance problems, I follow these rules:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Always Measure&lt;/strong&gt; - Optimizing with your eyes is never a good idea. After looking at the same animation for a few times, you’ll start imagining it’s running faster. Numbers don’t lie. Use the tools we’ll go over soon, and measure how your app performs a few times before and after you make your change.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Use slow devices&lt;/strong&gt; - If you really want to expose all the weak spots, slower devices will help you more. Newer and stronger devices might not get too excited about performance issues you may have, but not all your users use the latest and greatest.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Trade-offs&lt;/strong&gt; - Performance optimization is all about trade-offs. You optimize one thing - it comes on the expense of another. In many cases, that other thing can be your time spent finding and fixing it, but it can also be the quality of your bitmaps or the amount of data you should store in a specific data structure. Prepare yourself to make sacrifices.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;systrace&quot;&gt;Systrace&lt;/h2&gt;

&lt;p&gt;Systrace is one of the greatest tools that you probably don’t use. That’s because developers weren’t sure what to do with the information it provides.&lt;/p&gt;

&lt;p&gt;Systrace shows us an overview of what’s currently running on the phone. This tool reminds us that the phone we hold in our hands, is actually is a powerful computer that can do many things at the same time. In one of the latest SDK tools updates, this tool was improved with generated insights from the data, helping us to find problems. Let’s see how a trace file looks like:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-overview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-overview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can generate a trace file using the Android Device Monitor tool, or using command line. You can find more info &lt;a href=&quot;http://developer.android.com/tools/help/systrace.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On the video, I explained the different sections. The interesting parts are the Alerts and the Frames, showing you insights the tool has generated based on the data it collected. Let’s look at a trace I took, and select one of the alerts on the top:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-alert.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-alert.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The alert states that there was a long View#draw() call. We get a description, links to the documentation and even video links for relevant talks on that subject. Looking at the Frames row below, we see an indication for every frame that was rendered, and it’s colored green, yellow and red to indicate a performance issue while rendering that frame. Let’s select one of these red frames:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-frame.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-frame.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On the bottom, we’ll see all the relevant alerts for that frame. We see there were 3 of those, one of them is the one we saw earlier. Let’s zoom-in that frame and expand the “Inflation during ListView recycling” alert on the bottom:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-frame-zoomin.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-frame-zoomin.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We see the amount of time it took for this part, 32ms, which puts the frame’s rendering time way over the 16ms boundary, a requirement to achieve 60fps. There’s more timing information for each of the items in the ListView for that frame - about 6ms was spent per item, and we have 5 of these. The description helps us understand the problem, and even provides a solution. On the graph at the top, we see a visualization of everything, we can even zoom-in on the “inflate” slice to see what views took longer to inflate in the layout.&lt;/p&gt;

&lt;p&gt;Another example of a slow rendered frame:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-2-frame.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-2-frame.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After selecting a frame, we can press the ‘m’ key to highlight it and see how long that part took. Looking at the top, we see it took over 19ms to render that frame. Expanding the only alert for that frame, shows us there was a “Scheduling delay”.&lt;/p&gt;

&lt;p&gt;A Scheduling delay means that the thread, processing that specific slice, was not scheduled on the CPU for a long time. Therefore, it took longer for this thread to complete. Selecting the longest slice in the frame shows more specific information:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-2-slice.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-2-slice.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;Wall duration&lt;/strong&gt; is the time passed from the moment that slice started until finished. It’s called “Wall duration”, because it’s like looking at a wall clock since the thread has started.&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;CPU duration&lt;/strong&gt; is the actual time the CPU spent processing that slice.&lt;/p&gt;

&lt;p&gt;It’s noticeable that there’s a wide difference between these durations. While it took 18ms to complete this slice, the CPU spent only 4ms working on it. That’s a little strange, so now will be a good time to look up and see what the CPU was doing this entire time:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/systrace-2-cpu.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/systrace-2-cpu.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All 4 cores were pretty busy.&lt;/p&gt;

&lt;p&gt;Selecting one the threads shows us where it was originated from, an app called &lt;strong&gt;com.udinic.keepbusyapp&lt;/strong&gt;. In this case, a different app was causing the CPU to work harder, denying it from dedicating some energy to our app.&lt;/p&gt;

&lt;p&gt;While this specific scenario is usually temporary, since other apps don’t often hog the CPU in the background (..right?), these threads could come from a different process on your app, or even from the main process. Since Systrace is an overview tool, there’s a limit to how deep we can get. To find what’s keeping our CPU busy in our app, we’ll use another tool called Traceview.&lt;/p&gt;

&lt;h2 id=&quot;traceview&quot;&gt;Traceview&lt;/h2&gt;

&lt;p&gt;Traceview is a profiling tool, showing how long it took for each method to run. Let’s see how a trace file looks like:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/traceview-overview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/traceview-overview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The tool can be started from the Android Device Monitor and from code. More information is available &lt;a href=&quot;http://developer.android.com/tools/debugging/debugging-tracing.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let’s go over the different columns:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Name&lt;/strong&gt; - The name of the method, along with a color to identify it on the graph above.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Inclusive CPU Time&lt;/strong&gt; - The time it took the CPU to process that method and its children (i.e. all the methods it called).&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Exclusive CPU Time&lt;/strong&gt; - The time it took the CPU to process that method alone.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Inclusive / Exclusive Real Time&lt;/strong&gt; - The time that has passed from the moment the method started until completed. Same as “Wall duration” on Systrace.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Calls+Recursion&lt;/strong&gt; - How many times this method was called, and the amount of recursive calls too.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;CPU/Real time per Call&lt;/strong&gt; - The CPU/Real time it took per call to this method, on average. The other time fields are showing the aggregated time of all calls to a method.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I opened an app that had hard time scrolling smoothly. I started the trace, scrolled a little and stopped the trace. I found the getView() method and expanded it, here’s what I saw:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/traceview-getview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/traceview-getview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This method was called 12 times, the CPU spent ~3ms for each call, but the real time it took for each call to finish is 162ms! Definitely a problem..&lt;/p&gt;

&lt;p&gt;Looking at the children of this method, we can see how the overall time splits between the different methods. The Thread.join() took ~98% of the inclusive real time. This method is used when we want to wait for another thread to finish. One of the other children is Thread.start(), which gets me to assume that the getView() method is starting a thread and waiting for it to finish.&lt;/p&gt;

&lt;p&gt;But where is that thread?&lt;/p&gt;

&lt;p&gt;We can’t see what that thread was doing as a child of getView(), since getView() is not doing that work directly . To look for it, I searched for a Thread.run() method, which is the method being invoked when spawning a new thread. I followed it until I reached the culprit:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/traceview-thread.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/traceview-thread.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I found that the BgService.doWork() method took ~14ms per call, and we have about 40 of these! There’s a chance each getView() calls it more than once, and explains why each getView() call takes such a long time. This method was keeping the CPU busy for a long time. Looking at the Exclusive CPU time, we see that it used 80% of the CPU time in the entire trace! Sorting by the Exclusive CPU time is also a great way to find the busiest methods in the trace, it’s possible they contribute to the performance issue you’re experiencing.&lt;/p&gt;

&lt;p&gt;Following time critical methods, such as getView(), View#onDraw() and others, will help us find the reasons why our app is acting slow. But sometimes, there’s something else keeping the CPU busy, taking away precious CPU cycles, that could be spent on rendering our UI more smoothly. The Garbage Collector is running occasionally, clearing out unused objects, and usually don’t have a strong impact on the app running in the foreground. If the GC is running too often, it could slow down our app, and it’s possible that we are to blame..&lt;/p&gt;

&lt;h2 id=&quot;memory-profiling&quot;&gt;Memory Profiling&lt;/h2&gt;

&lt;p&gt;Android Studio was improved a lot lately, with more and more tools to help us find and analyze performace issues. The Memory tab on the Android window, will show us the amount of data being allocated on the heap over time. That’s how it looks like:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/mem-graph.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/mem-graph.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Wherever we see little drops in the graph, a GC event has occurred, removing unused objects and freeing space on the heap.&lt;/p&gt;

&lt;p&gt;There are 2 tools available on the left side of the graph: Heap dump and Allocation Tracker.&lt;/p&gt;

&lt;h3 id=&quot;heap-dump&quot;&gt;Heap dump&lt;/h3&gt;

&lt;p&gt;In order to investigate what’s currently allocated in our heap, we can use the heap dump button on the left. This will take a snapshot of what’s currently allocated in the heap, and will show it in a special report screen inside Android Studio:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/heap-overview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/heap-overview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On the left, we see a histogram of the instances in the heap, grouped by their class name. For each one, there’s the amount of objects allocated, the size of these instances (Shallow size) and the size these objects are retaining in memory. The latter tells us how much memory could be free if these instances will get freed. This view gives us an important glimpse to our app’s memory footprint, helping us identify large data structures and objects relations. This information could help us build more efficient data structures, untying object connections to reduce the retained memory and ultimately - reducing the memory footprint as much as possible.&lt;/p&gt;

&lt;p&gt;Looking at the histogram, we see that the MemoryActivity has 39 instances, which seems odd for an activity. Picking one of its instances on the right, will reveal all the references for this instance in the Reference Tree at the bottom.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/heap-reftree.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/heap-reftree.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One of them is part of an array inside an on object of ListenersManager. Looking at the other instances of the activity will reveal that all of them are retained by this object. This explains why the only object of this class is retaining so much memory:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/heap-retained.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/heap-retained.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This situations is notoriously called “Memory Leak”, since the activities were clearly destroyed and that unused memory cannot be garbage collected due to that reference. We can avoid situations like this, by making sure our objects are not being referenced by other objects that outlive it. In this situation, the ListenersManager does not need to keep that reference after the activity was destroyed. A solution will be to remove that reference when the activity is about to be destroyed, in the onDestory() callback method.&lt;/p&gt;

&lt;p&gt;Memory leaks and other large objects are occupying large space in the heap, reducing the available memory and causing many GC events to try and free more space. These GC events will keep the CPU busy, causing performance degradation of our app. If the amount of available memory isn’t sufficient for the app, and the heap cannot grow any bigger, a more dramatic result will happen - OutOfMemoryException, leading to an app crash.&lt;/p&gt;

&lt;p&gt;A more advanced tool is the Eclipse Memory Analyzer Tool (Eclipse MAT):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/eclipse-mat.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/eclipse-mat.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This tool can do everything Android Studio can, and also identify potential memory leaks and provide more advanced instances searching, such as searching for all the Bitmap instances that are larger than 2 MB, or all the &lt;a href=&quot;http://kohlerm.blogspot.com/2009/04/analyzing-memory-usage-off-your-android.html&quot;&gt;empty Rect objects&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Another great tool is a library called &lt;a href=&quot;https://corner.squareup.com/2015/05/leak-canary.html&quot;&gt;LeakCanary&lt;/a&gt;, which tracks your objects and make sure they aren’t leaked. If so - you’ll get a notification to let you know what happened and where.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/leakcanary.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/leakcanary.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;allocation-tracker&quot;&gt;Allocation Tracker&lt;/h3&gt;

&lt;p&gt;The Allocation Tracker is started/stopped using one of the other buttons to the left of the memory graph. It will generate a report of all the instances being allocated at that period of time, grouped by class:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/alloc-class.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/alloc-class.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;or by method:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/alloc-method.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/alloc-method.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There’s also a nice visualization, showing us the biggest allocated instances.&lt;/p&gt;

&lt;p&gt;Using this information, we can find time-critical methods that allocate too much memory and could trigger many GC events. We can also find many short-living instances for the same class, where we can consider using an &lt;a href=&quot;https://en.wikipedia.org/wiki/Object_pool_pattern&quot;&gt;Object pool&lt;/a&gt; to reduce the amount of allocations.&lt;/p&gt;

&lt;h3 id=&quot;general-memory-tips&quot;&gt;General memory tips&lt;/h3&gt;

&lt;p&gt;Here are some quick tips/guidelines I use when I’m writing code:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Enums&lt;/strong&gt; are already a hot subject when discussing performance. There’s a &lt;a href=&quot;https://youtu.be/Hzs6OBcvNQE&quot;&gt;Video&lt;/a&gt; about it, showing the size enums spend, and a &lt;a href=&quot;https://plus.google.com/+JakeWharton/posts/bTtjuFia5wm&quot;&gt;discussion&lt;/a&gt; about that video and some potential misleading information it has. Do enums take more space than regular constants? Definitely. Is that bad? not necessarily. If you’re writing a library and need a strong type safety, that could justify using it over other solutions, such as &lt;a href=&quot;https://developer.android.com/reference/android/support/annotation/IntDef.html&quot;&gt;@IntDef&lt;/a&gt;. If you just have a bunch of constants that can be grouped together - it may not be wise to use an Enum for that purpose. As always, there’s a trade-off that you need to consider when making this decision.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Auto-boxing&lt;/strong&gt; - auto-boxing is the automatic conversion from primitive types to their object representation (e.g. int -&amp;gt; Integer). Every time a primitive type is being “boxed” to an object representation, a new object is created (shocking, I know). If we have many of these - the GC will run more frequently. It’s easy not to notice the amount of auto-boxing that happens, because it’s automatically done for us when assigning a primitive to an object. As a solution, try to be consistent with these types. If you use primitives throughout your app, try to avoid getting them auto-boxed for no real reason. You can use the memory profiling tools to find many objects representing a primitive type. You can also use Traceview and look for Integer.valueOf(), Long.valueOf() etc.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;HashMap vs ArrayMap / Sparse*Array&lt;/strong&gt; - In a related manner to the auto-boxing issue, using HashMaps requires us to use objects as keys. If we use the primitive “int” type in the app, and it’s getting auto-boxed to Integer when interacting with a HashMap, we could probably just use SparseIntArray. In case we still need keys that are objects, we can use the ArrayMap class. It’s very similar to HashMap, but it &lt;a href=&quot;https://www.youtube.com/watch?v=ORgucLTtTDI&quot;&gt;works differently under the hood&lt;/a&gt;, making it more memory efficient, with a cost of being slower. Both alternatives have a smaller memory footprint than HashMap, but the time it takes to retrieve the items or allocate more space is a little higher than HashMap. Unless you have 1000+ or entries, there’s almost no difference in the runtime, making them a viable option for your mapping purposes.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Context Awareness&lt;/strong&gt; - As seen earlier, it’s relatively easy to leak your activities’ memory. You may wouldn’t be surprised to learn that activities are the most common memory leak in Android(!). They are also very expensive to leak, since they hold all the view hierarchy of their UI, which could take a lot of space on its own. Many operations in the platform require a Context object, and an Activity is usually what you send. Make sure to understand what happens to that Activity. If a reference to it is cached, and that object lives longer than your Activity, without clearing that reference, you got yourself a memory leak.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Avoid non-static inner classes&lt;/strong&gt; - When creating a non-static inner class, and instantiating it, you create an implicit reference to the outer class. If the inner class’s instance is needed for longer period of time than the outer class, the outer class will still be retained in memory, even though it’s not needed anymore. For example, creating a non-static class that extends AsyncTask inside an Activity class, then proceeding to start that async task and while it’s running - killing the activity. That async task will keep that activity alive for as long as it runs. The solution - just don’t do it, declare a &lt;strong&gt;static&lt;/strong&gt; inner class if needed.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;gpu-profiling&quot;&gt;GPU Profiling&lt;/h2&gt;

&lt;p&gt;A new addition to Android Studio 1.4, is a tool to profile GPU rendering.&lt;/p&gt;

&lt;p&gt;Under the Android window, go to the GPU tab, and you’ll see a graph showing the time it took to render each frame on your screen:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/gpu-overview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/gpu-overview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Each bar on the graph represents one frame being rendered, and the colors represents the different phases in the process:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Draw (blue)&lt;/strong&gt; - Represents the View#onDraw() method. That part builds/updates the DisplayList objects, being converted later to OpenGL commands the GPU can understand. High values can be due to complex views, requiring more time to build their display lists, or many views being invalidated at a short period of time.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Prepare (purple)&lt;/strong&gt; - In Lollipop, another thread was added to help the UI Thread render the UI faster. That thread is called RenderThread. It’s responsible for converting the display lists to OpenGL commands and sending them to the GPU. While that is happening, the UI thread can move on to start processing the next frame. The time it takes for the UI thread to pass all the resources to the RenderThread, is being in this step. If we have a lot of resources to pass on, such as many/heavy display lists, this step could take longer.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Process (red)&lt;/strong&gt; - Executing the display lists to create OpenGL commands. This step could take longer if there are many/complex display lists to execute, because many views needs to be redrawn. A view can be redrawn due to an invalidation or if it’s revealed by moving an overlapping view.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Execute (yellow)&lt;/strong&gt; - Sending the OpenGL commands to the GPU. That part is a blocking call, since the CPU is sending a buffer with these commands to the GPU, expecting to get back a clean buffer for the next frame. The amount of buffers is limited, and if the GPU is too busy - the CPU will find itself waiting for one to get freed first. Therefore, if we see high values for this step, it probably means the GPU was busy drawing our UI, which could be too complex to be drawn at a shorter time.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In Marshmallow, more colors were added to indicate more steps, such as Measure/Layout, input handling and others:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/gpu-colors-marsh.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/gpu-colors-marsh.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;EDIT 09/29/2015: John Reck, a framework engineer in Google, &lt;a href=&quot;https://plus.google.com/+AlexLockwood/posts/Yj23fFY7Eon&quot;&gt;has added&lt;/a&gt; this information about some of the new colors:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The exact definition of “animation” is everything that’s registered with Choreographer as CALLBACK_ANIMATION. This includes Choreographer#postFrameCallback and View#postOnAnimation which are what’s used by view.animate(), ObjectAnimator, Transitions, etc… And yup, it’s the same thing systrace labels as “animation”.&lt;/p&gt;

  &lt;p&gt;“misc” is the delay between the vsync’s timestamp and the current timestamp when it was received. If you’ve ever seen logs from Choreographer about “Missed vsync by &lt;em&gt;blabla&lt;/em&gt; ms skipping &lt;em&gt;blabla&lt;/em&gt; frames”, that now shows up as “misc”. This is the difference between INTENDED_VSYNC and VSYNC in the framestats dump (https://developer.android.com/preview/testing/performance.html#timing-info)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;But before using this feature, you need to enable GPU rendering first, from the developer options:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/gpu-settings2.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/gpu-settings2.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This will allow the tool to use ADB commands to get all the information it needs, and so are we (!), using:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;adb shell dumpsys gfxinfo &amp;lt;PACKAGE_NAME&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;we can receive all that data and create the graph ourselves. The command will print other useful information, such as the number of views in the hierarchy, size of all the display lists and more. In Marshmallow, we’ll get even more stats.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/gpu-adb.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/gpu-adb.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If we have automated UI testing for our app, we can make our build server run this command after certain interactions (list scroll, heavy animation etc.) and see if there’s a change in the values, such as “Janky Frames”, over time. This could help identify a performance degrade after some commits were pushed, allowing us time to address the problem before the app hits production. We can get even more precise rendering information, when using the “framestats” keyword, as explained &lt;a href=&quot;https://developer.android.com/preview/testing/performance.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But that’s not the only way to see this graph!&lt;/p&gt;

&lt;p&gt;As seen in the “Profile GPU Rendering” developer option, there’s also an option to see the graph “On screen as bars”. Enabling that, will show the graph for each window on our screen, along with a green line to indicate the 16ms threshold.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/gpu-onscreen.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/gpu-onscreen.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On the right example, we can see that some frames crossed the green line, which means it took longer than 16ms to render them. Since the blue color seems to be dominating these bars, we understand there were many and/or complex views to draw. In that scenario, I scrolled over the newsfeed list, which supports different types of views. Some of the views are being invalidated and some are also more complex to render than others. It’s possible that the reason some frames cross that threshold, is because there was a complex view to render at the time.&lt;/p&gt;

&lt;h2 id=&quot;hierarchy-viewer&quot;&gt;Hierarchy Viewer&lt;/h2&gt;

&lt;p&gt;I love this tool, and it saddens me that many aren’t using it at all!&lt;/p&gt;

&lt;p&gt;Using the Hierarchy Viewer, we can get performance stats, see the complete view hierarchy on the screen and have access to all the views’ properties. You can also dump the theme’s data, see all the values used for each style attribute, but that’s available only when running Hierarchy Viewer as a standalone, not from Android Monitor. I use this tool when I design my layouts and when I want to optimize them.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/hierview-overview.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/hierview-overview.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;At the center, we see a tree representing the view hierarchy. The view hierarchy can be wide, but if it’s too deep (~10 levels), this may cost us with expensive layout/measurement phases. Every time a view is being measured, in View#onMeasure(), or when it’s positioning all its child views, in View#onLayout(), these commands propagate to the child views, which do the same. Some layouts will do each step twice, such as RelativeLayout and some LinearLayout configurations, and if they are nested - the number of passes increases exponentially.&lt;/p&gt;

&lt;p&gt;At the bottom-right, we see a “blueprint” of our layout, marking where each view is positioned. We can select a view here, or in the tree, and see all its properties on the left. When designing a layout, I sometimes not sure why a certain view ended up where it is. Using this tool, I can track it on the tree, select it and see where it is in the preview window. I can design interesting animations by looking the final measurements of the views on the screen, and use that information to move things around accurately. I can find lost views that were overlapped by other views unintentionally, and much more.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/hierview-colors.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/hierview-colors.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For each view we have the time it took to measure/layout/draw it and all its child views. Colors indicate how this view performed in compare to the other views in the tree, a great way to find the weakest link. Since we also see a preview of that view, we can go over the tree and follow the steps created it, finding redundant steps that we could remove. One of those things, that has a great impact on performance, is called Overdraw.&lt;/p&gt;

&lt;h2 id=&quot;overdraw&quot;&gt;Overdraw&lt;/h2&gt;

&lt;p&gt;As seen in the GPU Profiling section - the Execute phase, represented by the yellow color on the graph, could take longer to complete if the GPU has many things to draw on the screen, increasing the time it takes to draw each frame. Overdraw occurs when we draw something on top of something else, say a yellow button on a red background. The GPU needs to draw the red background first and later the yellow button on top of that, making overdraws inevitable. If we have too many layers of overdraw, it will cause the GPU to work harder and be farther from the 16ms goal.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/overdraw-gif.gif&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/overdraw-gif.gif&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Using the “Debug GPU Overdraw” setting in the Developer Options, all overdraws will be colored to indicate the severity of the overdraw at that area. Having 1x/2x overdraw is fine, even some small light-red areas are not bad, but if we see too much red on the screen - we might have a problem. Let’s see couple of examples:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/overdraw-examples.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/overdraw-examples.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On the left example, there’s a list drawn in green, which usually is fine, but there’s an overlay on the top that makes it red, and that’s starting to become a problem. On the right example, the entire list is light red. In both cases, there’s an opaque list that has 2x/3x overdraw. These overdraws could happen if there’s a full screen background color to the window holding your Activity/Fragment, the list view and each list view item. We can solve such problem by setting a background color for only one of them.&lt;/p&gt;

&lt;p&gt;Note: the default theme declares a full screen background color to your window. If you have an activity with an opaque layout that covers the entire screen, you could remove the window background to remove one layer of overdraw. This can be done in the theme or in code, by calling getWindow().setBackgroundDrawable(null) inside onCreate().&lt;/p&gt;

&lt;p&gt;Using Hierarchy Viewer, you can export all the layers of your hierarchy to a PSD file, to open in Photoshop. Investigating the different layers in Photoshop, will reveal all the overdraws in the layout. Use this information to remove redundant overdraws, and don’t settle on the green, go for the blue!&lt;/p&gt;

&lt;h2 id=&quot;alpha&quot;&gt;Alpha&lt;/h2&gt;

&lt;p&gt;Using transparency could have performance implications, and to understand why - let’s see what happens when setting an alpha value to a view. Consider the following layout:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/alpha-before.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/alpha-before.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We see a layout that holds 3 ImageViews that overlap each other. In the direct/naive implementation, setting an alpha, using setAlpha(), will cause the command to propagate to all the child views, the ImageViews in this case. Later, these ImageViews will be drawn with that alpha value to the frame buffer. The result:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/alpha-direct.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/alpha-direct.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That’s not what we want to see.&lt;/p&gt;

&lt;p&gt;Since each ImageView was drawn with an alpha value, all the overlapping images blend together. Luckily, the OS has a solution to this problem. The layout will be copied to an off-screen buffer, the alpha will be applied to that buffer as a whole and the result will be copied to the frame buffer. The result:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/alpha-complex.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/alpha-complex.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But..we payed a price for that.&lt;/p&gt;

&lt;p&gt;Drawing the view on an off-screen buffer, before drawing it on the frame buffer, is virtually adding another &lt;strong&gt;undetected&lt;/strong&gt; overdraw layer. The OS doesn’t know when exactly to use this approach or the direct approach shown earlier, so the default is to always do the complex one. But there are still ways to set alpha and avoid the complexity the off-screen buffer adds:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;TextViews - Use &lt;strong&gt;setTextColor()&lt;/strong&gt; instead of setAlpha(). Using the alpha channel for the text color, will cause the text to be drawn directly using it.&lt;/li&gt;
  &lt;li&gt;ImageView - Use &lt;strong&gt;setImageAlpha()&lt;/strong&gt; instead of setAlpha(). Same reason as for the TextView.&lt;/li&gt;
  &lt;li&gt;Custom Views - If your custom view doesn’t support overlapping views, this complex behavior is irrelevant to us. There’s no way our child views will blend together, as seen in the example above. By overriding the &lt;strong&gt;hasOverlappingRendering()&lt;/strong&gt; method to return false, we’re signaling the OS to take the direct/naive path with our view. There’s also an option to manually handle what happens when setting an alpha, by overriding the &lt;strong&gt;onSetAlpha()&lt;/strong&gt; method to return true.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;hardware-acceleration&quot;&gt;Hardware Acceleration&lt;/h2&gt;

&lt;p&gt;When Hardware Acceleration was introduced in Honeycomb, we got a &lt;a href=&quot;http://developer.android.com/guide/topics/graphics/hardware-accel.html&quot;&gt;new drawing model&lt;/a&gt; to render our app to the screen. It introduced the DisplayList structures, which records the view’s drawing commands for faster rendering. But there’s another great feature that developers sometimes miss or don’t use properly - The View layers.&lt;/p&gt;

&lt;p&gt;Using a View layer, we can render the View into an off-screen buffer (as seen earlier, when applying an Alpha channel) and manipulate it as we like. This feature is mainly great for animations, because we can animate complex Views quicker. Without layers, animating a View will invalidate it after changing the animated property (e.g. x coordinate, scale, alpha value etc.). For complex views, this invalidation propagates to all the child views, and they in turn will redraw themselves, a costly operation. Using a View layer, backed by Hardware, a texture is created in the GPU for our view. There are several operations we can apply on that texture without invalidating it, such as x/y position, rotation, alpha and more. All that means, that we can animate a complex view on our screen without invalidating it at all during the animation! This will make the animation much smoother. Here’s a code example how to do this:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;c1&quot;&gt;// Using the Object animator&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setLayerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LAYER_TYPE_HARDWARE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nc&quot;&gt;ObjectAnimator&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;objectAnimator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ObjectAnimator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;ofFloat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;TRANSLATION_X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;objectAnimator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AnimatorListenerAdapter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onAnimationEnd&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Animator&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;animation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setLayerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LAYER_TYPE_NONE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;});&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;objectAnimator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Using the Property animator&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;view&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;animate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;translationX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;withLayer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Simple, right?&lt;/p&gt;

&lt;p&gt;Yes, but there are a few things to remember when using hardware layers:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Clean up&lt;/strong&gt; after your view - hardware layers consume space on a limited memory component, your GPU. Try and use them only for the time they needed, like an animation, and clean them up afterwards. In the ObjectAnimator example above, I applied a listener to remove the layer when the animation ends. On the Property animator example, I used the withLayers() method, which automatically creates the layer at the beginning and removes it when the animation ends.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If you &lt;strong&gt;change your View&lt;/strong&gt; after applying a hardware layer, it will invalidate the hardware layer and will render the view to that off-screen buffer all over again. That will happen when changing a property that’s not optimized for hardware layers (for now, these are optimized: rotation, scale, x/y, translation, pivot and alpha). For example, if you’re animating a View, backed by hardware layer, by moving it across the screen while updating the View’s background color as it moves, it will result with constant updating of the hardware layer. Updating the hardware layer has an overhead that could make using it not worthwhile&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For the second problem, there’s a way to visualize these hardware layer updates. Using the Developer Options, we can enable the “Show hardware layers updates”.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/hwl-devoptions2.png&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/hwl-devoptions2.png&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When enabled, the View is being flashed with a green color as it updates its hardware layer. I used it a while ago, when I had a ViewPager that didn’t scroll as smooth as I expected. After enabling this developer option, I went ahead and scroll the ViewPager, and this is what I saw:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/speed-up-your-app/hwl-calproblem.gif&quot;&gt;&lt;img src=&quot;/assets/images/speed-up-your-app/hwl-calproblem.gif&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Both pages were green for the entire scroll!&lt;/p&gt;

&lt;p&gt;That means that there’s a hardware layer created for them, and the pages are also invalidated as we scroll the ViewPager. I did update the pages as I scroll them, using a parallax effect on the background and gradually animating the items in the page. What I didn’t do, is create a hardware layer for the ViewPager’s pages. After reading the ViewPager’s source code, I found that when the user starts scrolling, a hardware layer is created for both pages and removed after the scrolling stops.&lt;/p&gt;

&lt;p&gt;While it makes complete sense to create hardware layers to the pages as we scroll, it was bad for me. Usually, these pages aren’t changing as we scroll the ViewPager, and since they can be pretty complex - hardware layers help rendering them much quicker. In the app I was working on, that wasn’t the case and I had to remove these hardware layer, using a &lt;a href=&quot;http://blog.udinic.com/2013/09/16/viewpager-and-hardware-acceleration&quot;&gt;small hack that I wrote&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Hardware layers are not a silver bullet. It’s important to understand how they work and use them properly, or you can find yourself with a bigger problem.&lt;/p&gt;

&lt;h2 id=&quot;diy&quot;&gt;DIY&lt;/h2&gt;

&lt;p&gt;In preparation for all the examples I showed here, I wrote a lot of code to simulate these situations. You can find everything in this &lt;a href=&quot;https://github.com/Udinic/PerformanceDemo&quot;&gt;Github repository&lt;/a&gt;, and also on &lt;a href=&quot;https://play.google.com/store/apps/details?id=com.udinic.perfdemo&quot;&gt;Google Play&lt;/a&gt;. I splitted different scenarios to different activities, and tried to document them as much as possible to help understand what kind of problems you can find using that Activity. Read the Activities’ javadoc, open the tools and play with app.&lt;/p&gt;

&lt;h2 id=&quot;more-info&quot;&gt;More info&lt;/h2&gt;

&lt;p&gt;As the Android OS evolves, so are the ways you can optimize your apps. New tools are being introduced with the Android SDK, and new features are added to the OS (such as the hardware layers). It’s important to stay up-to-date and examine the trade-offs before choosing to change something.&lt;/p&gt;

&lt;p&gt;There’s a great YouTube playlist, called &lt;a href=&quot;https://www.youtube.com/playlist?list=PLOU2XLYxmsIKEOXh5TwZEv89aofHzNCiu&quot;&gt;Android Performance Patterns&lt;/a&gt;, with many short videos from Google, explaining different subjects related to performance. You can find comparisons between different data structures (HashMap vs ArrayMap), Bitmaps optimizations and even how to optimize your network requests. I highly recommend watching all of them.&lt;/p&gt;

&lt;p&gt;Join the &lt;a href=&quot;https://plus.google.com/communities/116342551728637785407&quot;&gt;Android Performance Patterns Google+ community&lt;/a&gt; and talk about performance with others, including Googlers, to share ideas, articles and questions.&lt;/p&gt;

&lt;p&gt;More interesting links:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Learn how the &lt;a href=&quot;http://source.android.com/devices/graphics/architecture.html&quot;&gt;Graphics Architecture in Android&lt;/a&gt; works. It has everything you need to know about how Android renders your UI, explaining the different system components, such as SurfaceFlinger, and how they all talk to each other. It’s long, but worth it.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;A &lt;a href=&quot;https://www.youtube.com/watch?v=Q8m9sHdyXnE&quot;&gt;talk from Google IO 2012&lt;/a&gt;, showing how the drawing model works and how/why we get a jank when our UI renders.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;An &lt;a href=&quot;https://www.parleys.com/tutorial/part-2-android-performance-workshop&quot;&gt;Android Performance Workshop talk&lt;/a&gt;, from Devoxx 2013, showing some of the optimizations that were made in Android 4.4 to the drawing model, and demoing the different tools to optimize performance (Systrace, Overdraw etc.).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Great post about &lt;a href=&quot;https://medium.com/google-developers/the-truth-about-preventative-optimizations-ccebadfd3eb5&quot;&gt;Preventative Optimizations&lt;/a&gt;, and why they are different than Premature Optimizations. Many developers don’t optimize parts of their code, because they think the impact is not noticeable. One thing to keep in mind, is that everything add up to become a &lt;a href=&quot;https://plus.google.com/105051985738280261832/posts/YDykw2hstUu&quot;&gt;bigger problem&lt;/a&gt;. If you have an opportunity to optimize a small part, that may seem negligible, don’t rule it out.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=_CruQY55HOk&quot;&gt;Memory managment in Android&lt;/a&gt; - an old video from Google IO 2011, that’s still relevant. It showcases how Android manages the memory of our apps, and how to use tools such as Eclipse MAT to find problems.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;a href=&quot;http://www.curious-creature.com/docs/android-performance-case-study-1.html&quot;&gt;Case study&lt;/a&gt; done by Google Engineer, Romain Guy, to optimize a popular twitter client. In this case study, Romain shows how he found performance issues in the app and what he recommends on doing to fix them. There’s a &lt;a href=&quot;http://www.curious-creature.com/2015/03/25/android-performance-case-study-follow-up/&quot;&gt;follow-up post&lt;/a&gt;, showing other issues for the same app, after it was redesigned.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I hope you now have enough information, and more confidence, to start optimizing your apps today!&lt;/p&gt;

&lt;p&gt;Start a trace, or enable some of the relevant Developer Options, and just go from there. You’re welcome to share some of the things you’ve found in the comments or in the Android Performance Patterns Google+ community.&lt;/p&gt;
</description>
				<pubDate>Tue, 15 Sep 2015 10:30:10 -0400</pubDate>
				<link>/2015/09/15/speed-up-your-app/</link>
				<guid isPermaLink="true">/2015/09/15/speed-up-your-app/</guid>
			</item>
		
			<item>
				<title>Yet another blog setup post</title>
				<description>&lt;p&gt;After several years of using Wordpress.com for my blog - I decided I need a change.&lt;/p&gt;

&lt;p&gt;I wanted to move to something different for a while, but kept postponing it because that would require some time and effort to do. In this post, I’ll summarize my transition experience and elaborate on problems I had and how I solved them. Hopefully, this information will help others with similar ambitions.&lt;/p&gt;

&lt;!--break--&gt;

&lt;h2 id=&quot;first-thing-first---why-leaving&quot;&gt;First thing first - why leaving?&lt;/h2&gt;

&lt;p&gt;Wordpress.com is a good solution if you want a hassle free blog. You get a nice WYSIWYG editor, free hosting and variety of themes. However, after using it for a while, I came across many problems that got me to hate it and get annoyed by. These are my main reasons:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Editor&lt;/strong&gt;. I’m a power user. While WYSIWYG editor is great for many people, I prefer to have more control on the way my posts are formatted. Going back and forth between the HTML view and the Visual view, caused some html tags to disappear for some reason, especially code snippets. In 2 other occasions, my &lt;strong&gt;entire post disappeared&lt;/strong&gt;! I was able to recover an old version for one of them, but the second one I had to rewrite (and if you’ve seen some of my posts, you’d know it’s a lot of work). For a while, I used &lt;a href=&quot;http://windows.microsoft.com/en-us/windows-live/writer-basics&quot;&gt;Windows Live Writer&lt;/a&gt; for Windows, which is..OK, but it’s far from perfect. I couldn’t find a good editor for Mac.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Syntax Highlighting&lt;/strong&gt;. I use a lot of code snippets in my posts. I used a wordpress plugin for syntax highlighting, but I never really liked it. There’s no option to theme it and it gave me hard time when posting code with the “&amp;lt;”/”&amp;gt;” characters. I couldn’t find any convenient alternatives.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Design&lt;/strong&gt;. When I first created my blog, I spent a good hour to browse the themes wordpress has to offer. I liked a few, but I wasn’t free to customize them (at least without paying for it).&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I had a few other reasons, such as using Google Analytics for stats and &lt;a href=&quot;https://disqus.com/&quot;&gt;Disqus&lt;/a&gt; for comments, but these are minor in compare to the others.&lt;/p&gt;

&lt;h2 id=&quot;where-should-i-go-now&quot;&gt;Where should I go now?&lt;/h2&gt;

&lt;p&gt;It is decided!&lt;/p&gt;

&lt;p&gt;I’m leaving Wordpress, but where? After doing some research, I wanted to try Octopress.&lt;/p&gt;

&lt;p&gt;I was told Octopress is the “blogging framework for hackers”, which sounds like something I want. I installed it and played around with it. The main problem I had with Octopress is the customization. My web design experience is not great, and Octopress uses Sass stylesheets, instead of the traditional CSS. While Sass is more powerful than using CSS directly, my customizations are relatively simple and I didn’t want to invest time learning Sass at this time. Plus, I wanted to gain more experience with CSS, and designing my own blog is a great opportunity for that. I decided to pass on Octopress and try its base framework - Jekyll.&lt;/p&gt;

&lt;p&gt;Since Octopress was created from Jekyll, they are very similar. Here are some of their common characteristics:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;They both generate a static website, instead of generating content on the fly. Static websites have better performance and easier to host (no need to maintain a database). Generating the static website is done by a single Ruby command.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;The posts are written in Markdown, a more convenient way to write posts than pure html.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Start a local server to show a preview of the site. It will auto-generate pages as they are edited.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Since everything is stored in plain files, Git can be used for reliable versioning.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I chose Jekyll because I can have all these features and also use CSS to design it. Now I can start a local server and work offline, whether to write a post or to design it. In fact, I’m writing these lines &lt;a href=&quot;https://plus.google.com/+UdiCohen/posts/VGJGiGYgY8U&quot;&gt;from a plane!&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I need to design how my new blog is going to look like, and since my CSS skills are relatively low, I decided to find a theme that I like and modify it.&lt;/p&gt;

&lt;h2 id=&quot;design&quot;&gt;Design&lt;/h2&gt;

&lt;p&gt;After doing some field work to find interesting themes, which wasn’t as easy as I assumed it’ll be, I found the &lt;a href=&quot;https://github.com/dbtek/dbyll&quot;&gt;dbyll&lt;/a&gt; theme. It has the structure that I was looking for, and it looked nice, so I decided to use it, but not before I’ll change a few things.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/yet-another-blog-setup-post/css.gif&quot;&gt;&lt;img src=&quot;/assets/images/yet-another-blog-setup-post/css.gif&quot; alt=&quot;img&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Ah…CSS.&lt;/p&gt;

&lt;p&gt;The theme I modified uses &lt;a href=&quot;http://getbootstrap.com/&quot;&gt;Bootstrap&lt;/a&gt;, and it overrides Bootstrap’s defined styles in its own CSS file. I made my changes on that file, and added some styles of my own to override other Bootstrap styles. I’m not a web developer/designer, but I didn’t run into any problem that Google and the &lt;a href=&quot;https://developer.chrome.com/devtools&quot;&gt;Chrome DevTools&lt;/a&gt; couldn’t help me solve. For developers who don’t have much experience with these great tools, here are some tips that I found useful while working with:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;There are a few ways for a property to get overridden, and it’s not always clear where the final value is coming from. Using the “Computed” tab, you can see all the final properties’ values and their origin. Example:
&lt;!-- [![img](/assets/images/yet-another-blog-setup-post/devtools-computed.png)]() --&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Using Cmd+Shift+C (or Ctrl+Shift+C if !MacOS) you can select a section in your page, and see in the “Styles” tab all the styles that are used for this specific section. You can edit and add new styles, just to see how things will look like, without updating any CSS files. Just don’t forget to copy your changes to the CSS file afterwards.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Using the “Device mode” button, you can change the layout to see how the page will render in other devices, such as Tablets or Phones. This is a great way to test your design’s responsiveness for different screen sizes.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Intuition plays a large rule in design. The color palette, the button’s design and other design elements, were things I just thought will fit together (with a &lt;strong&gt;ton&lt;/strong&gt; of trial and error). I asked some friends, some are designers and some are just people with good taste, to give me their opinions and I got a great feedback to take into account. The result is what you see in front of you. I still have some tweaks I want to do, but that’s for later..&lt;/p&gt;

&lt;h2 id=&quot;migrating-the-old-posts-from-wordpress&quot;&gt;Migrating the old posts from Wordpress&lt;/h2&gt;

&lt;p&gt;All my old posts are hosted in Wordpress.com, and I plan to leave no post behind. The migration process was a little bumpy, and required some manual work, but it didn’t take too long.&lt;/p&gt;

&lt;h3 id=&quot;importexport&quot;&gt;Import/Export&lt;/h3&gt;

&lt;p&gt;Luckily, Wordpress allows exporting the site to an XML file, which then can be converted to whatever we want. I researched a few scripts, some converts the content to pure html, some to markdown. I wanted to use only markdown in my posts, so I decided to go with that approach.&lt;/p&gt;

&lt;p&gt;I found a few automated solutions, such as the one described on this &lt;a href=&quot;http://vitobotta.com/how-to-migrate-from-wordpress-to-jekyll/index.html#converting-to-markdown&quot;&gt;elaborate post&lt;/a&gt;, to convert my posts to markdown. After trying a few, I picked &lt;a href=&quot;https://github.com/thomasf/exitwp&quot;&gt;Exitwp&lt;/a&gt;, which stated that the images will also be converted. In practice, only a few images were downloaded and I had to manually download the others. For every post, a folder was created in the “assets” folder to hold all the relevant images. The conversion script is also having some &lt;a href=&quot;https://github.com/thomasf/exitwp/issues/42&quot;&gt;escaping issues&lt;/a&gt;, that got me running a find&amp;amp;replace on all my posts to fix the image links. I don’t have tons of images on my posts, so it didn’t require a lot of manual work. Other than that, I had to fix a few formatting issues after the conversion. I manually went over all of my posts, some had misplaced line breakers or italic/bold styles applied where shouldn’t, not a big deal but required some time to inspect and fix.&lt;/p&gt;

&lt;p&gt;My new blog uses Disqus to manage the comments, where in the old blog I used the built-in comments system. Fortunately, there’s an export/import option when moving from Wordpress, using the same XML we exported earlier, and importing it into your Disqus account. I had to edit the wordpress exported xml file, since all the comments are linked to their respective posts by the url. I wanted to use my domain’s url, so I needed to do a find&amp;amp;replace here too, to change all the URLs from &lt;em&gt;udinic.wordpress.com&lt;/em&gt; to &lt;em&gt;blog.udinic.com&lt;/em&gt;. After importing the modified xml to my Disqus account - I had all my comments restored.&lt;/p&gt;

&lt;h3 id=&quot;mastering-my-own-domain&quot;&gt;Mastering my own domain&lt;/h3&gt;

&lt;p&gt;Speaking of domain issues, I also had a domain problem that almost aborted my entire migration process, but then I discovered there’s a very simple solution to it.&lt;/p&gt;

&lt;p&gt;When I set up my wordpress blog, I didn’t set up my domain mapping properly. I only redirected my domain to go to the main page, but didn’t set up a CNAME record to map internal links, such as posts. I was lazy and didn’t think ahead (which is really not typical of me). As a result, all the links to my posts are in the format of &lt;em&gt;http://udinic.wordpress.com/year/month/day/post-title.html&lt;/em&gt;, and these are the links in many Stackoverflow answers and other blogs that reference my posts. I didn’t want to lose these links since, obviously, they bring a lot of traffic to my blog. I was mad at myself at first for not thinking about it when I initially set up my blog, but then I found out that wordpress provides a &lt;a href=&quot;https://en.support.wordpress.com/site-redirect/&quot;&gt;solution&lt;/a&gt; to this exact problem! I need to pay a yearly subscription fee for this service, of course, but there’s always a price you pay when you don’t think ahead (remember kids..).&lt;/p&gt;

&lt;p&gt;Phew..that process was a bit longer than I wished, but thanks to all the scripts I used, written by great people with similar needs, this process was less excruciating. Now that I had all my old posts imported with a fresh design - I can go ahead and publish this thing.&lt;/p&gt;

&lt;p&gt;But where?&lt;/p&gt;

&lt;h2 id=&quot;publish&quot;&gt;Publish&lt;/h2&gt;

&lt;p&gt;Jekyll can easily be run on your local environment, and thus can run on any machine with the right dependencies installed. One option is to get a server and set everything myself, or to just use a 3rd party service.&lt;/p&gt;

&lt;p&gt;My first option was &lt;a href=&quot;https://pages.github.com/&quot;&gt;GitHub Pages&lt;/a&gt;. It’s easy, free and you can set up your own domain. The problem with that - your blog’s content is a repository as any other under your account. If you want it to be private - you must pay Github a monthly fee. Since I wanted privacy, but wanted to minimize my blog’s cost, I looked for other options.&lt;/p&gt;

&lt;p&gt;I found &lt;a href=&quot;https://www.heroku.com/&quot;&gt;Heroku&lt;/a&gt; to be a good solution for my needs. There’s a free tier, it’s reliable and it’s easy to use. Deploying new changes is done using a simple “git push” command. It has some limitations, such as shutting down if it hasn’t been used for 30 mins. It comes up relatively quick after that, so it’s not a big deal for me now. I really wanted to mess around with Heroku for some time now, and this was a great excuse to try it. I think that, at some point, I’ll want to increase the blog’s uptime and will find a solution for that.&lt;/p&gt;

&lt;p&gt;I also noticed that BitBucket can support hosting Jekyll, and it also provides free private repositories. The instructions I found are a little cumbersome in compare to the others, so I decided to pass on that option for now.&lt;/p&gt;

&lt;h2 id=&quot;finally&quot;&gt;Finally&lt;/h2&gt;

&lt;p&gt;I have a new blog, with a new design. Now for the real challenge - writing more.&lt;/p&gt;

</description>
				<pubDate>Thu, 04 Jun 2015 09:30:10 -0400</pubDate>
				<link>/2015/06/04/yet-another-blog-setup-post/</link>
				<guid isPermaLink="true">/2015/06/04/yet-another-blog-setup-post/</guid>
			</item>
		
			<item>
				<title>AOSP Part 3: Developing Efficiently</title>
				<description>&lt;p&gt;&lt;img src=&quot;/assets/images/2014-07-24-aosp-part-3-developing-efficiently/turtle-computer-cuny.jpg&quot; alt=&quot;Turtle-Computer-CUNY&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The AOSP codebase in big.&lt;/p&gt;

&lt;p&gt;Developing on the AOSP is not as simple as writing an app, where you execute a nice gradle target and poof! you see it on the device. So far in this series, we discussed how to &lt;a href=&quot;http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/&quot;&gt;get the AOSP code into our environment&lt;/a&gt;, and how to &lt;a href=&quot;http://udinic.wordpress.com/2014/06/04/aosp-part-2-build-variants/&quot;&gt;build this code into a sweet flashable Android image files&lt;/a&gt;. We can now fill in the missing piece – how to &lt;strong&gt;efficiently&lt;/strong&gt; develop for such an enormous system.&lt;/p&gt;

&lt;p&gt;In this post, I will cover:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Properly importing an AOSP repository into your source control&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Use better ways to build modules and deploy to the device&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Writing scripts for faster development process&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I’ll use Git and Bash commands that you may not know, but can definitely search and learn as we go. You can also use this &lt;a href=&quot;http://linuxconfig.org/bash-scripting-tutorial&quot;&gt;simple Bash scripting tutorial&lt;/a&gt; to get started.&lt;/p&gt;

&lt;!--break--&gt;

&lt;h2 id=&quot;versioning-our-manifest&quot;&gt;Versioning our manifest&lt;/h2&gt;

&lt;p&gt;Before changing any repository on the manifest, I’ll make a small change on the manifest I worked with on my previous posts. The manifest was based on the master branch on Google’s git server. I want my manifest, and my entire AOSP system, to be based on a specific Android version, not the master branch. This will give me more control when new features are coming out to Google’s repository, and I’ll need to choose to migrate those changes into my system. It’s a best practice to avoid syncing new changes before they’ve been tested properly.&lt;/p&gt;

&lt;p&gt;To do that, I’ll create a new folder and initialize the repo for the android version tag that I want, in this case - Android 4.4.3_r1.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;tmp_folder
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;repo init &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; https://android.googlesource.com/platform/manifest &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; android-4.4.3_r1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Inside this folder, the &lt;em&gt;.repo/manifest.xml&lt;/em&gt; file is the manifest file relevant for this version. We’ll merge that manifest with the one I currently have. You can take a look at the &lt;a href=&quot;https://github.com/Udinic/ucmod_manifest/commit/caf94dfae301fc5fc4a0f6fa6b09e1ae8b902e9e&quot;&gt;commit that I made&lt;/a&gt; to see the changes, which are basically just taking all the projects definition from the android-4.4.3_r1 tagged manifest, and adding my “udinic” remote.&lt;/p&gt;

&lt;p&gt;The merged manifest is the one we’ll start using from now on. I created a separate branch for the updated manifest (not to interfere with the examples on my last posts), called “dev_branch”. Now I’ll re-initialize my working dir with the new branch and sync it, to get the latest changes from the android 4.4.3 version.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &amp;lt;working &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;repo init &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; git@github.com:Udinic/ucmod_manifest.git &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; dev_branch
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: This is the exact procedure you’ll need to do to your manifest, when updating your AOSP system with a new version from Google’s servers. Meaning - if your ROM is based on Android 4.4.2, and now Android 4.4.4 came out, that’s the first step you need to do in order to apply those updates on your codebase. If there’ll be enough requests - I’ll post a complete guide for this process.&lt;/p&gt;

&lt;p&gt;Now that we got that out of the way, let’s move on to do some real changes:&lt;/p&gt;

&lt;h2 id=&quot;bringin-it-home&quot;&gt;Bringin’ it home&lt;/h2&gt;

&lt;p&gt;Our first step – being able to “edit” an AOSP repository. We need to push an existing AOSP repository to our own source control, so we can push new changes. Basically - making it “our own”.&lt;/p&gt;

&lt;h3 id=&quot;copy-a-repository-to-my-github-account&quot;&gt;Copy a repository to my Github account&lt;/h3&gt;

&lt;p&gt;The first repository we want to make changes to, is the &lt;em&gt;frameworks/base&lt;/em&gt; project. This project contains the entire Android framework code, with all the UI elements you see on your screen (Notification bar, Navigation Bar etc.).&lt;/p&gt;

&lt;p&gt;We first need to create a new repository on the Github account that hosts our repositories; we’ll call it “ucmod_frameworks_base”. I used my account on Github, but you can use BitBucket or any other source control that you’d like, as long as you’re using Git.&lt;/p&gt;

&lt;p&gt;After doing that - Let’s get some code inside.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &amp;lt;working &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/frameworks/base
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git status&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;HEAD detached at 36e356c
nothing to commit, working directory clean&lt;/p&gt;

&lt;p&gt;Running &lt;em&gt;git status&lt;/em&gt; inside that folder is showing that we’re currently on “detached HEAD mode”. This means that we’re aren’t standing on any branch for this repository, and need to checkout a branch before being able to commit anything. This is a safe state, helping to avoid committing changes that we may not want to commit. The current checked-out revision for the repository, is the one stated on the manifest file for this specific project. In our case - the one that’s tagged with the android-4.4.3_r1 tag. Before we can push the frameworks/base code, we need to create a branch. This will be our “development branch”, from which we’ll branch out and merge back in when developing.&lt;/p&gt;

&lt;p&gt;A few words on “development branches” in general - some developers/companies prefer to use the “master” branch as a development branch, and some prefer using a separate branch, from which all feature branches will be created and merged back into after the work on them was done. In that case, the master branch can be used to hold the most stable version or even not be used at all. There are other options of course, each with its own pros/cons, and your decision should depend on the project’s size, architecture, team size and more.&lt;/p&gt;

&lt;p&gt;My development branch will be called udi-dev. That’s how I’m creating and pushing it:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git checkout &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; udi-dev
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git remote add udinic git@github.com:Udinic/ucmod_frameworks_base.git
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git push udinic udi-dev&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;These commands will:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Create a new branch called udi-dev, from the existing revision.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Add a new remote called “udinic” to point the repository I just created under my Github account.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Push my development branch into the new remote.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This process will take a while, since this is a big repository. In the meantime, we can update our manifest to point the frameworks/base project to the new repository.&lt;/p&gt;

&lt;h3 id=&quot;updating-the-manifest&quot;&gt;Updating the manifest&lt;/h3&gt;

&lt;p&gt;We’ll go to the dev_branch branch on the manifest project, and edit the frameworks/base project from:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;frameworks/base&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform/frameworks/base&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;to be&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;frameworks/base&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;ucmod_frameworks_base&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;remote=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;udinic&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;revision=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;udi-dev&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The new project definition will take the &lt;em&gt;ucmod_frameworks_base&lt;/em&gt; repository from the &lt;em&gt;udinic&lt;/em&gt; remote, in the “udi-dev” revision - the development branch we created earlier for this project.&lt;/p&gt;

&lt;h2 id=&quot;making-some-changes&quot;&gt;Making some changes&lt;/h2&gt;

&lt;p&gt;To start coding, I’ll open the entire AOSP codebase on my Android Studio. Yes, it’s possible and there are even scripts in the AOSP system to help us do that.&lt;/p&gt;

&lt;h3 id=&quot;opening-the-codebase-in-the-ide&quot;&gt;Opening the codebase in the IDE&lt;/h3&gt;

&lt;p&gt;I use Android Studio and I’m sure many of you do too.&lt;/p&gt;

&lt;p&gt;I’ve found &lt;a href=&quot;https://shuhaowu.com/blog/setting_up_intellij_with_aosp_development.html&quot;&gt;these great instructions&lt;/a&gt; very helpful for opening the AOSP codebase in Android Studio. They are meant for opening the CyanogenMod codebase, but it’s using scripts that are available as part of the AOSP. As I mentioned in &lt;a href=&quot;https://plus.google.com/113156787654356910368/posts/Urt2uFHgm7V&quot;&gt;one of my Google+ posts&lt;/a&gt;, I did do something different than the original instructions, so you’re welcome to use my advice when using these instructions.&lt;/p&gt;

&lt;p&gt;The codebase is big and might take a couple of mins. to index when first opening it. Usually it works pretty smoothly after that. If you feel it’s really slow to operate - turn on the “Power save mode” from the “File” menu. This will turn off features like auto-compilation, auto-import and other stuff that could hang when working on large codebases.&lt;/p&gt;

&lt;h3 id=&quot;workin-workin&quot;&gt;Workin’ Workin’&lt;/h3&gt;

&lt;p&gt;As the first change to our new ROM, I wanted to pick something simple, yet visual.&lt;/p&gt;

&lt;p&gt;There’s a small text item on the status bar that appears whenever there’s no service at the moment, letting us know we can only make emergency calls. This text item is not shown at all in all other cases. Here’s how it looks like when it does:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-07-24-aosp-part-3-developing-efficiently/wpid-emergency-before.png&quot; alt=&quot;wpid-emercency-before.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can use that text item to put something of our own, when not used for this purpose. For example, I thought it could be a nice place to put a small branding text, such as my website. But in order to do that - I need to figure out where is it being created. I used Hierarchy Viewer to locate the TextView and after a short investigation - found it in the PhoneStatusBar.java file, in the makeStatusBarView() method. Here’s a snippet of how it’s initialized:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;isAPhone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mNetworkController&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;hasVoiceCallingFeature&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isAPhone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;TextView&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mStatusBarWindow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;findViewById&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;R&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;emergency_calls_only&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;mNetworkController&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;addEmergencyLabelView&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The first thing we notice - it’s shown only if the current device has a voice calling feature. A Wifi only tablet will never show this text item. We’ll modify the code to show the text view, with the text I want, and do that for every device.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;table class=&quot;rouge-table&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter gl&quot;&gt;&lt;pre class=&quot;lineno&quot;&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isAPhone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;TextView&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mStatusBarWindow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;findViewById&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;R&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;emergency_calls_only&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setVisibility&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;VISIBLE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://www.udinic.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;TextView&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mStatusBarWindow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;findViewById&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;R&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;emergency_calls_only&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setVisibility&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;VISIBLE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
     &lt;span class=&quot;n&quot;&gt;mEmergencyCallLabel&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setText&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://www.udinic.com&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
   &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Whether we’re running on a phone or a wifi only tablet, we will always show the URL to my website in the status bar. This is not a robust solution, or even a well-written one, but I’m keeping it that way for simplicity.&lt;/p&gt;

&lt;h3 id=&quot;building&quot;&gt;Building&lt;/h3&gt;

&lt;p&gt;Remember how we bring those changes to the device? If you read my &lt;a href=&quot;http://udinic.wordpress.com/2014/06/04/aosp-part-2-build-variants/&quot;&gt;last post&lt;/a&gt;, you’d know already how to build our codebase into something we can flash on a device. Go refresh your memory if you don’t remember.&lt;/p&gt;

&lt;p&gt;I’ll test the code on my Wifi only Nexus 7 2013, so I’ll run&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source &lt;/span&gt;build/envsetup.sh
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;lunch full_flo-eng
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;and flash&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb reboot bootloader  // Put the device &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;fastboot mode
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;fastboot flashall &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt;      // Flashes the images created&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The result:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-07-24-aosp-part-3-developing-efficiently/wpid-ucmod_after-37.png&quot; alt=&quot;wpid-ucmod_after-3.png&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;rapid-development-on-aosp&quot;&gt;Rapid development on AOSP&lt;/h2&gt;

&lt;p&gt;That was nice huh?&lt;/p&gt;

&lt;p&gt;But you know what? Now that I look at it, I think that I might go with a shorter text, something like “UdinicMod”. But wait a second! I just spent a few minutes to get &lt;strong&gt;this&lt;/strong&gt; working, do we really need to run &lt;em&gt;make&lt;/em&gt; and flash it for every simple change we make?!&lt;/p&gt;

&lt;p&gt;Well..no.&lt;/p&gt;

&lt;p&gt;Luckily, we have options to make the process more efficient and much shorter. To learn how, we first need to understand how things are structured within the build system.&lt;/p&gt;

&lt;h3 id=&quot;modules-in-the-aosp-system&quot;&gt;Modules in the AOSP system&lt;/h3&gt;

&lt;p&gt;Every project in our codebase can introduce one or more modules. These can be apps, libraries, services and more. Every module is declared in the Android.mk file, located inside the project’s folder, along with all its source files. Every Android.mk file can declare one or more modules. The Android.mk file contain all the instructions needed to build its modules. When running &lt;em&gt;make -j16&lt;/em&gt;, the build system is basically invoking all the Android.mk files in the system, relevant to the selected build variant and with respect for dependencies of course.&lt;/p&gt;

&lt;p&gt;Under the framewoks/base folder we have a few modules declared in separate Android.mk files:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;In the &lt;em&gt;frameworks/base/Android.mk&lt;/em&gt; file, we have the “framework” and “framework2” modules (separated to overcome the &lt;a href=&quot;http://stackoverflow.com/questions/15209831/unable-to-execute-dex-method-id-not-in-0-0xffff-65536&quot;&gt;Dex’s 64K methods limitation&lt;/a&gt;) among other smaller modules.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Under the &lt;em&gt;frameworks/base/services/java&lt;/em&gt; we’ll find the “services” module, containing system services; Services such as media, location, connectivity, input and more.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Under the the &lt;em&gt;frameworks/base/packages/SystemUI&lt;/em&gt; we’ll find the “SystemUI” module, which is an apk with the System’s UI, including the status bar, navigation bar and more.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Under &lt;em&gt;frameworks/base/core/res&lt;/em&gt; lays the frameworks-res module, containing framework resource files such as strings, drawables, dimensions and more.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Many more… Just run: &lt;em&gt;find . -name “Android.mk”&lt;/em&gt; inside the framework/base folder to see all of them.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The change I made earlier is part of the SystemUI module. Let’s continue and see how can we build just that one.&lt;/p&gt;

&lt;h3 id=&quot;building-specificmodules&quot;&gt;Building specific modules&lt;/h3&gt;

&lt;p&gt;Since we usually work on a single module, we basically need to build just that. Running &lt;em&gt;make -j16&lt;/em&gt; will try to build all the projects in the system. Since the vast majority of them haven’t changed - nothing will be built. Since there are so many of them, it’ll take time to finish “building” everything.&lt;/p&gt;

&lt;p&gt;When running the &lt;em&gt;source build/envsetup.sh&lt;/em&gt; command, we add some useful function for our day-to-day development. Here is a list of functions coming with the AOSP (seeing by the command &lt;em&gt;hmm&lt;/em&gt;):&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;lunch: lunch &amp;lt;product_name&amp;gt;-&amp;lt;build_variant&amp;gt;&lt;/li&gt;
  &lt;li&gt;tapas: tapas [&lt;App1&gt; &lt;App2&gt; ...] [arm|x86|mips|armv5] [eng|userdebug|user]&lt;/App2&gt;&lt;/App1&gt;&lt;/li&gt;
  &lt;li&gt;croot: Changes directory to the top of the tree.&lt;/li&gt;
  &lt;li&gt;m: Makes from the top of the tree.&lt;/li&gt;
  &lt;li&gt;mm: Builds all of the modules in the current directory, but not their dependencies.&lt;/li&gt;
  &lt;li&gt;mmm: Builds all of the modules in the supplied directories, but not their dependencies.&lt;/li&gt;
  &lt;li&gt;mma: Builds all of the modules in the current directory, and their dependencies.&lt;/li&gt;
  &lt;li&gt;mmma: Builds all of the modules in the supplied directories, and their dependencies.&lt;/li&gt;
  &lt;li&gt;cgrep: Greps on all local C/C++ files.&lt;/li&gt;
  &lt;li&gt;jgrep: Greps on all local Java files.&lt;/li&gt;
  &lt;li&gt;resgrep: Greps on all local res/*.xml files.&lt;/li&gt;
  &lt;li&gt;godir: Go to the directory containing a file.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If the description is not enough, you can always see the source code for those functions. The most helpful functions, in my mind, are the &lt;em&gt;croot&lt;/em&gt;, &lt;em&gt;lunch&lt;/em&gt; and the &lt;em&gt;mm&lt;/em&gt;/&lt;em&gt;mmm&lt;/em&gt; functions.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;mm&lt;/em&gt; function will build the project that we’re currently standing in. The mmm function will take a list of projects folders to build, and build them. Here are some examples:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &amp;lt;working directory&amp;gt;
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmm packages/apps/Email        // Build the Email app
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;packages
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmm apps/Email apps/Music    // Build the Email and Music apps
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;apps/Email
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mm                                                   // Build the Email app&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: Sending more than one path to the &lt;em&gt;mmm&lt;/em&gt; function is available only when running on Bash. I’m using Zsh (along with the highly recommended &lt;a href=&quot;http://ohmyz.sh/&quot;&gt;Oh-my-Zsh&lt;/a&gt;) and it’s not working for me, due to the way the function works internally. As a workaround, you can run “mmm path1 &amp;amp;&amp;amp; mmm path2”.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;mma&lt;/em&gt;/&lt;em&gt;mmma&lt;/em&gt; functions are doing the same, only they are also building the depended modules. Since there’s a need to create some sort of dependency graph for those, in order to see who depends on what, these functions are naturally slower than the &lt;em&gt;mm&lt;/em&gt;/&lt;em&gt;mmm&lt;/em&gt; functions. In most cases you’ll be working on a single module, therefore there’s no need to search for its depended modules. Even if there are dependencies you need to build, you would probably know about them and can build them by yourself using the &lt;em&gt;mm&lt;/em&gt;/&lt;em&gt;mmm&lt;/em&gt; functions, instead of wasting everyone’s time building a dependency graph.&lt;/p&gt;

&lt;p&gt;As mentioned earlier, if the module hasn’t changed - nothing will be done. But we do have the option to rebuild, using the -B switch. For example:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmm packages/apps/Email &lt;span class=&quot;nt&quot;&gt;-B&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Since our new feature is part of the SystemUI module, we need to run the following command in order to build it:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmm frameworks/base/packages/SystemUI&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;So now we have the updated module, but we still need to transfer that module into the device somehow. Let’s review our options for that too.&lt;/p&gt;

&lt;h3 id=&quot;updating-the-device&quot;&gt;Updating the device&lt;/h3&gt;

&lt;p&gt;Want to get those freshly built modules into your device? Here are 2 ways for you to do that:&lt;/p&gt;

&lt;h4 id=&quot;recreating-the-system-image-files&quot;&gt;Recreating the system image files&lt;/h4&gt;

&lt;p&gt;The &lt;em&gt;make -j16&lt;/em&gt; command has given us several image files, which we flashed using the notorious &lt;em&gt;fastboot flashall&lt;/em&gt; command. Since we’re building only specific modules, we need another way to generate those image files. For that, we have another make target, called “snod” (= “System no dependencies”). When running:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make snod&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;We’re re-creating the system image file from the modules that are already built. This command won’t build anything, just create the image file. After that, we can flash using the regular &lt;em&gt;fastboot flashall&lt;/em&gt; command.&lt;/p&gt;

&lt;p&gt;This command is much faster than running the regular &lt;em&gt;make -j16&lt;/em&gt;, with less than a minute of runtime (in compare to a few minutes).&lt;/p&gt;

&lt;h4 id=&quot;syncing-the-changes-directly&quot;&gt;Syncing the changes directly&lt;/h4&gt;

&lt;p&gt;The previous method is faster than running the full make, but we still have the overhead of the image flashing, which also takes time. There’s an even better way than that, by syncing the changes directly to the device. No flashing is required and not even a full restart of the device!&lt;/p&gt;

&lt;p&gt;To do that, we’ll simply run&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;What it does, is checking what are the modules that were changed, in compare to what’s already on the device, and copies them.&lt;/p&gt;

&lt;p&gt;If you’re not working on any of the framework modules, you don’t need to do anything after running the &lt;em&gt;adb sync&lt;/em&gt; command, and the device should run your code without a problem. If you did make some changes to the framework modules, you need to reload them because they are in use. You &lt;em&gt;can&lt;/em&gt; restart the device, but you can simply just restart the Shell, which restarts the framework and other operation system components. Restarting the Shell is quicker than restarting the device and in most cases - that’s all you’ll ever need.&lt;/p&gt;

&lt;p&gt;Since we’re just copying files and not flashing an entire image, and we also get away from doing a full restart to the device, this process is &lt;strong&gt;way&lt;/strong&gt; shorter.&lt;/p&gt;

&lt;p&gt;How short you ask?&lt;/p&gt;

&lt;p&gt;The regular &lt;em&gt;make -j16&lt;/em&gt; and flash process takes around &lt;strong&gt;5 minutes&lt;/strong&gt; to complete on my machine.
The &lt;em&gt;make snod&lt;/em&gt; and flash process takes around &lt;strong&gt;2 minutes.&lt;/strong&gt;
The &lt;em&gt;adb sync&lt;/em&gt; process takes &lt;strong&gt;less than 30 seconds&lt;/strong&gt;!&lt;/p&gt;

&lt;p&gt;So to recap that, we can do our change on the &lt;em&gt;PhoneStatusBar.java&lt;/em&gt; file and run the following commands to update the device:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmm frameworks/base/packages/SystemUI        // build the SystemUI module
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;              // Sync the updated module to the device
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb shell stop     // Stopping the shell
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb shell start    // Starting the shell again&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;And all that will take less than 30 seconds!&lt;/p&gt;

&lt;p&gt;YRMV.&lt;/p&gt;

&lt;h2 id=&quot;automate-our-lives&quot;&gt;Automate our lives&lt;/h2&gt;

&lt;p&gt;After we saw there are &lt;strong&gt;faster&lt;/strong&gt; ways to develop on AOSP, we can now create some helper functions to help us do that &lt;strong&gt;easier&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;I got inspired by some of the functions in the &lt;a href=&quot;https://github.com/CyanogenMod/android_build/blob/cm-11.0/envsetup.sh&quot;&gt;CyanogenMod’s envsetup.sh script&lt;/a&gt;, especially the &lt;em&gt;dopush&lt;/em&gt; function, which accepts another build function and pushes the changes to the device. For example:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;dopush mmm packages/apps/Music&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;I ported it into my Envsetup.sh file, and modified the way it works a little. This is my implementation:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Check that a device is connected&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Run the function that we got as parameter (e.g. “mmm packages/apps/Music”)&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Run_ adb sync_ to sync all the built modules&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;If one of those modules is a framework one - restart the shell&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Print a summery with the number of synced files&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also defined aliases for faster workflow:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mmp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;dopush mm&apos;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mmmp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;dopush mmm&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Now I can simply run this, to build the module and push to the device:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;mmmp packages/apps/Music&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Since sometimes I change several framework modules at a time, I created an alias to help me build them all, and push the changes to the device.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mfwk&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;mmm frameworks/base/core/res frameworks/base frameworks/base/services/java frameworks/base/packages/SystemUI&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;alias &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;mfwkp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;dopush mmm frameworks/base/core/res frameworks/base frameworks/base/services/java frameworks/base/packages/SystemUI&apos;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Here I’m building all the framework modules I introduces earlier, and after that I push them to the device. The &lt;em&gt;dopush&lt;/em&gt; script will restart the shell in order for my changes to apply.&lt;/p&gt;

&lt;p&gt;The changes were &lt;a href=&quot;https://github.com/Udinic/ucmode_build/commit/32c3a1af3a99c0c8220f1d2c4a66986caca83935&quot;&gt;committed&lt;/a&gt; to the envsetup.sh in the &lt;em&gt;build&lt;/em&gt; project of udinicmod. That project was also added to my github in the same way as I did for the frameworks/base project. If you have other commands that you find yourself writing over and over again, you can add new alias or scripts to your envsetup.sh file too. If you feel other can use them - you’re more than welcome to share :)&lt;/p&gt;

&lt;h2 id=&quot;tips&quot;&gt;Tips&lt;/h2&gt;

&lt;p&gt;Some random tips you can use:&lt;/p&gt;

&lt;h3 id=&quot;creatinga-feature-branch-on-multiple-projects&quot;&gt;Creating a feature branch on multiple projects&lt;/h3&gt;

&lt;p&gt;If your feature requires changes on more than one project, you can use the &lt;em&gt;repo start&lt;/em&gt; command to start a feature branch on all of them at once. The syntax is:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;repo start feature_branch_name PROJ1_name [,PROJ2_name, PROJ2_name…]&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The project name is the same name used in the manifest file. For example:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;repo start brand_ucmod ucmod_frameworks_base&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The &lt;em&gt;repo start&lt;/em&gt; is almost identical to just running &lt;em&gt;git checkout -b branch_name&lt;/em&gt;, but it also &lt;a href=&quot;http://stackoverflow.com/questions/15014345/difference-between-repo-start-and-git-checkout-b/23642769#23642769&quot;&gt;set some properties&lt;/a&gt; needed by the &lt;em&gt;git upload&lt;/em&gt; command, which is relevant if you’re using Gerrit for code review. Gerrit is out of the scope of this post.&lt;/p&gt;

&lt;h3 id=&quot;playing-with-the-manifest-file&quot;&gt;Playing with the manifest file&lt;/h3&gt;

&lt;p&gt;If you need to edit your manifest file, whether for adding new repositories or editing existing ones, you have 2 options:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Clone your own copy of the manifest project, edit it, commit+push and then repo sync your AOSP workspace.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Work on the clone you already have inside your working directory, inside _&lt;working dir=&quot;&quot;&gt;/.repo/manifests_&lt;/working&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Using the second option will allow you to easily test changes you make, without the need to commit and push every time. As long as you stay on the &lt;em&gt;default&lt;/em&gt; branch, which is the initialized branch that the &lt;em&gt;repo init&lt;/em&gt; command set. If you change branches, to apply your change to a specific branch, you can reset to the default branch by running the &lt;em&gt;repo init&lt;/em&gt; command again.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;The purpose of this 3-part series was to show that AOSP development is not hard. It does require learning to use new tools and operate a different build system, but it’s not really complicated.&lt;/p&gt;

&lt;p&gt;Getting to know the AOSP allows you to know more about how Android work, and developing on it will give you the freedom to take a adjust Android as you want it, to answer all your needs. The possibilities are endless, just think what you really need and work on that. You can also contribute directly to the &lt;a href=&quot;https://source.android.com/source/contributing.html&quot;&gt;AOSP project&lt;/a&gt; or to other open source AOSP forks, such as the popular &lt;a href=&quot;http://www.cyanogenmod.org/&quot;&gt;CyanogenMod&lt;/a&gt;. You feature could get large exposure and many users could benefit from it.&lt;/p&gt;

&lt;p&gt;I hope things were clear enough to understand. Questions and suggestions are always welcome on the comments section.&lt;/p&gt;
</description>
				<pubDate>Thu, 24 Jul 2014 10:10:00 -0400</pubDate>
				<link>/2014/07/24/aosp-part-3-developing-efficiently/</link>
				<guid isPermaLink="true">/2014/07/24/aosp-part-3-developing-efficiently/</guid>
			</item>
		
			<item>
				<title>AOSP Part 2: Build variants</title>
				<description>&lt;p&gt;On the &lt;a href=&quot;http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/&quot;&gt;previous post&lt;/a&gt;, we got the AOSP code into our environment and learned how that process works. The _repo _tool and the Manifest project goes hand-in-hand, managing the 200+ git repositories, all part of the AOSP.&lt;/p&gt;

&lt;p&gt;Now that we have all the code locally, we need to get all those lines of code into a nice package we can eventually install on a device. The nice guys in Google brought us some nice utilities to help with that. To initialize your environment with those new functions and environment variables, you need to run the command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; &amp;lt;working &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;/build/envsetup.sh&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: I’m using Mac OS with “&lt;a href=&quot;http://ohmyz.sh/&quot;&gt;oh-my-zsh&lt;/a&gt;” and “zsh” as my default shell. When running this command from a shell other than “bash”, you’ll get a warning that only bash is supported. From my experience, I can tell that I never ran into a problem. If you know otherwise - let me know, otherwise - I highly recommend this configuration regardless of AOSP work.&lt;/p&gt;

&lt;p&gt;Now, we can get this party started..&lt;/p&gt;

&lt;!--break--&gt;

&lt;h2 id=&quot;build-targets&quot;&gt;Build targets&lt;/h2&gt;

&lt;p&gt;There are several devices we can build our new Android ROM for (&lt;a href=&quot;http://droidlessons.com/what-are-roms-for-android/&quot;&gt;remember what ROM is&lt;/a&gt;?), with different feature combinations and build types that we can use. In order to pick the desired configuration, we’ll use &lt;em&gt;lunch&lt;/em&gt;. The &lt;em&gt;lunch&lt;/em&gt; command can take the configuration name as an argument, or picked by the user from a list. A configuration name is structured this way:&lt;/p&gt;

&lt;p&gt;PRODUCT-BUILDTYPE&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;PRODUCT&lt;/strong&gt; - This part describes the set of modules to be included, among other configurations. We can include only some of the packages in the system, or all of them, depending on the “flavor” we want our new ROM to be. A “package”, for this matter, can be an app, a system component, sounds, locales, fonts or even just a regular files that are copied to the final product. We can also set different system properties for a specific product. There are several predefined products we can use:&lt;/p&gt;

&lt;p&gt;generic - default set of packages.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;full&lt;/em&gt; - a full set of packages, with most necessary apps and all locales&lt;/p&gt;

&lt;p&gt;&lt;em&gt;aosp&lt;/em&gt; - Basically inherits everything from &lt;em&gt;full&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;sdk - packages needed to build the SDK. I’ll elaborate about the SDK on a separate post.&lt;/p&gt;

&lt;p&gt;There are also sub-products for specific uses. For instance, you can have &lt;em&gt;full_flo&lt;/em&gt; to build the full product for the Nexus 7 (codename “flo”), providing you have the necessary drivers (more on that later). To see what’s included in each product, check the .mk files under &amp;lt;working dir&amp;gt;/build/target/product and also under /device/&amp;lt;vendor&amp;gt;/&amp;lt;device codename&amp;gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;BUILDTYPE&lt;/strong&gt; - Selects the modules to install and set some default settings or behaviors of the product. Each variant can accept only modules who set, in their Android.mk file, the LOCAL_MODULE_TAGS to at least one of the tags it approves (tag examples: &lt;em&gt;debug&lt;/em&gt;, &lt;em&gt;samples&lt;/em&gt;, &lt;em&gt;tests&lt;/em&gt; and more) . The valid build types are:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;eng&lt;/em&gt; - this variant will have some development tools and predefined settings that developers need (e.g. USB debugging enabled).&lt;/p&gt;

&lt;p&gt;&lt;em&gt;user&lt;/em&gt; - this is the variant for a product that suppose to go out to the users. Will use only modules that the end-user will need and more restricted settings.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;userdebug&lt;/em&gt; - A combination of the &lt;em&gt;user&lt;/em&gt; and &lt;em&gt;eng&lt;/em&gt; variants. It’s intended for users testing your environment, but not developing it.&lt;/p&gt;

&lt;p&gt;You can see in more detail the different handling for these variants in the &amp;lt;working dir&amp;gt;/build/core/main.mk file, by following the use of the TARGET_BUILD_VARIANT env variable.&lt;/p&gt;

&lt;p&gt;After selecting our preferred product and build variant, we can apply it using the &lt;em&gt;lunch&lt;/em&gt; command. For this demonstration, I want to run my new ROM on an emulator and have access to every advanced feature available. For that, I’ll use the “full-eng” configuration and I’ll apply it by running:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;lunch full-eng&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;build-flash-able-images&quot;&gt;Build flash-able images&lt;/h2&gt;

&lt;p&gt;The basic build artifacts are system images, one for each partition on the device. To build our images, we need to use the &lt;em&gt;make&lt;/em&gt; command. To build my ROM on my computer, I’ll use this command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The &lt;em&gt;-jN&lt;/em&gt; switch is defining the amount of threads to use when making the project. That’s a standard “GNU make” switch, not unique to AOSP builds. To get the maximum out of your machine, the recommended value for N is CPU_cores*2, so in a single quad-core CPU machine, you should probably use &lt;em&gt;N=8&lt;/em&gt;, but you can try and play with the values to get the most out of your machine. My Macbook Pro has one quad-core CPU with Hyper-Threading, meaning it can run 2 threads simultaneously on each core, providing 8 “virtual” cores. I use mostly N=16 and sometimes N=8, depends if I’m still working on the laptop while building.&lt;/p&gt;

&lt;p&gt;The build process is long, could take anywhere between 30mins to 3 hrs. We’ll talk more about time comparisons and performance boosting later on. If you need something to do while it’s building, I can recommend watching my new favorite TV show “Rick and Morty”, it’s a combination of “Familty Guy” and “Back to the Future” but also cleaver as “South Park”. You can &lt;a href=&quot;http://video.adultswim.com/rick-and-morty/&quot;&gt;stream it for free from their official website&lt;/a&gt; and it works smoothly even if using &lt;em&gt;make -j16 _(tested it myself!)&lt;/em&gt;._&lt;/p&gt;

&lt;p&gt;After the process is complete, the emulator’s path is automatically added to your terminal’s PATH, meaning we can start it by running:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;emulator&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;To check that I’m looking at the image that I just built, I’ll go to the “About Phone” screen and check the “Build Number”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-06-04-aosp-part-2-build-variants/wpid-screen-shot-2014-05-22-at-1-36-15-am23.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I can see the build configuration that I selected - “full-eng”, and my name as the user who built it. I can also see the date/time of the build and that I used the default test key_ _to sign all the modules (which, of course, needs to be changes before releasing). Check the _&lt;working dir=&quot;&quot;&gt;/build/core/version_defaults.mk_ file to see how the build number is formatted.&lt;/working&gt;&lt;/p&gt;

&lt;p&gt;Seeing it runs on an emulator is nice, seeing an actual device running our sweet new ROM - even better.&lt;/p&gt;

&lt;h2 id=&quot;building-for-actual-devices&quot;&gt;Building for actual devices&lt;/h2&gt;

&lt;p&gt;Let’s start with an important fact - Every device needs to have its &lt;strong&gt;own build&lt;/strong&gt; of our ROM.&lt;/p&gt;

&lt;p&gt;You cannot take a build intended for Nexus 7 and flash it on a Galaxy Note 8, mainly because different devices need different drivers. So, the first step we need to do - importing the device’s drivers into our system.&lt;/p&gt;

&lt;h3 id=&quot;drivers&quot;&gt;Drivers&lt;/h3&gt;

&lt;p&gt;Acquiring device drivers is tricky. Not all manufacturers are willing to give away their precious drivers. They don’t want brats like you creating your own OS for their hardware, beyond their control. They do this mainly for commercial/business reasons (how else can they put bloatware on your device?). That’s why you can’t simply build KitKat for, let’s say, Samsung Galaxy S3. All Google sponsored devices, called the “Nexus series”, have their drivers &lt;a href=&quot;https://developers.google.com/android/nexus/drivers&quot;&gt;available for free&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Every set of drivers binaries will probably have its own installation process. For the Nexus drivers, we get an extractable file that we need to run on the root of the working directory, and part of the process will be to accept the licensing agreement. After that - the _&lt;working dir=&quot;&quot;&gt;/vendor_ folder will get a little heavier. Doing the above for the Nexus 7 Wifi 2013 model (Codename “flo”), will produce the following new folders:&lt;/working&gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;working dir&amp;gt;/vendor/asus/flo&lt;/p&gt;

&lt;p&gt;&amp;lt;working dir&amp;gt;/vendor/broadcom/flo&lt;/p&gt;

&lt;p&gt;&amp;lt;working dir&amp;gt;/vendor/qcom/flo&lt;/p&gt;

&lt;p&gt;Inside these folders, we’ll find binary files and .mk files. It’s best to clean the build environment after extracting new drivers in the system. Use:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;make clean
      or
make clobber &lt;span class=&quot;c&quot;&gt;# Both are basically the same&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;building&quot;&gt;Building&lt;/h3&gt;

&lt;p&gt;In order to create a build for our device, we need to initialize the build system with suitable build configurations. I mentioned earlier that we can use sub-products for the main build products, in example for a specific device. In this case, we can use the &lt;em&gt;aosp_flo&lt;/em&gt; sub-product with the &lt;em&gt;eng&lt;/em&gt; build type. We’ll run:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;lunch aosp_flo-eng&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Note: Since the &lt;em&gt;full&lt;/em&gt; and &lt;em&gt;aosp&lt;/em&gt; products are basically the same, we could’ve use &lt;em&gt;full_flo-eng&lt;/em&gt; and get the same results.&lt;/p&gt;

&lt;p&gt;After that, we’ll start the build as usual, with a _make -jN _command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;And now - we wait again. You can watch more “&lt;a href=&quot;video.adultswim.com/rick-and-morty/&quot;&gt;Rick and Morty&lt;/a&gt;”, as suggested earlier.&lt;/p&gt;

&lt;h3 id=&quot;go-with-the-flo&quot;&gt;Go with the Flo&lt;/h3&gt;

&lt;p&gt;At the end of the build process, we’ll have a series of .img files that we flash to the device from the boot-loader. Before doing that - a few words about &lt;strong&gt;how&lt;/strong&gt; it’s done:&lt;/p&gt;

&lt;p&gt;&amp;lt;/br&amp;gt;&lt;/p&gt;

&lt;h4 id=&quot;bootloader-fastboot-and-download-mode&quot;&gt;Bootloader, Fastboot and Download Mode&lt;/h4&gt;

&lt;p&gt;So..who is this “boot” fella and why do we need to load it?&lt;/p&gt;

&lt;p&gt;Well..you can see the &lt;em&gt;boot-loader&lt;/em&gt; as a small part in the system that’s in charge of loading basically everything. The bootloader is the initial sequence of code that executes the operation system. When flashing a new OS on the device, some changes needs to be done to the bootloader, which explains why it’s initially in a locked state in most devices. This is intended to “protect” the device from flashing custom ROMs (mostly for commercial reasons). Unlocking the boot-loader is a process simple as a running a shell command in some devices, and using external software in other. When unlocking the bootloader, ALL USER DATA ON THE DEVICE IS DELETED as a security measure, consider that fact when you decide to do that.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Fastboot/Bootloader mode&lt;/strong&gt; is a state in which your device can be flashed with new images. You can access it by a &lt;a href=&quot;http://www.droidviews.com/how-to-boot-android-devices-in-fastboot-download-bootloader-or-recovery-mode/&quot;&gt;key combination&lt;/a&gt; or using the command: &lt;em&gt;adb reboot bootloader&lt;/em&gt;. Communicating with a device in this state is done using the &lt;em&gt;fastboot&lt;/em&gt; command that comes with the Android SDK, but can also be &lt;a href=&quot;https://code.google.com/p/adb-fastboot-install/&quot;&gt;downloaded&lt;/a&gt; in separate (the ADB command is also included). Not all devices have fastboot mode.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Download mode&lt;/strong&gt; is a mode that exists on Samsung devices to replace the fastboot mode. Communicating with the device in this mode is done using a software called Odin, which explains the other name to this mode - “Odin mode”. Using Odin is out of this post’s scope, but the internet is full of Odin how-to’s.&lt;/p&gt;

&lt;p&gt;To Unlock a Nexus device’s bootloader, you can follow &lt;a href=&quot;http://source.android.com/source/building-devices.html#unlocking-the-bootloader&quot;&gt;these instructions&lt;/a&gt;. Other devices may require different methods, you can search and see the appropriate method for your device.&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h4 id=&quot;flasha-ha&quot;&gt;Flash…A-ha!&lt;/h4&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-06-04-aosp-part-2-build-variants/flashgordonandroid.jpg&quot; alt=&quot;flashGordonAndroid&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Get your device into Fastboot/Bootloader mode and flash all the created images using this command, to be run from the root of your working directory:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;fastboot flashall &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;&lt;strong&gt;flashall&lt;/strong&gt; - This &lt;em&gt;fastboot&lt;/em&gt; command flashes all the images that were created. It looks for them in the path stored in the $OUT environment variable, which is initialized by the &lt;em&gt;lunch&lt;/em&gt; command.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;-w&lt;/strong&gt; - resets the device’s _/data _partition, with all the user’s date, so backup your stuff first. Not mandatory after the first time you flash this ROM.&lt;/p&gt;

&lt;p&gt;After the new images got flashed into my Nexus 7, let’s take a look at the “About” screen:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-06-04-aosp-part-2-build-variants/wpid-screen23.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The “Build number” has our lunch target (aosp_flo-eng), my name, the signing keys and the date/time of the build. This screen is the best place to check if your flash process was successful.&lt;/p&gt;

&lt;p&gt;Victorious!&lt;/p&gt;

&lt;h2 id=&quot;creating-anota-package&quot;&gt;Creating an OTA Package&lt;/h2&gt;

&lt;p&gt;In contrary to image files, where the entire partition is replaced with the content of the image files, an OTA package performs an update to the system’s files. It’s smaller in size and can be incremental from the last build. You can check the _&lt;working dir=&quot;&quot;&gt;/build/tools/releasetools/ota_from_target_files_ file, to see how the OTA package is actually created&lt;/working&gt;&lt;/p&gt;

&lt;p&gt;To create an OTA package, we need to first pick a build configuration, using &lt;em&gt;lunch&lt;/em&gt; as before, and then use&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;make otapackage &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;After the build finishes, the env variable $OUT or $ANDROID_PRODUCT_OUT will be initialized to the path where the product can be found, that’s where the OTA zip file will be. It should be around 200 MB in our case, less than the sum of all image files (&amp;gt; 400MB). Installing the OTA can be done using the Recovery system.&lt;/p&gt;

&lt;p&gt;What is a &lt;em&gt;Recovery&lt;/em&gt; you ask?&lt;/p&gt;

&lt;p&gt;Remember the bootloader I mentioned earlier? Well..it can boot our device into the Android OS, that we all know and love, &lt;strong&gt;or&lt;/strong&gt; into another partition with a Recovery console. The latter has tools to help the user recover or repair a problem he’s having with the OS. The basic recovery on AOSP is very limited, it offers basic operation such as deleting user data, upgrading the firmware and is being controlled using the volume up/down and power keys. You can use a custom recovery such as the popular &lt;a href=&quot;https://www.clockworkmod.com/rommanager&quot;&gt;ClockworkMod Recovery&lt;/a&gt;, which supports more functions and touch screen controls. The easiest way to flash a new custom recovery, is using the app &lt;a href=&quot;https://play.google.com/store/apps/details?id=com.koushikdutta.rommanager&quot;&gt;ROM Manager&lt;/a&gt;, but there are other methods simple as a one &lt;em&gt;fastboot&lt;/em&gt; command. Different devices require different steps to do that, search the appropriate method for your device. You can read more about the Recovery &lt;a href=&quot;http://wiki.cyanogenmod.org/w/All_About_Recovery_Images&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In both Stock and Custom recoveries we can flash a new OTA &lt;a href=&quot;http://android-revolution-hd.blogspot.com/2013/12/ow-to-use-adb-sideload.html&quot;&gt;using the adb sideload method&lt;/a&gt;. The stock recovery will check the package’s signature, a check you can bypass on a custom recovery. So, if you didn’t sign your OTA package correctly - you can use a custom recovery instead.&lt;/p&gt;

&lt;p&gt;If the previous ROM on the device was different than the one you installing, it’s encouraged to do a factory reset and clear the cache, to clean up the place and avoid upgrading issues. This can be done from the Recovery console as well. After getting the device into “sideload mode”, we install the OTA package with this command:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;adb sideload &lt;span class=&quot;se&quot;&gt;\&amp;lt;&lt;/span&gt;path to OTA package&lt;span class=&quot;se&quot;&gt;\&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The sideload command copies the OTA file to the device and install it. After the process completes - our new ROM is now installed. It is also possible to write code that does the updating for us, you can read about the &lt;a href=&quot;http://developer.android.com/reference/android/os/RecoverySystem.html&quot;&gt;RecoverySystem class&lt;/a&gt; and take an example from &lt;a href=&quot;https://github.com/CyanogenMod/android_packages_apps_CMUpdater&quot;&gt;Cyanogenmod’s updater&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;An important note for Mac users&lt;/strong&gt;: After building an OTA package for my Nexus 7, I noticed that the WiFi isn’t working at all. After doing a bit of research, it seems like there’s a problem with the WiFi driver on OTA packages &lt;strong&gt;if built on Mac&lt;/strong&gt;. Creating the OTA package on a Linux system resulted in a fully working WiFi. I found &lt;a href=&quot;http://grokbase.com/t/gg/android-building/128v3423db/unable-to-make-working-ota-zip&quot;&gt;another person with the same problem&lt;/a&gt; as I’m having, but for a Galaxy Nexus device, which means this problem may occur on other devices too.&lt;/p&gt;

&lt;h2 id=&quot;build-time-and-performance-boost-using-ccache&quot;&gt;Build time and performance boost using CCache&lt;/h2&gt;

&lt;p&gt;Building Android ROM is a slow process. Many projects are involved and it requires a lot of computing power to crunch all that code together. Strong hardware is the best solution for a fast build - many CPU cores, SSD hard drive and a lot of RAM will increase the build time. Other than that, there is one optimization you can do that doesn’t involve opening your wallet - using CCache.&lt;/p&gt;

&lt;p&gt;CCache stands for “Compiler Cache”. What it does is caching the compilation of C\C++ files, in favor of reusing them in future compilations of the same files. In most cases, C/C++ files aren’t changed between builds, since most of the changes we do are in Java files. This means that this cache could really help speed up the process.&lt;/p&gt;

&lt;p&gt;How faster can it take us?&lt;/p&gt;

&lt;p&gt;I’m using Macbook Pro 2013 with a quad-core CPU + Hyper Threading. A full build after cleanup takes about an &lt;strong&gt;hour and a half.&lt;/strong&gt; Using a “warm” ccache, the process takes about &lt;strong&gt;30 mins&lt;/strong&gt;. That’s &lt;strong&gt;a third&lt;/strong&gt; of the original time! Your results may vary.&lt;/p&gt;

&lt;p&gt;The ccache binary file is located at &amp;lt;working dir&amp;gt;/prebuilts/misc/darwin-x86/ccache/ccache (if you’re using linux, then s/darwin-x86/linux-x86). There are a few important switches to that command:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;-M &amp;lt;size&amp;gt;&lt;/strong&gt; - Initializes the max size of the cache. You can use values as 200M, 30G etc.
&lt;strong&gt;-s&lt;/strong&gt; - See statistics of the cache. The amount of files, total size and more.
&lt;strong&gt;-C&lt;/strong&gt; - Clears the cache&lt;/p&gt;

&lt;p&gt;In order to set up your system to use ccache, you first need to initialize the cache’s max size. The recommended size is between 50-100G. I can say that after cleaning the cache and running a full build I see that only 6G are used, but before I cleaned the cache it was about 45G (I played around a lot with different repos, so maybe that’s why). To initialize the max size, I ran the command only once, before the first time I ran a build:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&amp;lt;&lt;/span&gt;working &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&amp;gt;&lt;/span&gt;/prebuilts/misc/darwin-x86/ccache/ccache &lt;span class=&quot;nt&quot;&gt;-M&lt;/span&gt; 50G&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;You also need to set the following env variable, showing the build system that you want to use ccache. I suggest putting this setting with the other global variables that you set in your environment:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;USE_CCACHE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The location of the ccache is by default _~/.ccache. _If you want to change this, you can set it using:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CCACHE_DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&amp;lt;&lt;span class=&quot;se&quot;&gt;\p&lt;/span&gt;ath_of_your_choice&lt;span class=&quot;se&quot;&gt;\&amp;gt;&lt;/span&gt;/.ccache&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If you want to watch the ccache being used as you build, you can run&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;watch &lt;span class=&quot;nt&quot;&gt;-n1&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; prebuilts/misc/darwin-x86/ccache/ccache &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;I highly recommend using the ccache for your builds. It really is improving the build time and I never had any problems with using the cache. But then again - I don’t normally change C/C++ files in the AOSP. If you find yourself in a weird compilation problem, and you want to just clean everything up, use &lt;em&gt;make clean&lt;/em&gt; &lt;strong&gt;and&lt;/strong&gt; also run this to clear the ccache:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&amp;lt;&lt;/span&gt;working &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&amp;gt;&lt;/span&gt;/prebuilts/misc/darwin-x86/ccache/ccache &lt;span class=&quot;nt&quot;&gt;-C&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;At the end of this part, we got our new ROM packaged and flashed into an actual device. Exciting times indeed.. but this is just the beginning. What we learned is just the overhead of creating an AOSP product, the real work is ahead of us. We still have a huge amount of repositories that we need to steer to our direction, and some roads are treacherous. In the last part of this series, we’ll discuss how to create new features on AOSP by maintaining changes on multiple repositories, easily deploying new changes and debugging your code. It’ll give you the jump-start you need before doing any any AOSP work.&lt;/p&gt;

&lt;h2 id=&quot;further-reading&quot;&gt;Further reading&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://amzn.to/1kJfajE&quot;&gt;Embedded Android by Karim Yaghmour&lt;/a&gt; - This book explains the AOSP from the A to the P. The different components, the way the build system works, the many “Hacks” we can do there and some really great How-to’s (adding new device, adding new apps/libraries etc.). I don’t read technical books at all, but for this subject - it’s a life saver.&lt;/p&gt;
</description>
				<pubDate>Wed, 04 Jun 2014 12:40:43 -0400</pubDate>
				<link>/2014/06/04/aosp-part-2-build-variants/</link>
				<guid isPermaLink="true">/2014/06/04/aosp-part-2-build-variants/</guid>
			</item>
		
			<item>
				<title>AOSP Part 1: Get the code using the Manifest and Repo tool</title>
				<description>&lt;p&gt;6 months ago, I &lt;a href=&quot;https://plus.google.com/113156787654356910368/posts/EG9cFa4Zjhs&quot;&gt;moved to New York&lt;/a&gt;, the first city I lived in outside of Israel.&lt;/p&gt;

&lt;p&gt;With a new job at a new place, I decided to also try a new laptop running a new platform - Mac OS. I always used Windows before that. I have used Linux as a VM and on servers I worked on, but as a primary OS - I sticked with Windows (with no particular reason).  After many recommendations, I decided to give Mac its big break. As one big advantage of Mac over Windows - I could build my own &lt;a href=&quot;http://droidlessons.com/what-are-roms-for-android/&quot;&gt;Android ROM&lt;/a&gt; (Android operation system software, running on a device), which i’ve wanted to try and do for a long time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2014-05-24-aosp-part-1-get-the-code-using-the-manifest-and-repo/wpid-images-21.jpeg&quot; alt=&quot;&quot; class=&quot;center-image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It wasn’t an easy start..&lt;/p&gt;

&lt;!--break--&gt;

&lt;p&gt;There are many developers who are working on their own Android ROM (not nearly as app developers though..), but the solutions to many of the common problems are scattered across Google Groups, Stackoverflow and some blog posts across the net. Getting my environment to work and make the changes I wanted to do, required research and many trials and errors. I’ll try to sum up some of the important stuff I learned from my experience, to get you up and running. I’ll also share some tips to a better workflow while developing on AOSP. Later on, I’ll post about specific stuff that can be achieved, as adding new system fonts, changing boot animation and even customizing the navigation/status bar. The introduction will be divided into 3 parts, each will get its own blog post:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Part 1: Get the code using Manifest and repo. &lt;/strong&gt;This is the post you’re currently reading. I’ll explain what is a manifest project and how it helps you define your system’s structure. The manifest project is used by the &lt;em&gt;repo&lt;/em&gt; tool to download all the source code you need, which will be discussed too.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Part 2: Build variants&lt;/strong&gt;. This part will discuss the different builds you can create. Whether it’s flash-able images, OTA (=Over-The-Air) package and even your own Android SDK. We can also create builds for different devices using different configurations.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Part 3: Developing with ease&lt;/strong&gt;. After learning how to create our new Android flavor, which doesn’t have to be named after a dessert, we can start making our work simple as possible. Building the entire system is unnecessary while making small changes, there are ways speed up the process of getting your code into the device. I’ll also share some of the scripts I wrote to make my life easier.&lt;/p&gt;

&lt;p&gt;Before we’ll dive into the mysteries of the Manifest project, let’s discuss some of the prerequisites from our build environment.&lt;/p&gt;

&lt;!-- more --&gt;

&lt;h2 id=&quot;what-do-we-need&quot;&gt;What do we need&lt;/h2&gt;

&lt;p&gt;Frankly, Google did a pretty good job with the &lt;a href=&quot;http://source.android.com/source/initializing.html&quot;&gt;build environment initialization guide&lt;/a&gt;. They covered most of the cases that could happen while initializing your environment, addressing different build server OS and Android versions. I have some insights to add on top of those:&lt;/p&gt;

&lt;h4 id=&quot;linux-and-mac-os&quot;&gt;Linux and Mac OS&lt;/h4&gt;

&lt;p&gt;One important thing that people ignore or assume that is correct, is the java version they use. Make sure the java version you have installed (and use by default) is the one described in the Google’s official guide. Up until recently, the only java version allowed was Java 1.6, but with the latest KitKat editions we can use Java 1.7. Consult the Google’s official AOSP environment initialization guide, to see the correct java version you need to use.&lt;/p&gt;

&lt;h4 id=&quot;mac-os&quot;&gt;Mac OS&lt;/h4&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Get &lt;a href=&quot;http://brew.sh/&quot;&gt;Homebrew&lt;/a&gt;. Seriously, this will make your life much easier in general and also for this process, where you need to install several packages. This is a very handy tool that every Mac power user should have.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;As part of the process, you’ll be needing to create a disk image with a specific attributes that the AOSP system requires. Creating the image with enough space is important. They mention that 25GB is a minimum, but they don’t recommend anything else. A full repo can take between 15-30 GB and after building - 20GB more. You might even create an image for other hardware variants (Nexus 7, Nexus 5 etc), which will take extra space. If you plan to create SDKs too, you may want to copy the current SDK outside of the output folder, for compile other apps that uses that. Keeping it in the same disk image will require more space, but will make the moving process much faster each time. My recommendation is using &lt;strong&gt;100GB of space&lt;/strong&gt;, which gives you enough room for building and playing around.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;You need to have Xcode installed, including its Command Line Tools. I think you should go ahead and make sure you have that, but if you want to avoid installing a few GBs just for a few commands - you can follow &lt;a href=&quot;http://tryge.com/2013/06/15/build-android-from-source-macosx/&quot;&gt;this blog post&lt;/a&gt;. I’ll just note that I personally didn’t go this way since I have enough disk space on my laptop, so I didn’t mind installing the whole thing. I’ll also mention that as of this day, where Android 4.4.2 is the latest, there’s a problem using Xcode 5.1. If you have that installed - revert back to 5.0.2.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;repo&quot;&gt;Repo&lt;/h2&gt;

&lt;p&gt;The AOSP source code is a combination (some will say “Synergy”) of ~200 different git repositories. Using the separate repos for different components allows better collaboration and make the entire project more organized. But how do we control that amount of repos? We use the &lt;em&gt;repo&lt;/em&gt; tool.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;repo&lt;/em&gt; tool is here to help us control the insane amount of git repositories. We can update the entire system in one command, we can start a branch on multiple repositories at once and more. The way_ repo_ knows the components it needs to work with, is by initializing it to a Manifest project, which holds the details on all the components we need to work with on this project. More on the Manifest project later on.&lt;/p&gt;

&lt;h4 id=&quot;repo-init&quot;&gt;repo init&lt;/h4&gt;

&lt;p&gt;Initializes the current folder as our project’s root directory, where all the components will be downloaded. There are few important switches to this command:&lt;/p&gt;

&lt;p&gt;**-u &lt;manifest project=&quot;&quot; git=&quot;&quot; URL=&quot;&quot;&gt;** - This will determine the manifest project we’ll use, where all the component we need are declared.&lt;/manifest&gt;&lt;/p&gt;

&lt;p&gt;**-b &lt;manifest project=&quot;&quot; branch=&quot;&quot;&gt;** - We have the option to use different branches of the manifest project, in order to switch between different presets of our project. For instance, we can use a manifest that has defined a different branch to some of its components, to reflect a new feature we are currently testing and not yet merged into our main branch. Omitting this will use the &quot;master&quot; branch.&lt;/manifest&gt;&lt;/p&gt;

&lt;p&gt;**-g &lt;groups to=&quot;&quot; download=&quot;&quot;&gt;** - Using this switch, we can define the component groups we wish to download. Omitting this will use the default group, which has what we need for a standard build. Other groups can be the “tools” group, which consists of the components relevant to the build tools as the ADT, emulator and more. There are also groups to distinguish between the components relevant to a Linux build environment and to a Mac OS one, since we usually don’t need both downloaded.&lt;/groups&gt;&lt;/p&gt;

&lt;p&gt;**-m &lt;manifest xml=&quot;&quot; file=&quot;&quot;&gt;** - choosing the manifest xml file within the manifest project. The default name is “default.xml. Using different manifest XMLs can help us maintain different configurations in the same branch. For example - we can use a manifest xml for testing purposes, which will have additional repositories for diagnostics purposes.&lt;/manifest&gt;&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;// Initializes the current folder to use a manifest project on the provided url, and use the “master&lt;span class=&quot;s2&quot;&gt;&quot; branch.
repo init -u git@github.com/udinic/manifest.git

// Initializes the current folder to use the manifest on the new_feature_branch and sync the “tools” group repositories in addition to the default ones.
repo init -u git@github.com/udinic/manifest.git -b new_feature_branch -g default,tools

// Initializes our current folder to use the auto-test.xml manifest file, on the master branch of the manifest project.
repo init -u git@github.com/udinic/manifest.git -m auto-tests.xml&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;More on the Repo tool will be discussed on Part 3, where we’ll use it for our day-to-day development needs.&lt;/p&gt;

&lt;h2 id=&quot;the-manifest&quot;&gt;The Manifest&lt;/h2&gt;

&lt;p&gt;A manifest file is an XML file, describing a list of repositories to sync our working directory with.&lt;/p&gt;

&lt;p&gt;We can take repositories from different git servers, use different branches for each one of them, gather them into groups for easy management and more. Here’s an example for a manifest xml file:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;    
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;manifest&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;remote&lt;/span&gt;  &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;aosp&quot;&lt;/span&gt;
               &lt;span class=&quot;na&quot;&gt;fetch=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://android.googlesource.com/&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;remote&lt;/span&gt;  &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;udinic&quot;&lt;/span&gt;
               &lt;span class=&quot;na&quot;&gt;fetch=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://github.com/udinic/&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
    
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;default&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;revision=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;master&quot;&lt;/span&gt;
               &lt;span class=&quot;na&quot;&gt;remote=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;aosp&quot;&lt;/span&gt;
               &lt;span class=&quot;na&quot;&gt;sync-j=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;4&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
    
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;art&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform/art&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;bionic&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform/bionic&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;groups=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;pdk&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;dalvik&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform_dalvik” remote=“udinic”/&amp;gt;
      &amp;lt;project path=&quot;&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;frameworks/base&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform_frameworks_base&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;remote=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;“udinic&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;revision=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;“statusbar_fixes&quot;/&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;nt&quot;&gt;&amp;lt;project&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;path=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;tools/adt/eclipse&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;platform/tools/adt/eclipse&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;groups=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;notdefault,tools&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/manifest&amp;gt;&lt;/span&gt;
    &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Let’s review its structure:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&amp;lt;remote&amp;gt;&lt;/strong&gt; - The remote tag is describing the remote git servers we support pulling repositories from. In this case, we have a remote named &lt;em&gt;aosp&lt;/em&gt;, linking to the Google’s aosp git server, and another one named &lt;em&gt;udinic&lt;/em&gt;, linking to a Github account of the user “udinic”.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&amp;lt;project&amp;gt;&lt;/strong&gt; - Defines a single repository. These are the main attributes:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;path&lt;/strong&gt; - Where the repository will be checked out into, relative to the current working directory.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;name&lt;/strong&gt; - The name of the project on our git server&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;remote&lt;/strong&gt; - The name of the remote server where the repository can be found.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;revision&lt;/strong&gt; - The branch/tag name we want to checkout.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;group&lt;/strong&gt; - The group name(s) for this project. We can declare a set of projects as members of a group, then sync only them. Omitting this attribute makes the project a member of the “default” group.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&amp;lt;default&amp;gt;&lt;/strong&gt; - defines a default values for attributes we are using, when syncing the system. In this case, we set the default branch to checkout each project on its “master” branch and the default remote as “aosp”. If we omit those attributes when defining a project, the defaults defined here will be used. Other interesting attributes:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;sync-j&lt;/strong&gt; - The value for this will be the number of threads to use when syncing the system. Parallelization helps get the job done quicker, but could also get the computer or the network stuck. Using 4 threads is what commonly used for syncing.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;sync-c&lt;/strong&gt; - syncing only the current branch/tag from git. This will checkout for each project only the current branch/tag that we specify for it, and not any other branches that exists on the repository. This will help save some space and bandwidth (and also time), but if you’ll need to switch between branches on a specific project later on - you’ll need to fetch it manually.&lt;/p&gt;

&lt;p&gt;Running a basic &lt;em&gt;repo init&lt;/em&gt; command on this manifest file, will sync 4 repositories into the working directory. The “platform/tools/adt/eclipse” project won’t get synced since it’s a member of the “notdefault” and “tools” group. Members of the “notdefault” group can be synced only if one of the groups they belong to are selected to be synced, when initializing the working directory. For example if we’ll use the command &lt;em&gt;repo init -u &amp;lt;manifest project git url&amp;gt; -g default,tools&lt;/em&gt; we’ll sync all the &lt;em&gt;default&lt;/em&gt; repositories and the &lt;em&gt;tools&lt;/em&gt; group repositories. Using &lt;em&gt;-g all&lt;/em&gt; will sync all the repositories available on the manifest, regardless of the groups they belong to.&lt;/p&gt;

&lt;p&gt;Note: Notice the project names I used, for the projects hosted on the Github remote, has no “/“-s as the other projects taken from the &lt;em&gt;aosp&lt;/em&gt; remote. The reason for that, is because “\”-s represent folders within the Git repository. Since Github doesn’t really support grouping repositories, I replaced all the “\”-s with “_”-s. That way, I keep my projects organized even when looking on my Github’s account profile.&lt;/p&gt;

&lt;h2 id=&quot;syncin&quot;&gt;Syncin’&lt;/h2&gt;

&lt;p&gt;After running &lt;em&gt;repo init&lt;/em&gt;, we’ll have a “.repo” folder in the current working directory. This folder contains the manifest project and a soft link to the current manifest xml file, chosen using the &lt;em&gt;repo init&lt;/em&gt; command. The rest of the working directory is empty since we didn’t start the syncing process.&lt;/p&gt;

&lt;p&gt;To start syncing our system from the data on the chosen manifest file, we need to run&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This command will first checkout the latest manifest file from its own repository, in case it was changed since the last time we ran &lt;em&gt;repo init&lt;/em&gt;. After that - the repo tool will go over all the projects in the manifest file and download those we wanted to sync. It’ll sync all the repositories from the groups we selected to sync, checkout the files on the branch we set for each project and from the remote server we declared for it.&lt;/p&gt;

&lt;p&gt;This process will take a while. The amount of time is depended on your hardware, the internet connection you have and the way you initialized your repo. This will probably take between 1-2 hours (sometimes, more then that), so you should probably let it work overnight.&lt;/p&gt;

&lt;p&gt;You can also sync specific projects defined on the manifest. Just use the following syntax:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;PROJ NAME1] &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;PROJ NAME2] ..&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;You can control on the number of threads running the sync by adding _-j&lt;num-threads&gt;_ to the commend, thus bypassing the _sync-j_ default value on the manifest. For example: _repo sync -j8_ will run the sync using 8 threads. As a rule of thumb, it’s good not to cross the number of CPU-cores*2 threads. Using **-j** alone will maximize the number of threads that can be utilized in your computer. Do that only if you don’t intend using the machine for a while.&lt;/num-threads&gt;&lt;/p&gt;

&lt;p&gt;From my experience, the syncing process could have fetching errors. This is relatively common since we’re downloading a tremendous amount of data, and network issues are no strangers in our world. Running &lt;em&gt;repo sync&lt;/em&gt; again will fetch the rest of the missing pieces. Sometimes, error could occur because of the parallelization of the process. If you see errors that relates to access denied or looking for files that aren’t exist yet - using &lt;strong&gt;-j1&lt;/strong&gt; in the repo sync command will use only 1 thread, and will sync the repositories by the correct order that avoids dependency issues.&lt;/p&gt;

&lt;h2 id=&quot;using-a-mirror&quot;&gt;Using a Mirror&lt;/h2&gt;

&lt;p&gt;If you need to sync the AOSP to different computers on the same network, you can checkout AOSP as a mirror and then sync all the computers with that. This will save bandwidth and time (lots of it!).&lt;/p&gt;

&lt;p&gt;To initialize your mirror, you need to initialize your system with a mirroring manifest and the &lt;em&gt;—mirror&lt;/em&gt; switch on the repo init commend. The mirroring manifest is very similar to the regular manifest, but with small changes. Here is the commands to sync an AOSP mirror from Google’s servers:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;repo init &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; https://android.googlesource.com/mirror/manifest —mirror
repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;After downloading the mirror, you can initialize other clients using this:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;repo init &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &amp;lt;path to mirror&amp;gt;/platform/manifest.git &amp;lt;other repo init options&amp;gt;
repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;If you want to create your own mirroring manifest, there’s a link to a relevant guide on the bottom of this post.&lt;/p&gt;

&lt;h2 id=&quot;readylets-do-this&quot;&gt;Ready..let’s do this!&lt;/h2&gt;

&lt;p&gt;I &lt;a href=&quot;https://github.com/Udinic/ucmod_manifest/blob/master/default.xml&quot;&gt;created a manifest project&lt;/a&gt; for the purpose of this series of posts. It’s a copy of the default AOSP one, with an addition of a remote git server to my Github account. Currently all the projects are directed to the AOSP git server, but as we progress with this series - we’ll add projects to my Github account and we’ll build our own ROM together, named “ucmod” (udinic-mod).&lt;/p&gt;

&lt;p&gt;To initialize your environment with my manifest, use these commands:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;repo init &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; https://github.com/Udinic/ucmod_manifest.git
repo &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;..and we wait…&lt;/p&gt;

&lt;p&gt;After the code has been downloaded, we have a lot of repositories in our working directory. Going into one of them and running &lt;em&gt;git status&lt;/em&gt; will reveal that the repository is in a “detached head” mode:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;git status

&lt;span class=&quot;c&quot;&gt;# HEAD detached at 752e389&lt;/span&gt;
nothing to commit, working directory clean&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This means that we are currently not on a specific branch, but our files are checked out to a specific commit, as our manifest has directed to. This was intended to avoid doing changes on the code without intentions. We’ll discuss how to start working with the repositories on Part 3 of this introduction.&lt;/p&gt;

&lt;p&gt;On the next part, we’ll discuss how to take all that code and crunch it into a beautiful package we can install on a device. We’ll also consider different build configurations and see how we can make different “flavors” of AOSP buids.&lt;/p&gt;

&lt;h2 id=&quot;further-reading&quot;&gt;Further reading&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://source.android.com/source/building.html&quot;&gt;Google’s official Guide&lt;/a&gt; - This is Google’s official guide to get you started with AOSP development. It’s pretty good as I mentioned earlier and should be used in conjunction with this post to get started.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://groups.google.com/forum/#!msg/android-building/2gLwqjlQq3A/-hmgahe1YcQJ&quot;&gt;Mirroring AOSP&lt;/a&gt; - The first post from (formally) one of Google’s AOSP main maintainers about the subject.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://bhundven.blogspot.com/2013/06/master-of-android-repo-mirrors.html&quot;&gt;Mirroring CyanogenMod&lt;/a&gt; - This post helps creating a mirroring manifest for the CyanogenMod rom. This could help understand how to create a mirroring manifest for your own ROM.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://stackoverflow.com/questions/9046572/how-to-understand-the-directory-structure-of-android-root-tree&quot;&gt;AOSP Folders structure&lt;/a&gt; - Now you have about 200 new repositories in your computer, would like to know more about them and what they do?&lt;/p&gt;

</description>
				<pubDate>Sat, 24 May 2014 13:00:29 -0400</pubDate>
				<link>/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/</link>
				<guid isPermaLink="true">/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/</guid>
			</item>
		
			<item>
				<title>ViewPager and Hardware acceleration</title>
				<description>&lt;p&gt;Last week, Romain Guy posted about &lt;a href=&quot;http://www.curious-creature.org/2013/09/13/optimizing-hardware-layers/&quot;&gt;Optimizing hardware layers&lt;/a&gt;. He explained how hardware layers are a great way to boost the performance of your animations, but can also degrade it.&lt;/p&gt;

&lt;p&gt;When your view is backed by a hardware layer, that layer will get updated every time the view itself will update, and after that the layer will be drawn to the screen. Meaning, if your view is altered during an animation – more work is done per frame and you’ll get a drop in your frame-rate. That’s why it’s not wise to change your animated view while it’s backed by a HW layer.&lt;/p&gt;

&lt;p&gt;On his post, Romain suggested an easy way to spot such problems, using the “Show hardware layers updates” under the Developer Options. Every time a HW layer is updated – it’ll be highlighted in green.&lt;/p&gt;

&lt;p&gt;So I tried it.&lt;/p&gt;

&lt;!--break--&gt;

&lt;p&gt;I played with one of the apps I’m currently working on, and saw that when scrolling my ViewPager to the sides – its pages are highlighted in green for the **entire **scrolling phase. Since i don’t back any of the pages there with HW layer, I was trying to find who does. For that, I used a small trick – I used DDMS to run TraceView for the time I scroll the ViewPager, sorted the methods calls by name, searched for “android/view/View.setLayerType” and then followed its parents until I found the cause – ViewPager#enableLayers():&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;enableLayers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;enable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;childCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getChildCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;childCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;layerType&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;enable&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;
                &lt;span class=&quot;nc&quot;&gt;ViewCompat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LAYER_TYPE_HARDWARE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ViewCompat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LAYER_TYPE_NONE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;nc&quot;&gt;ViewCompat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setLayerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getChildAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;layerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;This method is in charge of enabling/disabling HW layer for the ViewPager’s children. It’s called once from ViewPaper#setScrollState():&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;setScrollState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mScrollState&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;mScrollState&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mPageTransformer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// PageTransformers can do complex things that benefit from hardware layers.&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;enableLayers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newState&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;SCROLL_STATE_IDLE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mOnPageChangeListener&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mOnPageChangeListener&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;onPageScrollStateChanged&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;As we can see, the HW is disabled when the scroll state is IDLE and enabled otherwise, on DRAGGING or SETTLING. This is a good thing do to, especially when the ViewPager uses a PageTransformer. A PageTransformer meant to “apply a custom transformation to the page views using animation properties” (&lt;a href=&quot;http://developer.android.com/reference/android/support/v4/view/ViewPager.PageTransformer.html&quot;&gt;Source&lt;/a&gt;), and since we’re doing animations when we scroll our pages, we can understand why it’s a good thing to use HW layers.&lt;/p&gt;

&lt;p&gt;But, what if the PageTransformer **changes **the view as it animates it?&lt;/p&gt;

&lt;p&gt;Maybe our PageTransformer changes the page’s background color to become darker as the page scroll? Or maybe it moves some items inside the page? In that case, the HW layer will get updated for **every frame. **This is the reason my app was showing green when I scrolled the pager – I applied View changes during the page transformation.&lt;/p&gt;

&lt;p&gt;So now that we have found the problem – how do we solve it? Well, I thought about overriding one of the ViewPager’s methods I showed above, but since they are private – it’s not possible. But I was able to workaround the problem in a different approach: Notice that on ViewPage#setScrollState(), after calling enableLayers(), we also call OnPageChangeListener#onPageScrollStateChanged(), in case such listener was set. So what I did was to set a listener that reset the layer type of all the ViewPager’s children to NONE when its scroll state is different than IDLE:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onPageScrollStateChanged&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scrollState&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// A small hack to remove the HW layer that the viewpager add to each page when scrolling.&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scrollState&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ViewPager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;SCROLL_STATE_IDLE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;childCount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;your_viewpager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getChildCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;childCount&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++)&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;your_viewpager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getChildAt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setLayerType&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;View&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;LAYER_TYPE_NONE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;That way, after ViewPager#setScrollState() set a HW layer for the pages – I set them back to NONE, which disables the use of HW layers. The major difference was shown on the Nexus 7, since the screen is bigger and so was the area my ViewPager was covering.&lt;/p&gt;

&lt;p&gt;Problem solved! No green is now shown when scrolling through my ViewPager.&lt;/p&gt;

&lt;p&gt;After solving this problem, I decided to report it to Google, since there must be a better way. Maybe some kind of a setter in ViewPager to disable the use of HW layers when scrolling through the pages. That’s why I &lt;a href=&quot;https://code.google.com/p/android/issues/detail?id=60094&quot;&gt;reported this&lt;/a&gt; on Google’s Issue tracker. Hopefully someone will see it and maybe even fix it.&lt;/p&gt;
</description>
				<pubDate>Mon, 16 Sep 2013 09:30:10 -0400</pubDate>
				<link>/2013/09/16/viewpager-and-hardware-acceleration/</link>
				<guid isPermaLink="true">/2013/09/16/viewpager-and-hardware-acceleration/</guid>
			</item>
		
			<item>
				<title>Write your own Android Sync Adapter</title>
				<description>&lt;p&gt;On my last post on the subject, &lt;em&gt;&lt;a href=&quot;http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/&quot;&gt;Write your own Android Authenticator&lt;/a&gt;&lt;/em&gt;, we embarked on a journey to the unfamiliar part of authentication on Android. I received &lt;strong&gt;many&lt;/strong&gt; positive responses about it from you all, and it seems I really helped a lot of people to get to know this feature well.&lt;/p&gt;

&lt;p&gt;Since then, I had a lot of stuff going on in my life (getting married is one of them) which delayed the release of this obvious sequel. On this post, our journey continues to another not-well-documented area, which goes hand-in-hand with our own authenticator. It’s no other than the notorious &lt;strong&gt;SyncAdapter&lt;/strong&gt;. I’ll show you how to make your app more efficient and robust when it comes to data synchronization, by using sync adapters. The web doesn’t have all the information I’d hope to find about it. I felt like I need to give this feature another one of my in-depth researches, see what this feature is all about, how it works, how to write one, and finally – report back.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/image2.png&quot;&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/image_thumb2.png&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the screenshot: That’s how a sync adapter looks on the account screen, under the device’s Settings screen.&lt;/p&gt;

&lt;p&gt;First, I’ll explain the benefits of the sync adapter. Then, how it works and after that how to build and monitor it. Finally, I’ll introduce the sample app I wrote, demonstrating how the sync adapter works, and also allowing you to play with its settings to learn from experience.&lt;/p&gt;

&lt;!--break--&gt;

&lt;h2 id=&quot;terra-incognita&quot;&gt;Terra Incognita&lt;/h2&gt;

&lt;p&gt;So what is this SyncAdapter?&lt;/p&gt;

&lt;p&gt;A SyncAdapter is a plug-in that handles background syncs. It’s usually needed to sync data from your app to a server. This plug-in is registered on the platform’s Sync Manager, which is in charge of running it. It’s triggered when needed, requested or scheduled.&lt;/p&gt;

&lt;p&gt;Some of you may think about writing a simple Service/IntentService to do that task. But, writing a SyncAdapter has many advantages over that and other similar approaches:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Battery efficiency – The system schedules the sync to run when other syncs run, or when some other network request was already made on the device. This prevents awaking the device from its sleep for performing a single sync.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Interface – All sync adapter on the device can be accessed from the Settings screen, under the account they are tied to. This gives the end user the option to change sync preferences, see if there are any sync problem or even disable the sync.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Content awareness – If we use ContentProvider for accessing/manipulating our data, the sync adapter can observe any changes done to it. That way it can run only when the data **actually **changes.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Retry mechanism – The sync manager has its implementation to retry failed syncs, using timeouts and &lt;a href=&quot;http://en.wikipedia.org/wiki/Exponential_backoff&quot;&gt;exponential back offs&lt;/a&gt;. All those to conserve battery and sync your data as soon as possible.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;And you get all that for free!&lt;/p&gt;

&lt;p&gt;The fine print is that you need to learn how to write one, which was not easy until recently. The documentation got improved since this feature was introduced on Android 2.0 (API level 5), and there’s even a &lt;a href=&quot;http://developer.android.com/training/sync-adapters/creating-sync-adapter.html&quot;&gt;training chapter&lt;/a&gt; on the Android developers site. But, even combined with the SampleSyncAdapter by Google (comes with the SDK), it’s still not simple to understand how to create your own adapter to fit your needs. There are many unanswered question about its properties, and how it operates under certain circumstances.&lt;/p&gt;

&lt;h2 id=&quot;how-the-sync-adapter-works&quot;&gt;How the sync adapter works&lt;/h2&gt;

&lt;p&gt;The sync adapter has 2 main properties: &lt;em&gt;syncable&lt;/em&gt; and &lt;em&gt;auto-sync&lt;/em&gt;. The &lt;em&gt;syncable&lt;/em&gt; property is the &lt;em&gt;enabled&lt;/em&gt; state for the sync adapter. A syncable=false adapter cannot sync automatically or manually, and won’t be seen in the device’s Settings screen. The _auto-sync _property determine if the sync adapter should sync automatically, which will be discussed next:&lt;/p&gt;

&lt;h3 id=&quot;automatic-sync&quot;&gt;Automatic sync&lt;/h3&gt;

&lt;p&gt;We can set the sync adapter to run automatically, which means it’ll trigger whenever it’s needed. By default, all SyncAdapters with auto-sync=ON will be triggered every 24 hours. But, they can also run when there is a change to our data, notified by the content provider. We’ll get back to how it’s actually done later.&lt;/p&gt;

&lt;p&gt;The auto-sync setting cannot be ON by default, but can be set programmatically by calling &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#setSyncAutomatically(android.accounts.Account, java.lang.String, boolean)&quot;&gt;&lt;em&gt;setSyncAutomatically&lt;/em&gt;&lt;/a&gt;(), or by the user on the device’s Settings screen. Here’s how it looks when the sync is off and then on:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/image_thumb3.png&quot; alt=&quot;image&quot; /&gt;
Note: A sync request will be submitted when this setting changes from OFF to ON.&lt;/p&gt;

&lt;h3 id=&quot;periodic-sync&quot;&gt;Periodic Sync&lt;/h3&gt;

&lt;p&gt;If you need to check up on your server once in a while, see if it has new data for us, you can call &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#addPeriodicSync(android.accounts.Account, java.lang.String, android.os.Bundle, long)&quot;&gt;&lt;em&gt;addPeriodicSync&lt;/em&gt;&lt;/a&gt;() and get our sync adapter to run periodically. The sync requests &lt;strong&gt;won’t **be fulfilled **exactly **when the time period has passed, but on the closes battery efficient moment to that time. Note: A periodic sync can only be run if its auto-sync setting is ON **and&lt;/strong&gt; it’s syncable=true.&lt;/p&gt;

&lt;p&gt;A better approach to this problem will be to use &lt;a href=&quot;http://developer.android.com/google/gcm/index.html&quot;&gt;GCM&lt;/a&gt; (Google Cloud Messaging). The server can send push notification to the device(s) whenever there’s a change the client needs to know about. On the client, we request a sync manually upon receiving such message. It’s more battery efficient and we get updated as soon as our server is, without waiting for the next sync cycle.&lt;/p&gt;

&lt;h3 id=&quot;manual-sync&quot;&gt;Manual Sync&lt;/h3&gt;

&lt;p&gt;If we have our own way knowing the data has changes, or we just want to implement a simple “Refresh”/”Sync Now” button on our app, we can request a manual sync. For that, we use &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#requestSync(android.accounts.Account, java.lang.String, android.os.Bundle)&quot;&gt;requestSync&lt;/a&gt;&lt;/em&gt;(). Besides the usual &lt;em&gt;account _and _authority&lt;/em&gt;, we also pass as an argument &lt;em&gt;extras&lt;/em&gt; to specify parameters to describe a more specific request. If we have no special requests, the system will run our sync after it gathers other sync or network tasks to run at the same time, for battery efficiency. The auto-sync setting must also be ON for that to work. To override these constraints, you can use the extras:&lt;/p&gt;

&lt;p&gt;SYNC_EXTRAS_MANUAL – will force a sync, even if the auto-sync setting is OFF.
SYNC_EXTRAS_EXPEDITED – will start the sync immediately, no waiting for the system to find optimal moment for that.&lt;/p&gt;

&lt;p&gt;This function cannot override the syncable= false setting. If the sync adapter is not &lt;em&gt;syncable&lt;/em&gt;, there’s no way to run the sync.&lt;/p&gt;

&lt;h3 id=&quot;canceling&quot;&gt;Canceling&lt;/h3&gt;

&lt;p&gt;We have the option to cancel a sync request, by calling &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#cancelSync(android.accounts.Account, java.lang.String)&quot;&gt;&lt;em&gt;cancelSync&lt;/em&gt;&lt;/a&gt;(). If the sync adapter is in “Pending” state, which means it hasn’t started yet, it’ll be canceled immediately and become “Idle”. If it’s already running, the &lt;a href=&quot;http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onSyncCanceled(java.lang.Thread)&quot;&gt;&lt;em&gt;onSyncCanceled&lt;/em&gt;&lt;/a&gt;() method on the sync adapter will be called. You can use it, for example, to set a “isSyncStopped” flag that the &lt;em&gt;onPerformSync&lt;/em&gt;() will check regularly and respond to.&lt;/p&gt;

&lt;h2 id=&quot;building-the-sync-adapter&quot;&gt;Building the Sync Adapter&lt;/h2&gt;

&lt;p&gt;After learning more about the way it works, we can now build our sync adapter. We’ll do that in 4 steps:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Creating the account authenticator and content provider - the sync adapter will later authenticate with one and listens to changes of the other.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Writing the sync adapter class – where all the syncing algorithm goes.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Creating the Sync Service – under its context the sync adapter will run.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Connecting all the pieces – introduce the account authenticator and content provider to the sync adapter, and make them all work together.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;creating-the-account-authenticator-and-content-provider&quot;&gt;Creating the account authenticator and content provider&lt;/h3&gt;

&lt;p&gt;The sync adapter will access the local data, represented by a ContentProvider, and contact the server using an auth token retrieved from the app’s Authenticator. Using these mechanisms will make our lives easier and our code simpler and robust.&lt;/p&gt;

&lt;p&gt;But they &lt;strong&gt;aren’t&lt;/strong&gt; mandatory!&lt;/p&gt;

&lt;p&gt;The sync adapter requires you to **declare **an account type and a ContentProvider to be tied with it, but it doesn’t mean that you actually need to use them. For each of these, I’ll show you how to easily create a stub, among a list of reasons why you should just get the real deal.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Account Authenticator&lt;/strong&gt; is the component that handles a specific account type. It will authenticate the users with their credentials against the server, hold the auth-token retrieved from the server and will raise a login screen upon token/password invalidation. I strongly recommend writing an authenticator to your app, making it robust to all those loose ends that nobody take care of when implementing your own simple user log-in/register. This is the reason I wrote &lt;a href=&quot;http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/&quot;&gt;my last post&lt;/a&gt; about the benefits of the Account Authenticator and a step-by-step guide to create one of your own. If all that didn’t convince you, just go ahead and write a stub authenticator using this &lt;a href=&quot;http://developer.android.com/training/sync-adapters/creating-authenticator.html&quot;&gt;great guide&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;**ContentProvider **is a component that manages the access to your data. Content providers have the ability to control access from outside or inside the app, allowing you to easily and securely share data. They also has standard API to register for data changes, using &lt;a href=&quot;http://developer.android.com/reference/android/database/ContentObserver.html&quot;&gt;ContentObserver&lt;/a&gt;. You can learn more about content providers and see how to create one in &lt;a href=&quot;http://developer.android.com/guide/topics/providers/content-provider-creating.html&quot;&gt;this official guide&lt;/a&gt; or from &lt;a href=&quot;http://www.grokkingandroid.com/android-tutorial-writing-your-own-content-provider/&quot;&gt;this blog post&lt;/a&gt;. Examples for content providers: Accessing your device’s Contacts and Calendar is done by a content provider. Even for &lt;a href=&quot;http://www.any.do/&quot;&gt;Any.do&lt;/a&gt;, we recently &lt;a href=&quot;http://tech.any.do/content-provider-for-any-do/&quot;&gt;published a read only content provider&lt;/a&gt; for tasks. If all that also didn’t convince you that you need one, you can create a stub content provider using &lt;a href=&quot;http://developer.android.com/training/sync-adapters/creating-stub-provider.html&quot;&gt;this guide&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;writing-the-sync-adapter&quot;&gt;Writing the sync adapter&lt;/h3&gt;

&lt;p&gt;The sync adapter itself is a subclass of &lt;a href=&quot;http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html&quot;&gt;&lt;em&gt;AbstractThreadedSyncAdapter&lt;/em&gt;&lt;/a&gt;. The most important method there is &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/AbstractThreadedSyncAdapter.html#onPerformSync(android.accounts.Account, android.os.Bundle, java.lang.String, android.content.ContentProviderClient, android.content.SyncResult)&quot;&gt;onPerformSync&lt;/a&gt;&lt;/em&gt;(), called by the sync manager when it’s sync time. This method operates from a background thread, so no worries while doing network calls.&lt;/p&gt;

&lt;p&gt;A sync adapter can be tied to one &lt;strong&gt;account type&lt;/strong&gt; on the device, but there could be multiple users signed in to this account type. For example, you can connect with more than one Google account on your device, and the “Calendar” for both accounts will be synced to your device, using sync adapters. This method receives as an argument the current account the sync manager has requested the sync for.&lt;/p&gt;

&lt;p&gt;Let’s see an example for such class:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TvShowsSyncAdapter&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AbstractThreadedSyncAdapter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AccountManager&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mAccountManager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;TvShowsSyncAdapter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;autoInitialize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;autoInitialize&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mAccountManager&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AccountManager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onPerformSync&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Account&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Bundle&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;extras&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;authority&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ContentProviderClient&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SyncResult&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;syncResult&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nc&quot;&gt;Log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;udinic&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;onPerformSync for account[&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;]&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// Get the auth token for the current account&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;authToken&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mAccountManager&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;blockingGetAuthToken&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;AccountGeneral&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;AUTHTOKEN_TYPE_FULL_ACCESS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;ParseComServerAccessor&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parseComService&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ParseComServerAccessor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// Get shows from the remote server&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;List&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remoteTvShows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;parseComService&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getShows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;authToken&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// Get shows from the local storage&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;ArrayList&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;localTvShows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;ArrayList&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;nc&quot;&gt;Cursor&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;curTvShows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;provider&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;TvShowsContract&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;CONTENT_URI&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;curTvShows&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;curTvShows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;moveToNext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;localTvShows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;TvShow&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;fromCursor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;curTvShows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;));&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;curTvShows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// TODO See what Local shows are missing on Remote&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// TODO See what Remote shows are missing on Local&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// TODO Updating remote tv shows&lt;/span&gt;

            &lt;span class=&quot;c1&quot;&gt;// TODO Updating local tv shows&lt;/span&gt;

        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;printStackTrace&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;The sync adapter I chose to write is syncing TV shows information from the device to a server, and vice versa. I created a ContentProvider to hold the records locally, and a &lt;a href=&quot;http://parse.com/&quot;&gt;Parse.com&lt;/a&gt;account to store the records remotely.&lt;/p&gt;

&lt;p&gt;The syncing algorithm is completely under your responsibility. The sync adapter is only in charge of running your code, it has no idea how your data should be synced with the server, so it’s your job to get it right. There are sample algorithms for common sync tasks on the web, for you to “get inspired” when designing your algorithm.&lt;/p&gt;

&lt;p&gt;To communicate with our server, we need an auth token, so we first call &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/accounts/AccountManager.html#blockingGetAuthToken(android.accounts.Account, java.lang.String, boolean)&quot;&gt;blockingGetAuthToken&lt;/a&gt;&lt;/em&gt;(), which is doing the same as &lt;a href=&quot;http://developer.android.com/reference/android/accounts/AccountManager.html#getAuthToken(android.accounts.Account, java.lang.String, android.os.Bundle, android.app.Activity, android.accounts.AccountManagerCallback, android.os.Handler)&quot;&gt;&lt;em&gt;getAuthToken&lt;/em&gt;&lt;/a&gt;_() _but done synchronously, since we’re already running on a background thread. The last parameter for this method is &lt;strong&gt;notifyAuthFailue&lt;/strong&gt; and if set to “true” it will raise a notification to the user in case there was an authentication problem, such as an invalidated auth token.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/2013072203-14-47_thumb1.png&quot; alt=&quot;2013-07-22 03.14.47&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once the user click on that notification, the authenticator’s default sign in activity will show and ask him for credentials. After the user identify himself, the auth token gets renewed and the sync is working again! To learn more about invalidating tokens and showing a default sign in activity from the authenticator, see my previous &lt;a href=&quot;http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/&quot;&gt;post about account authenticators&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note: On my sample app, I built a smart re-login mechanism for my authenticator, which auto sign-in the user in case of a token invalidation. That means this problem will occur only after the token has been invalidated **and **the password was changes on the server. See the getAuthToken() method on &lt;a href=&quot;https://github.com/Udinic/SyncAdapter/blob/master/src/com/udinic/sync_adapter_example/authentication/UdinicAuthenticator.java&quot;&gt;UdinicAuthenticator &lt;/a&gt;for more information.&lt;/p&gt;

&lt;h3 id=&quot;creating-the-sync-service&quot;&gt;Creating the Sync Service&lt;/h3&gt;

&lt;p&gt;The sync adapter, as for the Account Authenticator, also needs a Service to operate in. We need to create it ourselves in order for the sync adapter to be run on the same UID (user-id) as our app. This privilege gives the sync adapter access to our app’s resources, such as the account information and ContentProvider.&lt;/p&gt;

&lt;p&gt;The Service is pretty simple and only needs to instantiate our sync adapter upon creation.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TvShowsSyncService&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Service&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sSyncAdapterLock&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TvShowsSyncAdapter&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sSyncAdapter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onCreate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kd&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sSyncAdapterLock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sSyncAdapter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;sSyncAdapter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TvShowsSyncAdapter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getApplicationContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;nd&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;IBinder&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;onBind&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;Intent&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;intent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sSyncAdapter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getSyncAdapterBinder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;connecting-the-pieces&quot;&gt;Connecting the pieces&lt;/h3&gt;

&lt;p&gt;Connecting between the sync adapter, the account authenticator and the content provider, is done using the XML definition of the sync adapter. This XML is a resource, as the strings.xml and the layout files, that’s why it’s going into the “res” folder under a folder called “xml”.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;sync-adapter&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;xmlns:android=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;http://schemas.android.com/apk/res/android&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:contentAuthority=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;com.udinic.tvshows.provider&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:accountType=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;com.udinic.sync_example&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:userVisible=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;true&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:allowParallelSyncs=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;false&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:isAlwaysSyncable=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;false&quot;&lt;/span&gt;
              &lt;span class=&quot;na&quot;&gt;android:supportsUploading=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Let’s review the attributes:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;contentAuthority&lt;/strong&gt; is the authority for our content provider. Also defined in the &amp;lt;provider&amp;gt; tag in the Android Manifest.xml, with the rest of the content provider’s attributes.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;accountType&lt;/strong&gt; is the account type that is tied with our sync adapter. It’s also defined in the authenticator’s xml, with the rest of the authenticator’s attributes.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;allowParallelSyncs&lt;/strong&gt; will allow this sync adapter to handle syncs for multiple accounts at the same time. If you use a common resource for those syncs and parallel syncs will cause problems – you can keep this setting to “false”. Furthermore, if you want to disallow adding more than one account, preventing this situations entirely, you can return an error code on the authenticator’s &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/accounts/AbstractAccountAuthenticator.html#addAccount(android.accounts.AccountAuthenticatorResponse, java.lang.String, java.lang.String, java.lang.String[], android.os.Bundle)&quot;&gt;addAccount&lt;/a&gt;&lt;/em&gt;() in such case.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;userVisible&lt;/strong&gt; will determine if the user can see our sync adapter on the device’s Settings screen.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;isAlwaysSyncable&lt;/strong&gt; sets the adapter to be syncable=true by default for every new account the user adds. This property can be override from code with &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#setIsSyncable(android.accounts.Account, java.lang.String, int)&quot;&gt;&lt;em&gt;setIsSyncable&lt;/em&gt;&lt;/a&gt;&lt;em&gt;()__.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/image_thumb4.png&quot; alt=&quot;image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;supportUploading&lt;/strong&gt; will start a sync whenever there was a change to the content provider, with a special argument that hint the sync adapter only to upload the changes. The ContentResolver.SYNC_EXTRAS_UPLOAD will be inside the &lt;em&gt;extras&lt;/em&gt; passed to the &lt;em&gt;onPerformSync&lt;/em&gt;(), and you can use it to optimize your sync adapter not to perform a full sync, but just to update your server. The content provider notifies there was a change by calling &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#notifyChange(android.net.Uri, android.database.ContentObserver, boolean)&quot;&gt;notifyChange&lt;/a&gt;(), which its 3rd argument determine if the sync will be requested for this change. That way, you can fine-tune your sync requests to the changes that really needs immediate sync to the server.&lt;/p&gt;

&lt;p&gt;A reference to the xml is sent as meta data to the sync adapter service, when declaring the service on the AndroidManifest.xml:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot; data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;service&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;android:name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;.syncadapter.TvShowsSyncService&quot;&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;android:exported=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;intent-filter&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;action&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;android:name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;android.content.SyncAdapter&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/intent-filter&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;meta-data&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;android:name=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;android.content.SyncAdapter&quot;&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;android:resource=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;@xml/sync_adapter&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/service&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Relevant permissions to ask for on the AndroidManifest.xml:&lt;/p&gt;

&lt;p&gt;WRITE_SYNC_SETTINGS – Gives us the right to add a sync adapter to the system. Mandatory.
READ_SYNC_SETTINGS – Allows us to read the sync adapter’s settings, such as &lt;em&gt;isSyncable _or _syncAutomatically&lt;/em&gt;.
READ_SYNC_STATS – Helps us get the sync state, if it’s currently syncing, pending or idle.&lt;/p&gt;

&lt;p&gt;If you want to add sync settings of your own, the kind your users can change, you can use the &lt;strong&gt;accountPreferences&lt;/strong&gt; property in the authenticator xml. You can also read about it on my &lt;a href=&quot;http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/&quot;&gt;last post&lt;/a&gt; about authenticators.&lt;/p&gt;

&lt;p&gt;Note: The sync adapter’s name, as it shows on the Settings screen, is the content provider’s name as defined in the &amp;lt;provider&amp;gt; tag in the AndroidManifest.xml.&lt;/p&gt;

&lt;h2 id=&quot;results-and-progress&quot;&gt;Results and progress&lt;/h2&gt;

&lt;h3 id=&quot;syncstatusobserver&quot;&gt;SyncStatusObserver&lt;/h3&gt;

&lt;p&gt;If you need to know what your sync adapter is up to, you can register a &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/SyncStatusObserver.html&quot;&gt;SyncStatusObserver&lt;/a&gt;&lt;/em&gt; by calling &lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#addStatusChangeListener(int, android.content.SyncStatusObserver)&quot;&gt;&lt;em&gt;addStatusChangeListener&lt;/em&gt;&lt;/a&gt;(), and removing it with &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#removeStatusChangeListener(java.lang.Object)&quot;&gt;removeStatusChangeListener&lt;/a&gt;&lt;/em&gt;(). It will trigger for **any **sync adapter status change, not just yours. Meaning, you need to check every time you get a callback the status of your sync adapter, by using &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#isSyncActive(android.accounts.Account, java.lang.String)&quot;&gt;isSyncActive&lt;/a&gt;&lt;/em&gt;() and &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/ContentResolver.html#isSyncPending(android.accounts.Account, java.lang.String)&quot;&gt;isSyncPending&lt;/a&gt;&lt;/em&gt;(). You cannot catch those events on a background thread, unless you use a Service that runs all the time, which is a bad practice and a bad idea in general. For such a case, you can just send your own broadcast intents when the sync starts or ends (you implement the sync algorithm remember?). You can also do a little more and send progress intents, helping to give the user a more visual way of the sync progress, when he’s interacting with your app. Don’t forget that sending intents has a system overhead. Don’t send a progress update intent for every 1 percent of sync progress.&lt;/p&gt;

&lt;h3 id=&quot;syncresult-and-errors&quot;&gt;SyncResult and Errors&lt;/h3&gt;

&lt;p&gt;While the sync process is running, we can update the &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/SyncResult.html&quot;&gt;SyncResult&lt;/a&gt;&lt;/em&gt; object, which is received as an argument for the &lt;em&gt;onPerformSync&lt;/em&gt;() method, the problems and statistics of the sync process. This data is used by the sync manager to determine if the sync was successful or not, and helps determine when to run the next sync, if at all. The &lt;em&gt;&lt;a href=&quot;http://developer.android.com/reference/android/content/SyncStats.html&quot;&gt;SyncStats&lt;/a&gt; _object, inside the _SyncResult&lt;/em&gt; object, holds that information as counters for the number of exceptions for each type (e.g. numAuthExceptions, numIoExceptions etc.). Depending on the type of error, soft or hard, it decides what to do. You can see which error is considered to be hard or soft be reviewing the &lt;a href=&quot;http://developer.android.com/reference/android/content/SyncStats.html&quot;&gt;SyncStats&lt;/a&gt; class.&lt;/p&gt;

&lt;p&gt;For hard errors, such as authentication exceptions, it will show an error mark on the sync adapter’s screen on the device’s Settings:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/2013072202-55-52_thumb.png&quot; alt=&quot;2013-07-22 02.55.52&quot; /&gt;&lt;/p&gt;

&lt;p&gt;For soft errors, the sync manager will run the sync again later. The time of the next run will be calculated by the sync manager using a &lt;a href=&quot;http://en.wikipedia.org/wiki/Exponential_backoff&quot;&gt;backoff algorithm&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The other statistics members, such as &lt;em&gt;numInserts&lt;/em&gt;, &lt;em&gt;numUpdates&lt;/em&gt; etc., are not saved anywhere, and merely needed to see if there was **some **progress on the sync operation. This information will help the sync manager decide what to do in case of an error (schedule another sync or wait for user action).&lt;/p&gt;

&lt;h2 id=&quot;using-the-sample-app&quot;&gt;Using the sample app&lt;/h2&gt;

&lt;p&gt;The sample app is intended to understand the concept of sync adapters. I wrote a simple app that holds a local list of TV shows and syncs them with a Parse.com server, using its REST API. The content provider is a simple provider, managing one table with 2 columns: TV show &lt;strong&gt;title&lt;/strong&gt; and release &lt;strong&gt;year&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/2013072203-30-34_thumb1.png&quot; alt=&quot;2013-07-22 03.30.34&quot; /&gt;] &lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/2013072203-30-44_thumb1.png&quot; alt=&quot;2013-07-22 03.30.44&quot; /&gt; &lt;img src=&quot;/assets/images/2013-07-24-write-your-own-android-sync-adapter/2013072203-30-48_thumb1.png&quot; alt=&quot;2013-07-22 03.30.48&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once connected, you’ll have access to all the sync adapter’s options. You can “Sync now”, change the “syncable” and “auto-sync” settings and also see the current status of the sync adapter (Pending, Syncing, Idle).&lt;/p&gt;

&lt;p&gt;If there’s no “Udinic” account logged-in, you will receive a log-in screen when pressing the “Connect” button. Removing accounts can be done from the Settings screen.&lt;/p&gt;

&lt;p&gt;The sync algorithm is very simple – it checks which TV shows are on the local list, but not on the remote list, and vice versa, then it sync the missed TV shows between the client and the server. A new TV show can be added to the local list using the “Add TV show to local” button, which randomly picks a TV show from a resource file, created by scraping Wikipedia’s “&lt;a href=&quot;http://en.wikipedia.org/wiki/List_of_American_television_series&quot;&gt;List of American television series&lt;/a&gt;” (if you’re interested, the script I created for this task can be found &lt;a href=&quot;https://gist.github.com/Udinic/6050766&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I encourage you to experiment with the settings, add shows, force syncs, remove and add accounts etc. This is the best way to really know the sync adapter and they way it works.&lt;/p&gt;

&lt;p&gt;The full source code can be found on my &lt;a href=&quot;https://github.com/Udinic/SyncAdapter&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The sample app can also be downloaded from &lt;a href=&quot;https://play.google.com/store/apps/details?id=com.udinic.sync_adapter_example_app&quot;&gt;Google Play&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;more-information&quot;&gt;More information&lt;/h2&gt;

&lt;p&gt;You can never learn enough. Follow these links to learn more:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.youtube.com/watch?v=GcNNx2zdXN4&quot;&gt;&lt;em&gt;Android Protips 3: Making apps work like magic&lt;/em&gt;&lt;/a&gt;_, by Reto Meier _– Great tips to consider when developing an app, sync adapters are among them (min. ~49). Reto explains how to implement one with stub account authenticator and content provider, and also admits its not a very documented feature :)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;a href=&quot;http://developer.android.com/training/sync-adapters/index.html&quot;&gt;Transferring Data Using Sync Adapters&lt;/a&gt;&lt;/em&gt;, on the Android Developers website – explains the steps to create a sync adapter with stub authenticator and content provider.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;&lt;a href=&quot;http://www.grokkingandroid.com/android-tutorial-writing-your-own-content-provider/&quot;&gt;Writing your own Content Provider&lt;/a&gt;, by Wolfram Rittmeyer&lt;/em&gt; – Great tutorial to write your own content provider, which you need for your sync adapter.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/&quot;&gt;Write your own Android Authenticator&lt;/a&gt;, by Me – My last post about writing your own authenticator, which you also need for your sync adapter.&lt;/p&gt;

&lt;p&gt;I hope you have found this post useful. As always – you can comment here with questions/idea/corrections.&lt;/p&gt;
</description>
				<pubDate>Wed, 24 Jul 2013 06:57:18 -0400</pubDate>
				<link>/2013/07/24/write-your-own-android-sync-adapter/</link>
				<guid isPermaLink="true">/2013/07/24/write-your-own-android-sync-adapter/</guid>
			</item>
		
	</channel>
</rss>
