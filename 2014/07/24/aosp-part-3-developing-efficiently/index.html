<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61317191-1', 'auto');
  ga('send', 'pageview');

</script>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>AOSP Part 3: Developing Efficiently</title>
	
	<meta name="author" content="Udi Cohen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">



	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/udinic">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/udinic">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
 		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/archives">Archives</a></li>
				<li><a href="/about">About</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
<!-- 	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>
 -->
	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<i class="fa fa-cube" ></i>
	</a>

</header>

<div class="text-center sidebar-title">
	UDI COHEN
</div>	


<div class="text-center sidebar-bio">
	My adventures
</div>


	<!-- <i class="fa fa-square"></i> -->

<div class="text-center sidebar-links">
	<a href="/">Home</a>
	| 
	<a href="/archives">Archives</a>	
	|
	<a href="/about">About</a>
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm twitter" href="https://twitter.com/udinic">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm github" href="https://github.com/udinic">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm linkedin" href="https://linkedin.com/in/udinic">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm rss" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3 main-content">
		<div class="page-header">
  <h1>AOSP Part 3: Developing Efficiently </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   July 
	   24th,
	   
	   2014
	 </span>
	  <div class="article_body">
	  <p><img src="/assets/images/2014-07-24-aosp-part-3-developing-efficiently/turtle-computer-cuny.jpg" alt="Turtle-Computer-CUNY" class="center-image" /></p>

<p>The AOSP codebase in big.</p>

<p>Developing on the AOSP is not as simple as writing an app, where you execute a nice gradle target and poof! you see it on the device. So far in this series, we discussed how to <a href="http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">get the AOSP code into our environment</a>, and how to <a href="http://udinic.wordpress.com/2014/06/04/aosp-part-2-build-variants/">build this code into a sweet flashable Android image files</a>. We can now fill in the missing piece – how to <strong>efficiently</strong> develop for such an enormous system.</p>

<p>In this post, I will cover:</p>

<ul>
  <li>
    <p>Properly importing an AOSP repository into your source control</p>
  </li>
  <li>
    <p>Use better ways to build modules and deploy to the device</p>
  </li>
  <li>
    <p>Writing scripts for faster development process</p>
  </li>
</ul>

<p>I’ll use Git and Bash commands that you may not know, but can definitely search and learn as we go. You can also use this <a href="http://linuxconfig.org/bash-scripting-tutorial">simple Bash scripting tutorial</a> to get started.</p>

<!--break-->

<h2 id="versioning-our-manifest">Versioning our manifest</h2>

<p>Before changing any repository on the manifest, I’ll make a small change on the manifest I worked with on my previous posts. The manifest was based on the master branch on Google’s git server. I want my manifest, and my entire AOSP system, to be based on a specific Android version, not the master branch. This will give me more control when new features are coming out to Google’s repository, and I’ll need to choose to migrate those changes into my system. It’s a best practice to avoid syncing new changes before they’ve been tested properly.</p>

<p>To do that, I’ll create a new folder and initialize the repo for the android version tag that I want, in this case - Android 4.4.3_r1.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>tmp_folder
<span class="nv">$ </span>repo init <span class="nt">-u</span> https://android.googlesource.com/platform/manifest <span class="nt">-b</span> android-4.4.3_r1</code></pre></figure>

<p>Inside this folder, the <em>.repo/manifest.xml</em> file is the manifest file relevant for this version. We’ll merge that manifest with the one I currently have. You can take a look at the <a href="https://github.com/Udinic/ucmod_manifest/commit/caf94dfae301fc5fc4a0f6fa6b09e1ae8b902e9e">commit that I made</a> to see the changes, which are basically just taking all the projects definition from the android-4.4.3_r1 tagged manifest, and adding my “udinic” remote.</p>

<p>The merged manifest is the one we’ll start using from now on. I created a separate branch for the updated manifest (not to interfere with the examples on my last posts), called “dev_branch”. Now I’ll re-initialize my working dir with the new branch and sync it, to get the latest changes from the android 4.4.3 version.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> &lt;working <span class="nb">dir</span><span class="o">&gt;</span>
<span class="nv">$ </span>repo init <span class="nt">-u</span> git@github.com:Udinic/ucmod_manifest.git <span class="nt">-b</span> dev_branch
<span class="nv">$ </span>repo <span class="nb">sync</span></code></pre></figure>

<p>Note: This is the exact procedure you’ll need to do to your manifest, when updating your AOSP system with a new version from Google’s servers. Meaning - if your ROM is based on Android 4.4.2, and now Android 4.4.4 came out, that’s the first step you need to do in order to apply those updates on your codebase. If there’ll be enough requests - I’ll post a complete guide for this process.</p>

<p>Now that we got that out of the way, let’s move on to do some real changes:</p>

<h2 id="bringin-it-home">Bringin’ it home</h2>

<p>Our first step – being able to “edit” an AOSP repository. We need to push an existing AOSP repository to our own source control, so we can push new changes. Basically - making it “our own”.</p>

<h3 id="copy-a-repository-to-my-github-account">Copy a repository to my Github account</h3>

<p>The first repository we want to make changes to, is the <em>frameworks/base</em> project. This project contains the entire Android framework code, with all the UI elements you see on your screen (Notification bar, Navigation Bar etc.).</p>

<p>We first need to create a new repository on the Github account that hosts our repositories; we’ll call it “ucmod_frameworks_base”. I used my account on Github, but you can use BitBucket or any other source control that you’d like, as long as you’re using Git.</p>

<p>After doing that - Let’s get some code inside.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> &lt;working <span class="nb">dir</span><span class="o">&gt;</span>/frameworks/base
<span class="nv">$ </span>git status</code></pre></figure>

<p>HEAD detached at 36e356c
nothing to commit, working directory clean</p>

<p>Running <em>git status</em> inside that folder is showing that we’re currently on “detached HEAD mode”. This means that we’re aren’t standing on any branch for this repository, and need to checkout a branch before being able to commit anything. This is a safe state, helping to avoid committing changes that we may not want to commit. The current checked-out revision for the repository, is the one stated on the manifest file for this specific project. In our case - the one that’s tagged with the android-4.4.3_r1 tag. Before we can push the frameworks/base code, we need to create a branch. This will be our “development branch”, from which we’ll branch out and merge back in when developing.</p>

<p>A few words on “development branches” in general - some developers/companies prefer to use the “master” branch as a development branch, and some prefer using a separate branch, from which all feature branches will be created and merged back into after the work on them was done. In that case, the master branch can be used to hold the most stable version or even not be used at all. There are other options of course, each with its own pros/cons, and your decision should depend on the project’s size, architecture, team size and more.</p>

<p>My development branch will be called udi-dev. That’s how I’m creating and pushing it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>git checkout <span class="nt">-b</span> udi-dev
<span class="nv">$ </span>git remote add udinic git@github.com:Udinic/ucmod_frameworks_base.git
<span class="nv">$ </span>git push udinic udi-dev</code></pre></figure>

<p>These commands will:</p>

<ul>
  <li>
    <p>Create a new branch called udi-dev, from the existing revision.</p>
  </li>
  <li>
    <p>Add a new remote called “udinic” to point the repository I just created under my Github account.</p>
  </li>
  <li>
    <p>Push my development branch into the new remote.</p>
  </li>
</ul>

<p>This process will take a while, since this is a big repository. In the meantime, we can update our manifest to point the frameworks/base project to the new repository.</p>

<h3 id="updating-the-manifest">Updating the manifest</h3>

<p>We’ll go to the dev_branch branch on the manifest project, and edit the frameworks/base project from:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project</span> <span class="na">path=</span><span class="s">"frameworks/base"</span> <span class="na">name=</span><span class="s">"platform/frameworks/base"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>to be</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project</span> <span class="na">path=</span><span class="s">"frameworks/base"</span> <span class="na">name=</span><span class="s">"ucmod_frameworks_base"</span> <span class="na">remote=</span><span class="s">"udinic"</span> <span class="na">revision=</span><span class="s">"udi-dev"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>The new project definition will take the <em>ucmod_frameworks_base</em> repository from the <em>udinic</em> remote, in the “udi-dev” revision - the development branch we created earlier for this project.</p>

<h2 id="making-some-changes">Making some changes</h2>

<p>To start coding, I’ll open the entire AOSP codebase on my Android Studio. Yes, it’s possible and there are even scripts in the AOSP system to help us do that.</p>

<h3 id="opening-the-codebase-in-the-ide">Opening the codebase in the IDE</h3>

<p>I use Android Studio and I’m sure many of you do too.</p>

<p>I’ve found <a href="https://shuhaowu.com/blog/setting_up_intellij_with_aosp_development.html">these great instructions</a> very helpful for opening the AOSP codebase in Android Studio. They are meant for opening the CyanogenMod codebase, but it’s using scripts that are available as part of the AOSP. As I mentioned in <a href="https://plus.google.com/113156787654356910368/posts/Urt2uFHgm7V">one of my Google+ posts</a>, I did do something different than the original instructions, so you’re welcome to use my advice when using these instructions.</p>

<p>The codebase is big and might take a couple of mins. to index when first opening it. Usually it works pretty smoothly after that. If you feel it’s really slow to operate - turn on the “Power save mode” from the “File” menu. This will turn off features like auto-compilation, auto-import and other stuff that could hang when working on large codebases.</p>

<h3 id="workin-workin">Workin’ Workin’</h3>

<p>As the first change to our new ROM, I wanted to pick something simple, yet visual.</p>

<p>There’s a small text item on the status bar that appears whenever there’s no service at the moment, letting us know we can only make emergency calls. This text item is not shown at all in all other cases. Here’s how it looks like when it does:</p>

<p><img src="/assets/images/2014-07-24-aosp-part-3-developing-efficiently/wpid-emergency-before.png" alt="wpid-emercency-before.png" /></p>

<p>We can use that text item to put something of our own, when not used for this purpose. For example, I thought it could be a nice place to put a small branding text, such as my website. But in order to do that - I need to figure out where is it being created. I used Hierarchy Viewer to locate the TextView and after a short investigation - found it in the PhoneStatusBar.java file, in the makeStatusBarView() method. Here’s a snippet of how it’s initialized:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isAPhone</span> <span class="o">=</span> <span class="n">mNetworkController</span><span class="o">.</span><span class="na">hasVoiceCallingFeature</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">isAPhone</span><span class="o">)</span> <span class="o">{</span>
 <span class="n">mEmergencyCallLabel</span> <span class="o">=</span>
 <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span> <span class="n">mStatusBarWindow</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">emergency_calls_only</span><span class="o">);</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">mEmergencyCallLabel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">mNetworkController</span><span class="o">.</span><span class="na">addEmergencyLabelView</span><span class="o">(</span><span class="n">mEmergencyCallLabel</span><span class="o">);</span>
   <span class="o">...</span>
 <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The first thing we notice - it’s shown only if the current device has a voice calling feature. A Wifi only tablet will never show this text item. We’ll modify the code to show the text view, with the text I want, and do that for every device.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre> <span class="k">if</span> <span class="o">(</span><span class="n">isAPhone</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">mEmergencyCallLabel</span> <span class="o">=</span>
     <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span> <span class="n">mStatusBarWindow</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">emergency_calls_only</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">mEmergencyCallLabel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">mEmergencyCallLabel</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
     <span class="n">mEmergencyCallLabel</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"http://www.udinic.com"</span><span class="o">);</span>
      <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
   <span class="n">mEmergencyCallLabel</span> <span class="o">=</span>
     <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span> <span class="n">mStatusBarWindow</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">emergency_calls_only</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mEmergencyCallLabel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">mEmergencyCallLabel</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
     <span class="n">mEmergencyCallLabel</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"http://www.udinic.com"</span><span class="o">);</span>
   <span class="o">}</span>
 <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Whether we’re running on a phone or a wifi only tablet, we will always show the URL to my website in the status bar. This is not a robust solution, or even a well-written one, but I’m keeping it that way for simplicity.</p>

<h3 id="building">Building</h3>

<p>Remember how we bring those changes to the device? If you read my <a href="http://udinic.wordpress.com/2014/06/04/aosp-part-2-build-variants/">last post</a>, you’d know already how to build our codebase into something we can flash on a device. Go refresh your memory if you don’t remember.</p>

<p>I’ll test the code on my Wifi only Nexus 7 2013, so I’ll run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">source </span>build/envsetup.sh
<span class="nv">$ </span>lunch full_flo-eng
<span class="nv">$ </span>make <span class="nt">-j16</span></code></pre></figure>

<p>and flash</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>adb reboot bootloader  // Put the device <span class="k">in </span>fastboot mode
<span class="nv">$ </span>fastboot flashall <span class="nt">-w</span>      // Flashes the images created</code></pre></figure>

<p>The result:</p>

<p><img src="/assets/images/2014-07-24-aosp-part-3-developing-efficiently/wpid-ucmod_after-37.png" alt="wpid-ucmod_after-3.png" class="center-image" /></p>

<h2 id="rapid-development-on-aosp">Rapid development on AOSP</h2>

<p>That was nice huh?</p>

<p>But you know what? Now that I look at it, I think that I might go with a shorter text, something like “UdinicMod”. But wait a second! I just spent a few minutes to get <strong>this</strong> working, do we really need to run <em>make</em> and flash it for every simple change we make?!</p>

<p>Well..no.</p>

<p>Luckily, we have options to make the process more efficient and much shorter. To learn how, we first need to understand how things are structured within the build system.</p>

<h3 id="modules-in-the-aosp-system">Modules in the AOSP system</h3>

<p>Every project in our codebase can introduce one or more modules. These can be apps, libraries, services and more. Every module is declared in the Android.mk file, located inside the project’s folder, along with all its source files. Every Android.mk file can declare one or more modules. The Android.mk file contain all the instructions needed to build its modules. When running <em>make -j16</em>, the build system is basically invoking all the Android.mk files in the system, relevant to the selected build variant and with respect for dependencies of course.</p>

<p>Under the framewoks/base folder we have a few modules declared in separate Android.mk files:</p>

<ul>
  <li>
    <p>In the <em>frameworks/base/Android.mk</em> file, we have the “framework” and “framework2” modules (separated to overcome the <a href="http://stackoverflow.com/questions/15209831/unable-to-execute-dex-method-id-not-in-0-0xffff-65536">Dex’s 64K methods limitation</a>) among other smaller modules.</p>
  </li>
  <li>
    <p>Under the <em>frameworks/base/services/java</em> we’ll find the “services” module, containing system services; Services such as media, location, connectivity, input and more.</p>
  </li>
  <li>
    <p>Under the the <em>frameworks/base/packages/SystemUI</em> we’ll find the “SystemUI” module, which is an apk with the System’s UI, including the status bar, navigation bar and more.</p>
  </li>
  <li>
    <p>Under <em>frameworks/base/core/res</em> lays the frameworks-res module, containing framework resource files such as strings, drawables, dimensions and more.</p>
  </li>
  <li>
    <p>Many more… Just run: <em>find . -name “Android.mk”</em> inside the framework/base folder to see all of them.</p>
  </li>
</ul>

<p>The change I made earlier is part of the SystemUI module. Let’s continue and see how can we build just that one.</p>

<h3 id="building-specificmodules">Building specific modules</h3>

<p>Since we usually work on a single module, we basically need to build just that. Running <em>make -j16</em> will try to build all the projects in the system. Since the vast majority of them haven’t changed - nothing will be built. Since there are so many of them, it’ll take time to finish “building” everything.</p>

<p>When running the <em>source build/envsetup.sh</em> command, we add some useful function for our day-to-day development. Here is a list of functions coming with the AOSP (seeing by the command <em>hmm</em>):</p>

<ul>
  <li>lunch: lunch &lt;product_name&gt;-&lt;build_variant&gt;</li>
  <li>tapas: tapas [<App1> <App2> ...] [arm|x86|mips|armv5] [eng|userdebug|user]</App2></App1></li>
  <li>croot: Changes directory to the top of the tree.</li>
  <li>m: Makes from the top of the tree.</li>
  <li>mm: Builds all of the modules in the current directory, but not their dependencies.</li>
  <li>mmm: Builds all of the modules in the supplied directories, but not their dependencies.</li>
  <li>mma: Builds all of the modules in the current directory, and their dependencies.</li>
  <li>mmma: Builds all of the modules in the supplied directories, and their dependencies.</li>
  <li>cgrep: Greps on all local C/C++ files.</li>
  <li>jgrep: Greps on all local Java files.</li>
  <li>resgrep: Greps on all local res/*.xml files.</li>
  <li>godir: Go to the directory containing a file.</li>
</ul>

<p>If the description is not enough, you can always see the source code for those functions. The most helpful functions, in my mind, are the <em>croot</em>, <em>lunch</em> and the <em>mm</em>/<em>mmm</em> functions.</p>

<p>The <em>mm</em> function will build the project that we’re currently standing in. The mmm function will take a list of projects folders to build, and build them. Here are some examples:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> &lt;working directory&gt;
<span class="nv">$ </span>mmm packages/apps/Email        // Build the Email app
<span class="nv">$ </span><span class="nb">cd </span>packages
<span class="nv">$ </span>mmm apps/Email apps/Music    // Build the Email and Music apps
<span class="nv">$ </span><span class="nb">cd </span>apps/Email
<span class="nv">$ </span>mm                                                   // Build the Email app</code></pre></figure>

<p>Note: Sending more than one path to the <em>mmm</em> function is available only when running on Bash. I’m using Zsh (along with the highly recommended <a href="http://ohmyz.sh/">Oh-my-Zsh</a>) and it’s not working for me, due to the way the function works internally. As a workaround, you can run “mmm path1 &amp;&amp; mmm path2”.</p>

<p>The <em>mma</em>/<em>mmma</em> functions are doing the same, only they are also building the depended modules. Since there’s a need to create some sort of dependency graph for those, in order to see who depends on what, these functions are naturally slower than the <em>mm</em>/<em>mmm</em> functions. In most cases you’ll be working on a single module, therefore there’s no need to search for its depended modules. Even if there are dependencies you need to build, you would probably know about them and can build them by yourself using the <em>mm</em>/<em>mmm</em> functions, instead of wasting everyone’s time building a dependency graph.</p>

<p>As mentioned earlier, if the module hasn’t changed - nothing will be done. But we do have the option to rebuild, using the -B switch. For example:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mmm packages/apps/Email <span class="nt">-B</span></code></pre></figure>

<p>Since our new feature is part of the SystemUI module, we need to run the following command in order to build it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mmm frameworks/base/packages/SystemUI</code></pre></figure>

<p>So now we have the updated module, but we still need to transfer that module into the device somehow. Let’s review our options for that too.</p>

<h3 id="updating-the-device">Updating the device</h3>

<p>Want to get those freshly built modules into your device? Here are 2 ways for you to do that:</p>

<h4 id="recreating-the-system-image-files">Recreating the system image files</h4>

<p>The <em>make -j16</em> command has given us several image files, which we flashed using the notorious <em>fastboot flashall</em> command. Since we’re building only specific modules, we need another way to generate those image files. For that, we have another make target, called “snod” (= “System no dependencies”). When running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make snod</code></pre></figure>

<p>We’re re-creating the system image file from the modules that are already built. This command won’t build anything, just create the image file. After that, we can flash using the regular <em>fastboot flashall</em> command.</p>

<p>This command is much faster than running the regular <em>make -j16</em>, with less than a minute of runtime (in compare to a few minutes).</p>

<h4 id="syncing-the-changes-directly">Syncing the changes directly</h4>

<p>The previous method is faster than running the full make, but we still have the overhead of the image flashing, which also takes time. There’s an even better way than that, by syncing the changes directly to the device. No flashing is required and not even a full restart of the device!</p>

<p>To do that, we’ll simply run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>adb <span class="nb">sync</span></code></pre></figure>

<p>What it does, is checking what are the modules that were changed, in compare to what’s already on the device, and copies them.</p>

<p>If you’re not working on any of the framework modules, you don’t need to do anything after running the <em>adb sync</em> command, and the device should run your code without a problem. If you did make some changes to the framework modules, you need to reload them because they are in use. You <em>can</em> restart the device, but you can simply just restart the Shell, which restarts the framework and other operation system components. Restarting the Shell is quicker than restarting the device and in most cases - that’s all you’ll ever need.</p>

<p>Since we’re just copying files and not flashing an entire image, and we also get away from doing a full restart to the device, this process is <strong>way</strong> shorter.</p>

<p>How short you ask?</p>

<p>The regular <em>make -j16</em> and flash process takes around <strong>5 minutes</strong> to complete on my machine.
The <em>make snod</em> and flash process takes around <strong>2 minutes.</strong>
The <em>adb sync</em> process takes <strong>less than 30 seconds</strong>!</p>

<p>So to recap that, we can do our change on the <em>PhoneStatusBar.java</em> file and run the following commands to update the device:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mmm frameworks/base/packages/SystemUI        // build the SystemUI module
<span class="nv">$ </span>adb <span class="nb">sync</span>              // Sync the updated module to the device
<span class="nv">$ </span>adb shell stop     // Stopping the shell
<span class="nv">$ </span>adb shell start    // Starting the shell again</code></pre></figure>

<p>And all that will take less than 30 seconds!</p>

<p>YRMV.</p>

<h2 id="automate-our-lives">Automate our lives</h2>

<p>After we saw there are <strong>faster</strong> ways to develop on AOSP, we can now create some helper functions to help us do that <strong>easier</strong>.</p>

<p>I got inspired by some of the functions in the <a href="https://github.com/CyanogenMod/android_build/blob/cm-11.0/envsetup.sh">CyanogenMod’s envsetup.sh script</a>, especially the <em>dopush</em> function, which accepts another build function and pushes the changes to the device. For example:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>dopush mmm packages/apps/Music</code></pre></figure>

<p>I ported it into my Envsetup.sh file, and modified the way it works a little. This is my implementation:</p>

<ul>
  <li>
    <p>Check that a device is connected</p>
  </li>
  <li>
    <p>Run the function that we got as parameter (e.g. “mmm packages/apps/Music”)</p>
  </li>
  <li>
    <p>Run_ adb sync_ to sync all the built modules</p>
  </li>
  <li>
    <p>If one of those modules is a framework one - restart the shell</p>
  </li>
  <li>
    <p>Print a summery with the number of synced files</p>
  </li>
</ul>

<p>I also defined aliases for faster workflow:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">mmp</span><span class="o">=</span><span class="s1">'dopush mm'</span>
<span class="nb">alias </span><span class="nv">mmmp</span><span class="o">=</span><span class="s1">'dopush mmm'</span></code></pre></figure>

<p>Now I can simply run this, to build the module and push to the device:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mmmp packages/apps/Music</code></pre></figure>

<p>Since sometimes I change several framework modules at a time, I created an alias to help me build them all, and push the changes to the device.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">mfwk</span><span class="o">=</span><span class="s1">'mmm frameworks/base/core/res frameworks/base frameworks/base/services/java frameworks/base/packages/SystemUI'</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">mfwkp</span><span class="o">=</span><span class="s1">'dopush mmm frameworks/base/core/res frameworks/base frameworks/base/services/java frameworks/base/packages/SystemUI'</span></code></pre></figure>

<p>Here I’m building all the framework modules I introduces earlier, and after that I push them to the device. The <em>dopush</em> script will restart the shell in order for my changes to apply.</p>

<p>The changes were <a href="https://github.com/Udinic/ucmode_build/commit/32c3a1af3a99c0c8220f1d2c4a66986caca83935">committed</a> to the envsetup.sh in the <em>build</em> project of udinicmod. That project was also added to my github in the same way as I did for the frameworks/base project. If you have other commands that you find yourself writing over and over again, you can add new alias or scripts to your envsetup.sh file too. If you feel other can use them - you’re more than welcome to share :)</p>

<h2 id="tips">Tips</h2>

<p>Some random tips you can use:</p>

<h3 id="creatinga-feature-branch-on-multiple-projects">Creating a feature branch on multiple projects</h3>

<p>If your feature requires changes on more than one project, you can use the <em>repo start</em> command to start a feature branch on all of them at once. The syntax is:</p>

<p><em>repo start feature_branch_name PROJ1_name [,PROJ2_name, PROJ2_name…]</em></p>

<p>The project name is the same name used in the manifest file. For example:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>repo start brand_ucmod ucmod_frameworks_base</code></pre></figure>

<p>The <em>repo start</em> is almost identical to just running <em>git checkout -b branch_name</em>, but it also <a href="http://stackoverflow.com/questions/15014345/difference-between-repo-start-and-git-checkout-b/23642769#23642769">set some properties</a> needed by the <em>git upload</em> command, which is relevant if you’re using Gerrit for code review. Gerrit is out of the scope of this post.</p>

<h3 id="playing-with-the-manifest-file">Playing with the manifest file</h3>

<p>If you need to edit your manifest file, whether for adding new repositories or editing existing ones, you have 2 options:</p>

<ol>
  <li>
    <p>Clone your own copy of the manifest project, edit it, commit+push and then repo sync your AOSP workspace.</p>
  </li>
  <li>
    <p>Work on the clone you already have inside your working directory, inside _<working dir="">/.repo/manifests_</working></p>
  </li>
</ol>

<p>Using the second option will allow you to easily test changes you make, without the need to commit and push every time. As long as you stay on the <em>default</em> branch, which is the initialized branch that the <em>repo init</em> command set. If you change branches, to apply your change to a specific branch, you can reset to the default branch by running the <em>repo init</em> command again.</p>

<h2 id="conclusion">Conclusion</h2>

<p>The purpose of this 3-part series was to show that AOSP development is not hard. It does require learning to use new tools and operate a different build system, but it’s not really complicated.</p>

<p>Getting to know the AOSP allows you to know more about how Android work, and developing on it will give you the freedom to take a adjust Android as you want it, to answer all your needs. The possibilities are endless, just think what you really need and work on that. You can also contribute directly to the <a href="https://source.android.com/source/contributing.html">AOSP project</a> or to other open source AOSP forks, such as the popular <a href="http://www.cyanogenmod.org/">CyanogenMod</a>. You feature could get large exposure and many users could benefit from it.</p>

<p>I hope things were clear enough to understand. Questions and suggestions are always welcome on the comments section.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Android-ref">
					Android</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#AOSP-ref">
					AOSP</span>
					
				</a></li>
			
		  
		</ul>
		  
		
		<ul class="tag_box list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#.repo/manifests-ref">
					.repo/manifests
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#adb shell start-ref">
					adb shell start
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#adb shell stop-ref">
					adb shell stop
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#adb sync-ref">
					adb sync
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Android ROM-ref">
					Android ROM
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#android studio-ref">
					android studio
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#android.mk-ref">
					android.mk
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#AOSP-ref">
					AOSP
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#aosp module-ref">
					aosp module
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#build fast-ref">
					build fast
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#build/envsetup.sh-ref">
					build/envsetup.sh
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#croot-ref">
					croot
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#cyanogenmod-ref">
					cyanogenmod
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#detached head-ref">
					detached head
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#development branch-ref">
					development branch
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#dopush-ref">
					dopush
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#efficient development-ref">
					efficient development
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#emergency calls only-ref">
					emergency calls only
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#emergency_calls_only-ref">
					emergency_calls_only
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#envsetup-ref">
					envsetup
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fast-ref">
					fast
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#framework-ref">
					framework
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#framework2-ref">
					framework2
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#frameworks/base-ref">
					frameworks/base
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#frameworks/base/packages/SystemUI-ref">
					frameworks/base/packages/SystemUI
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#frameworks/base/services/java-ref">
					frameworks/base/services/java
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#git add remote-ref">
					git add remote
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#git checkout HEAD~0-ref">
					git checkout HEAD~0
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#github-ref">
					github
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#hierarchy viewer-ref">
					hierarchy viewer
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#lunch-ref">
					lunch
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make -j16-ref">
					make -j16
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make snod-ref">
					make snod
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#makeStatusBarView-ref">
					makeStatusBarView
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#manifest-ref">
					manifest
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mfwk-ref">
					mfwk
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mfwkp-ref">
					mfwkp
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mm-ref">
					mm
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mma-ref">
					mma
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mmm-ref">
					mmm
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mmma-ref">
					mmma
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mmmp-ref">
					mmmp
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#mmp-ref">
					mmp
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#navigation bar-ref">
					navigation bar
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#PhoneStatusBar-ref">
					PhoneStatusBar
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#platform_frameworks_base-ref">
					platform_frameworks_base
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#repo-ref">
					repo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#repo init-ref">
					repo init
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#repo start-ref">
					repo start
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#repo sync-ref">
					repo sync
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#status bar-ref">
					status bar
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#system no dependencies-ref">
					system no dependencies
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#systemui-ref">
					systemui
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#udinicmod-ref">
					udinicmod
					
					</a>
				</li>
			
		  
		  
		</ul>
		  


	<div align="center" class="author-container">
		<figure class="author-img-post">
			<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a" class="img-circle author-image" />			
		</figure>
        <h4 class="section-title">Written by Udi Cohen</h4>
	</div>
	<div class="share-container">					
      <section class="share" align="center">
        <p class="section-title">Share this post:</p>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=AOSP Part 3: Developing Efficiently&via=udinic"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" 
           onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+window.location.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm reddit"
           onclick="window.open('http://www.reddit.com/submit?url='+window.location.href+'&title=AOSP Part 3: Developing Efficiently', 'reddit-share', 'width=580,height=530');return false;">
          <i class="fa fa-reddit fa-lg"></i>
          Reddit
        </a>
      </section>

    </div>

    <!-- <div class="clearfix"></div> -->

	<!-- <hr> -->
	
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'udinic-blog';
    var disqus_identifier = '/2014/07/24/aosp-part-3-developing-efficiently/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	</div>
	








</article>
<div class="clearfix"></div>



		<footer>
			<p>
				&copy; 2025 Udi Cohen with Jekyll. Theme: Customized (based of <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek).
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

