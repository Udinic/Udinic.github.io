<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61317191-1', 'auto');
  ga('send', 'pageview');

</script>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>AOSP Part 2: Build variants</title>
	
	<meta name="author" content="Udi Cohen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">



	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/udinic">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/udinic">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
 		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/archives">Archives</a></li>
				<li><a href="/about">About</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
<!-- 	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>
 -->
	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<i class="fa fa-cube" ></i>
	</a>

</header>

<div class="text-center sidebar-title">
	UDI COHEN
</div>	


<div class="text-center sidebar-bio">
	My adventures
</div>


	<!-- <i class="fa fa-square"></i> -->

<div class="text-center sidebar-links">
	<a href="/">Home</a>
	| 
	<a href="/archives">Archives</a>	
	|
	<a href="/about">About</a>
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm twitter" href="https://twitter.com/udinic">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm github" href="https://github.com/udinic">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm linkedin" href="https://linkedin.com/in/udinic">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm rss" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3 main-content">
		<div class="page-header">
  <h1>AOSP Part 2: Build variants </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   June 
	   4th,
	   
	   2014
	 </span>
	  <div class="article_body">
	  <p>On the <a href="http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">previous post</a>, we got the AOSP code into our environment and learned how that process works. The _repo _tool and the Manifest project goes hand-in-hand, managing the 200+ git repositories, all part of the AOSP.</p>

<p>Now that we have all the code locally, we need to get all those lines of code into a nice package we can eventually install on a device. The nice guys in Google brought us some nice utilities to help with that. To initialize your environment with those new functions and environment variables, you need to run the command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">source</span> &lt;working <span class="nb">dir</span><span class="o">&gt;</span>/build/envsetup.sh</code></pre></figure>

<p>Note: I’m using Mac OS with “<a href="http://ohmyz.sh/">oh-my-zsh</a>” and “zsh” as my default shell. When running this command from a shell other than “bash”, you’ll get a warning that only bash is supported. From my experience, I can tell that I never ran into a problem. If you know otherwise - let me know, otherwise - I highly recommend this configuration regardless of AOSP work.</p>

<p>Now, we can get this party started..</p>

<!--break-->

<h2 id="build-targets">Build targets</h2>

<p>There are several devices we can build our new Android ROM for (<a href="http://droidlessons.com/what-are-roms-for-android/">remember what ROM is</a>?), with different feature combinations and build types that we can use. In order to pick the desired configuration, we’ll use <em>lunch</em>. The <em>lunch</em> command can take the configuration name as an argument, or picked by the user from a list. A configuration name is structured this way:</p>

<p>PRODUCT-BUILDTYPE</p>

<p><strong>PRODUCT</strong> - This part describes the set of modules to be included, among other configurations. We can include only some of the packages in the system, or all of them, depending on the “flavor” we want our new ROM to be. A “package”, for this matter, can be an app, a system component, sounds, locales, fonts or even just a regular files that are copied to the final product. We can also set different system properties for a specific product. There are several predefined products we can use:</p>

<p>generic - default set of packages.</p>

<p><em>full</em> - a full set of packages, with most necessary apps and all locales</p>

<p><em>aosp</em> - Basically inherits everything from <em>full</em>.</p>

<p>sdk - packages needed to build the SDK. I’ll elaborate about the SDK on a separate post.</p>

<p>There are also sub-products for specific uses. For instance, you can have <em>full_flo</em> to build the full product for the Nexus 7 (codename “flo”), providing you have the necessary drivers (more on that later). To see what’s included in each product, check the .mk files under &lt;working dir&gt;/build/target/product and also under /device/&lt;vendor&gt;/&lt;device codename&gt;.</p>

<p><strong>BUILDTYPE</strong> - Selects the modules to install and set some default settings or behaviors of the product. Each variant can accept only modules who set, in their Android.mk file, the LOCAL_MODULE_TAGS to at least one of the tags it approves (tag examples: <em>debug</em>, <em>samples</em>, <em>tests</em> and more) . The valid build types are:</p>

<p><em>eng</em> - this variant will have some development tools and predefined settings that developers need (e.g. USB debugging enabled).</p>

<p><em>user</em> - this is the variant for a product that suppose to go out to the users. Will use only modules that the end-user will need and more restricted settings.</p>

<p><em>userdebug</em> - A combination of the <em>user</em> and <em>eng</em> variants. It’s intended for users testing your environment, but not developing it.</p>

<p>You can see in more detail the different handling for these variants in the &lt;working dir&gt;/build/core/main.mk file, by following the use of the TARGET_BUILD_VARIANT env variable.</p>

<p>After selecting our preferred product and build variant, we can apply it using the <em>lunch</em> command. For this demonstration, I want to run my new ROM on an emulator and have access to every advanced feature available. For that, I’ll use the “full-eng” configuration and I’ll apply it by running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>lunch full-eng</code></pre></figure>

<h2 id="build-flash-able-images">Build flash-able images</h2>

<p>The basic build artifacts are system images, one for each partition on the device. To build our images, we need to use the <em>make</em> command. To build my ROM on my computer, I’ll use this command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-j16</span></code></pre></figure>

<p>The <em>-jN</em> switch is defining the amount of threads to use when making the project. That’s a standard “GNU make” switch, not unique to AOSP builds. To get the maximum out of your machine, the recommended value for N is CPU_cores*2, so in a single quad-core CPU machine, you should probably use <em>N=8</em>, but you can try and play with the values to get the most out of your machine. My Macbook Pro has one quad-core CPU with Hyper-Threading, meaning it can run 2 threads simultaneously on each core, providing 8 “virtual” cores. I use mostly N=16 and sometimes N=8, depends if I’m still working on the laptop while building.</p>

<p>The build process is long, could take anywhere between 30mins to 3 hrs. We’ll talk more about time comparisons and performance boosting later on. If you need something to do while it’s building, I can recommend watching my new favorite TV show “Rick and Morty”, it’s a combination of “Familty Guy” and “Back to the Future” but also cleaver as “South Park”. You can <a href="http://video.adultswim.com/rick-and-morty/">stream it for free from their official website</a> and it works smoothly even if using <em>make -j16 _(tested it myself!)</em>._</p>

<p>After the process is complete, the emulator’s path is automatically added to your terminal’s PATH, meaning we can start it by running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>emulator</code></pre></figure>

<p>To check that I’m looking at the image that I just built, I’ll go to the “About Phone” screen and check the “Build Number”.</p>

<p><img src="/assets/images/2014-06-04-aosp-part-2-build-variants/wpid-screen-shot-2014-05-22-at-1-36-15-am23.png" alt="" /></p>

<p>I can see the build configuration that I selected - “full-eng”, and my name as the user who built it. I can also see the date/time of the build and that I used the default test key_ _to sign all the modules (which, of course, needs to be changes before releasing). Check the _<working dir="">/build/core/version_defaults.mk_ file to see how the build number is formatted.</working></p>

<p>Seeing it runs on an emulator is nice, seeing an actual device running our sweet new ROM - even better.</p>

<h2 id="building-for-actual-devices">Building for actual devices</h2>

<p>Let’s start with an important fact - Every device needs to have its <strong>own build</strong> of our ROM.</p>

<p>You cannot take a build intended for Nexus 7 and flash it on a Galaxy Note 8, mainly because different devices need different drivers. So, the first step we need to do - importing the device’s drivers into our system.</p>

<h3 id="drivers">Drivers</h3>

<p>Acquiring device drivers is tricky. Not all manufacturers are willing to give away their precious drivers. They don’t want brats like you creating your own OS for their hardware, beyond their control. They do this mainly for commercial/business reasons (how else can they put bloatware on your device?). That’s why you can’t simply build KitKat for, let’s say, Samsung Galaxy S3. All Google sponsored devices, called the “Nexus series”, have their drivers <a href="https://developers.google.com/android/nexus/drivers">available for free</a>.</p>

<p>Every set of drivers binaries will probably have its own installation process. For the Nexus drivers, we get an extractable file that we need to run on the root of the working directory, and part of the process will be to accept the licensing agreement. After that - the _<working dir="">/vendor_ folder will get a little heavier. Doing the above for the Nexus 7 Wifi 2013 model (Codename “flo”), will produce the following new folders:</working></p>

<p>&lt;working dir&gt;/vendor/asus/flo</p>

<p>&lt;working dir&gt;/vendor/broadcom/flo</p>

<p>&lt;working dir&gt;/vendor/qcom/flo</p>

<p>Inside these folders, we’ll find binary files and .mk files. It’s best to clean the build environment after extracting new drivers in the system. Use:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">make clean
      or
make clobber <span class="c"># Both are basically the same</span></code></pre></figure>

<h3 id="building">Building</h3>

<p>In order to create a build for our device, we need to initialize the build system with suitable build configurations. I mentioned earlier that we can use sub-products for the main build products, in example for a specific device. In this case, we can use the <em>aosp_flo</em> sub-product with the <em>eng</em> build type. We’ll run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>lunch aosp_flo-eng</code></pre></figure>

<p>Note: Since the <em>full</em> and <em>aosp</em> products are basically the same, we could’ve use <em>full_flo-eng</em> and get the same results.</p>

<p>After that, we’ll start the build as usual, with a _make -jN _command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make <span class="nt">-j16</span></code></pre></figure>

<p>And now - we wait again. You can watch more “<a href="video.adultswim.com/rick-and-morty/">Rick and Morty</a>”, as suggested earlier.</p>

<h3 id="go-with-the-flo">Go with the Flo</h3>

<p>At the end of the build process, we’ll have a series of .img files that we flash to the device from the boot-loader. Before doing that - a few words about <strong>how</strong> it’s done:</p>

<p>&lt;/br&gt;</p>

<h4 id="bootloader-fastboot-and-download-mode">Bootloader, Fastboot and Download Mode</h4>

<p>So..who is this “boot” fella and why do we need to load it?</p>

<p>Well..you can see the <em>boot-loader</em> as a small part in the system that’s in charge of loading basically everything. The bootloader is the initial sequence of code that executes the operation system. When flashing a new OS on the device, some changes needs to be done to the bootloader, which explains why it’s initially in a locked state in most devices. This is intended to “protect” the device from flashing custom ROMs (mostly for commercial reasons). Unlocking the boot-loader is a process simple as a running a shell command in some devices, and using external software in other. When unlocking the bootloader, ALL USER DATA ON THE DEVICE IS DELETED as a security measure, consider that fact when you decide to do that.</p>

<p><strong>Fastboot/Bootloader mode</strong> is a state in which your device can be flashed with new images. You can access it by a <a href="http://www.droidviews.com/how-to-boot-android-devices-in-fastboot-download-bootloader-or-recovery-mode/">key combination</a> or using the command: <em>adb reboot bootloader</em>. Communicating with a device in this state is done using the <em>fastboot</em> command that comes with the Android SDK, but can also be <a href="https://code.google.com/p/adb-fastboot-install/">downloaded</a> in separate (the ADB command is also included). Not all devices have fastboot mode.</p>

<p><strong>Download mode</strong> is a mode that exists on Samsung devices to replace the fastboot mode. Communicating with the device in this mode is done using a software called Odin, which explains the other name to this mode - “Odin mode”. Using Odin is out of this post’s scope, but the internet is full of Odin how-to’s.</p>

<p>To Unlock a Nexus device’s bootloader, you can follow <a href="http://source.android.com/source/building-devices.html#unlocking-the-bootloader">these instructions</a>. Other devices may require different methods, you can search and see the appropriate method for your device.</p>

<p><br /></p>

<h4 id="flasha-ha">Flash…A-ha!</h4>

<p><img src="/assets/images/2014-06-04-aosp-part-2-build-variants/flashgordonandroid.jpg" alt="flashGordonAndroid" class="center-image" /></p>

<p>Get your device into Fastboot/Bootloader mode and flash all the created images using this command, to be run from the root of your working directory:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>fastboot flashall <span class="nt">-w</span></code></pre></figure>

<p><strong>flashall</strong> - This <em>fastboot</em> command flashes all the images that were created. It looks for them in the path stored in the $OUT environment variable, which is initialized by the <em>lunch</em> command.</p>

<p><strong>-w</strong> - resets the device’s _/data _partition, with all the user’s date, so backup your stuff first. Not mandatory after the first time you flash this ROM.</p>

<p>After the new images got flashed into my Nexus 7, let’s take a look at the “About” screen:</p>

<p><img src="/assets/images/2014-06-04-aosp-part-2-build-variants/wpid-screen23.png" alt="" /></p>

<p>The “Build number” has our lunch target (aosp_flo-eng), my name, the signing keys and the date/time of the build. This screen is the best place to check if your flash process was successful.</p>

<p>Victorious!</p>

<h2 id="creating-anota-package">Creating an OTA Package</h2>

<p>In contrary to image files, where the entire partition is replaced with the content of the image files, an OTA package performs an update to the system’s files. It’s smaller in size and can be incremental from the last build. You can check the _<working dir="">/build/tools/releasetools/ota_from_target_files_ file, to see how the OTA package is actually created</working></p>

<p>To create an OTA package, we need to first pick a build configuration, using <em>lunch</em> as before, and then use</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>make otapackage <span class="nt">-j16</span></code></pre></figure>

<p>After the build finishes, the env variable $OUT or $ANDROID_PRODUCT_OUT will be initialized to the path where the product can be found, that’s where the OTA zip file will be. It should be around 200 MB in our case, less than the sum of all image files (&gt; 400MB). Installing the OTA can be done using the Recovery system.</p>

<p>What is a <em>Recovery</em> you ask?</p>

<p>Remember the bootloader I mentioned earlier? Well..it can boot our device into the Android OS, that we all know and love, <strong>or</strong> into another partition with a Recovery console. The latter has tools to help the user recover or repair a problem he’s having with the OS. The basic recovery on AOSP is very limited, it offers basic operation such as deleting user data, upgrading the firmware and is being controlled using the volume up/down and power keys. You can use a custom recovery such as the popular <a href="https://www.clockworkmod.com/rommanager">ClockworkMod Recovery</a>, which supports more functions and touch screen controls. The easiest way to flash a new custom recovery, is using the app <a href="https://play.google.com/store/apps/details?id=com.koushikdutta.rommanager">ROM Manager</a>, but there are other methods simple as a one <em>fastboot</em> command. Different devices require different steps to do that, search the appropriate method for your device. You can read more about the Recovery <a href="http://wiki.cyanogenmod.org/w/All_About_Recovery_Images">here</a>.</p>

<p>In both Stock and Custom recoveries we can flash a new OTA <a href="http://android-revolution-hd.blogspot.com/2013/12/ow-to-use-adb-sideload.html">using the adb sideload method</a>. The stock recovery will check the package’s signature, a check you can bypass on a custom recovery. So, if you didn’t sign your OTA package correctly - you can use a custom recovery instead.</p>

<p>If the previous ROM on the device was different than the one you installing, it’s encouraged to do a factory reset and clear the cache, to clean up the place and avoid upgrading issues. This can be done from the Recovery console as well. After getting the device into “sideload mode”, we install the OTA package with this command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>adb sideload <span class="se">\&lt;</span>path to OTA package<span class="se">\&gt;</span></code></pre></figure>

<p>The sideload command copies the OTA file to the device and install it. After the process completes - our new ROM is now installed. It is also possible to write code that does the updating for us, you can read about the <a href="http://developer.android.com/reference/android/os/RecoverySystem.html">RecoverySystem class</a> and take an example from <a href="https://github.com/CyanogenMod/android_packages_apps_CMUpdater">Cyanogenmod’s updater</a></p>

<p><strong>An important note for Mac users</strong>: After building an OTA package for my Nexus 7, I noticed that the WiFi isn’t working at all. After doing a bit of research, it seems like there’s a problem with the WiFi driver on OTA packages <strong>if built on Mac</strong>. Creating the OTA package on a Linux system resulted in a fully working WiFi. I found <a href="http://grokbase.com/t/gg/android-building/128v3423db/unable-to-make-working-ota-zip">another person with the same problem</a> as I’m having, but for a Galaxy Nexus device, which means this problem may occur on other devices too.</p>

<h2 id="build-time-and-performance-boost-using-ccache">Build time and performance boost using CCache</h2>

<p>Building Android ROM is a slow process. Many projects are involved and it requires a lot of computing power to crunch all that code together. Strong hardware is the best solution for a fast build - many CPU cores, SSD hard drive and a lot of RAM will increase the build time. Other than that, there is one optimization you can do that doesn’t involve opening your wallet - using CCache.</p>

<p>CCache stands for “Compiler Cache”. What it does is caching the compilation of C\C++ files, in favor of reusing them in future compilations of the same files. In most cases, C/C++ files aren’t changed between builds, since most of the changes we do are in Java files. This means that this cache could really help speed up the process.</p>

<p>How faster can it take us?</p>

<p>I’m using Macbook Pro 2013 with a quad-core CPU + Hyper Threading. A full build after cleanup takes about an <strong>hour and a half.</strong> Using a “warm” ccache, the process takes about <strong>30 mins</strong>. That’s <strong>a third</strong> of the original time! Your results may vary.</p>

<p>The ccache binary file is located at &lt;working dir&gt;/prebuilts/misc/darwin-x86/ccache/ccache (if you’re using linux, then s/darwin-x86/linux-x86). There are a few important switches to that command:</p>

<p><strong>-M &lt;size&gt;</strong> - Initializes the max size of the cache. You can use values as 200M, 30G etc.
<strong>-s</strong> - See statistics of the cache. The amount of files, total size and more.
<strong>-C</strong> - Clears the cache</p>

<p>In order to set up your system to use ccache, you first need to initialize the cache’s max size. The recommended size is between 50-100G. I can say that after cleaning the cache and running a full build I see that only 6G are used, but before I cleaned the cache it was about 45G (I played around a lot with different repos, so maybe that’s why). To initialize the max size, I ran the command only once, before the first time I ran a build:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="se">\&lt;</span>working <span class="nb">dir</span><span class="se">\&gt;</span>/prebuilts/misc/darwin-x86/ccache/ccache <span class="nt">-M</span> 50G</code></pre></figure>

<p>You also need to set the following env variable, showing the build system that you want to use ccache. I suggest putting this setting with the other global variables that you set in your environment:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">USE_CCACHE</span><span class="o">=</span>1</code></pre></figure>

<p>The location of the ccache is by default _~/.ccache. _If you want to change this, you can set it using:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">export </span><span class="nv">CCACHE_DIR</span><span class="o">=</span>&lt;<span class="se">\p</span>ath_of_your_choice<span class="se">\&gt;</span>/.ccache</code></pre></figure>

<p>If you want to watch the ccache being used as you build, you can run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>watch <span class="nt">-n1</span> <span class="nt">-d</span> prebuilts/misc/darwin-x86/ccache/ccache <span class="nt">-s</span></code></pre></figure>

<p>I highly recommend using the ccache for your builds. It really is improving the build time and I never had any problems with using the cache. But then again - I don’t normally change C/C++ files in the AOSP. If you find yourself in a weird compilation problem, and you want to just clean everything up, use <em>make clean</em> <strong>and</strong> also run this to clear the ccache:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="se">\&lt;</span>working <span class="nb">dir</span><span class="se">\&gt;</span>/prebuilts/misc/darwin-x86/ccache/ccache <span class="nt">-C</span></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>At the end of this part, we got our new ROM packaged and flashed into an actual device. Exciting times indeed.. but this is just the beginning. What we learned is just the overhead of creating an AOSP product, the real work is ahead of us. We still have a huge amount of repositories that we need to steer to our direction, and some roads are treacherous. In the last part of this series, we’ll discuss how to create new features on AOSP by maintaining changes on multiple repositories, easily deploying new changes and debugging your code. It’ll give you the jump-start you need before doing any any AOSP work.</p>

<h2 id="further-reading">Further reading</h2>

<p><a href="http://amzn.to/1kJfajE">Embedded Android by Karim Yaghmour</a> - This book explains the AOSP from the A to the P. The different components, the way the build system works, the many “Hacks” we can do there and some really great How-to’s (adding new device, adding new apps/libraries etc.). I don’t read technical books at all, but for this subject - it’s a life saver.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Android-ref">
					Android</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#AOSP-ref">
					AOSP</span>
					
				</a></li>
			
		  
		</ul>
		  
		
		<ul class="tag_box list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#/vendor/asus/flo-ref">
					/vendor/asus/flo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#/vendor/broadcom/flo-ref">
					/vendor/broadcom/flo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#/vendor/qcom/flo-ref">
					/vendor/qcom/flo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#adb reboot bootloader-ref">
					adb reboot bootloader
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#adb sideload-ref">
					adb sideload
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Android-ref">
					Android
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Android ROM-ref">
					Android ROM
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ANDROID_PRODUCT_OUT-ref">
					ANDROID_PRODUCT_OUT
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#AOSP-ref">
					AOSP
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#aosp_flo-ref">
					aosp_flo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#aosp_flo-eng-ref">
					aosp_flo-eng
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#boot-loader-ref">
					boot-loader
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#bootloader-ref">
					bootloader
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#build number-ref">
					build number
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#build variant-ref">
					build variant
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#build/target/product-ref">
					build/target/product
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#buildtype-ref">
					buildtype
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ccache-ref">
					ccache
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ccache -C-ref">
					ccache -C
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ccache -M-ref">
					ccache -M
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ccache -s-ref">
					ccache -s
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#CCACHE_DIR-ref">
					CCACHE_DIR
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ClockworkMod-ref">
					ClockworkMod
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#CM updater-ref">
					CM updater
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#CM_updater-ref">
					CM_updater
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#custom recovery-ref">
					custom recovery
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#debug-ref">
					debug
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#download mode-ref">
					download mode
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#embedded android-ref">
					embedded android
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#emulator-ref">
					emulator
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#eng-ref">
					eng
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#envsetup.sh-ref">
					envsetup.sh
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fastboot-ref">
					fastboot
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fastboot flashall -w-ref">
					fastboot flashall -w
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fastboot mode-ref">
					fastboot mode
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fastboot oem lock-ref">
					fastboot oem lock
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#fastboot oem unlock-ref">
					fastboot oem unlock
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#full-ref">
					full
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#full_flo-ref">
					full_flo
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#generic-ref">
					generic
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#karim yaghmour-ref">
					karim yaghmour
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#LOCAL_MODULE_TAGS-ref">
					LOCAL_MODULE_TAGS
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#lunch-ref">
					lunch
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#lunch full_eng-ref">
					lunch full_eng
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make-ref">
					make
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make -j16-ref">
					make -j16
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make -j8-ref">
					make -j8
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make clean-ref">
					make clean
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make clobber-ref">
					make clobber
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#make otapackage-ref">
					make otapackage
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#nexus-ref">
					nexus
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#odin mode-ref">
					odin mode
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ota pacakge-ref">
					ota pacakge
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#ota wifi mac-ref">
					ota wifi mac
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#prebuilts/misc/darwin-x86/ccache/ccache-ref">
					prebuilts/misc/darwin-x86/ccache/ccache
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#prebuilts/misc/linux-x86/ccache/ccache-ref">
					prebuilts/misc/linux-x86/ccache/ccache
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#recovery-ref">
					recovery
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#recovery console-ref">
					recovery console
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#RecoverySystem-ref">
					RecoverySystem
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#sdk-ref">
					sdk
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#TARGET_BUILD_VARIANT-ref">
					TARGET_BUILD_VARIANT
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#test-keys-ref">
					test-keys
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#touch wiz-ref">
					touch wiz
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#user-ref">
					user
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#userdebug-ref">
					userdebug
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#USE_CCACHE-ref">
					USE_CCACHE
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#vendor-ref">
					vendor
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#version_defaults.mk-ref">
					version_defaults.mk
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#watch -n1 -d prebuilts/misc/darwin-x86/ccache/ccache -s-ref">
					watch -n1 -d prebuilts/misc/darwin-x86/ccache/ccache -s
					
					</a>
				</li>
			
		  
		  
		</ul>
		  


	<div align="center" class="author-container">
		<figure class="author-img-post">
			<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a" class="img-circle author-image" />			
		</figure>
        <h4 class="section-title">Written by Udi Cohen</h4>
	</div>
	<div class="share-container">					
      <section class="share" align="center">
        <p class="section-title">Share this post:</p>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=AOSP Part 2: Build variants&via=udinic"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" 
           onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+window.location.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm reddit"
           onclick="window.open('http://www.reddit.com/submit?url='+window.location.href+'&title=AOSP Part 2: Build variants', 'reddit-share', 'width=580,height=530');return false;">
          <i class="fa fa-reddit fa-lg"></i>
          Reddit
        </a>
      </section>

    </div>

    <!-- <div class="clearfix"></div> -->

	<!-- <hr> -->
	
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'udinic-blog';
    var disqus_identifier = '/2014/06/04/aosp-part-2-build-variants/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	</div>
	








</article>
<div class="clearfix"></div>



		<footer>
			<p>
				&copy; 2025 Udi Cohen with Jekyll. Theme: Customized (based of <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek).
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

