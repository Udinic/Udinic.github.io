<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61317191-1', 'auto');
  ga('send', 'pageview');

</script>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Udi Cohen's blog</title>
	
	<meta name="author" content="Udi Cohen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">



	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/udinic">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/udinic">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
 		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/archives">Archives</a></li>
				<li><a href="/about">About</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
<!-- 	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>
 -->
	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<i class="fa fa-cube" ></i>
	</a>

</header>

<div class="text-center sidebar-title">
	UDI COHEN
</div>	


<div class="text-center sidebar-bio">
	My adventures
</div>


	<!-- <i class="fa fa-square"></i> -->

<div class="text-center sidebar-links">
	<a href="/">Home</a>
	| 
	<a href="/archives">Archives</a>	
	|
	<a href="/about">About</a>
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm twitter" href="https://twitter.com/udinic">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm github" href="https://github.com/udinic">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm linkedin" href="https://linkedin.com/in/udinic">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm rss" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3 main-content">
		<div class="page-header">
  <h1>Udi Cohen's blog </h1>
</div>


  
<article class="home">

  <span class="post-date">
    
    November
    1st,
    
    2025
  </span>

  <h2>
    <a href="/2025/11/01/building-cardflix-a-modern-twist-on-the-old-movie-shelf/">Building CardFlix – A Modern Twist on the Old Movie Shelf</a>
  </h2>

  <div>
    
    
       <p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image11.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image11.jpg" /></a></p>

<p>Watching TV is one of my favorite activities, but I noticed it’s become too easy for kids (and adults) to fall into the endless loop of short, addictive YouTube videos instead of enjoying a thoughtful episode of a TV show or diving into an adventure movie. I got tired of seeing my kids glued to the screen watching yet another YouTuber attempt a ridiculous “Fast-Food Challenge.”</p>

<p>So I decided to make good content more accessible - and fun to play. The result: watching content on the TV by scanning physical <strong>Movie Cards</strong> with NFC. I call it <strong>CardFlix</strong>.</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/_sqxoAX3GW0" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	CardFlix in action
</div>

<p>This project was a great opportunity to involve my kids in electronics, showing them how to make something truly useful by building it together.</p>

<p>The scanner runs on <a href="https://esphome.io/"><u>ESPHome</u></a> - a framework that makes creating custom smart devices surprisingly simple, and connects to my <a href="https://www.home-assistant.io/"><u>Home Assistant</u></a> smart home setup. With my kids’ help, we created <strong>over 50 cards</strong> covering all their favorite shows and movies, and the collection keeps growing. It was such a hit that I built a second scanner for another room in our house. To make the scanner blend in, I designed and 3D-printed a small enclosure that matches the décor of the room while keeping the scanner kid-friendly and accessible.</p>

<p>Creating the initial version of this scanner was a fun weekend project. I was able to show my kids the process of bringing an idea to life, in addition to me gaining more confidence creating ESPHome projects, which became more useful for other projects that I’ll share soon.</p>

<h2 id="building-the-electronics">Building the electronics</h2>

<p>The circuit is straightforward: connecting an NFC reader module (<a href="https://amzn.to/3L6np34"><u>PN532</u></a>) to a microcontroller (<a href="https://amzn.to/43rh8oU"><u>ESP8266</u> <u>WeMos D1 mini</u></a>).</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image6.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image6.png" /></a></p>
<div class="image-caption">
	Circuit diagram showing the PN532 NFC reader connected to the microcontroller
</div>

<p>To connect a microcontroller, like the Wemos D1 Mini, to an NFC reader (or other peripherals such as sensors, displays etc.) there are 2 common methods: <strong>I²C</strong> or <strong>SPI</strong>. SPI can handle higher throughput than I²C and is generally faster, which is good if we connect an LCD display and need to move a lot of pixels quickly for it, but it’s not particularly useful for a simple tag scanner. I chose I²C because it’s simpler to hook up, it needs only 2 wires in compare to 4 wires we need to support SPI connection.</p>

<p>One critical step to note here: <strong>set the PN532’s mode correctly</strong>. The board has tiny DIP switches to toggle between I²C and SPI. Make sure these match your chosen mode - otherwise you’ll be staring at a non-responsive scanner and wondering why nothing works. Let’s just say I learned that lesson the hard way…</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image10.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image10.png" /></a></p>
<div class="image-caption">
	Flipping the PN532 mode from SPI to I²C
</div>

<p>Once the correct mode is set, I wired the SDA and SCL pins from the PN532 to the Wemos D1 mini. You can map I²C lines to almost any pins on the microcontroller; I chose <strong>D8</strong> (for SDA) and <strong>D7</strong> (for SCL). These need to match what we’ll later declare in the ESPHome config:</p>

<p>After confirming the wiring, I soldered everything together. A pair of <em>helping hands</em> was invaluable here - keeping the boards aligned so I could stack them neatly and compactly. That’s important, since they need to fit snugly inside the enclosure, as we’ll see later.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image17.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image17.jpg" /></a></p>
<div class="image-caption">
	Soldered electronics stack help by the helping hands
</div>

<p>BTW, the reason I picked the <em>Wemos D1 mini</em> as the microcontroller for this project is because of its size. I knew I would need to eventually mount the device near the TV, so having a small form-factor is a useful feature. ESPHome, which we’ll talk about next, supports several other microcontroller types in different shapes and with varied capabilities. Even <a href="https://amzn.to/434jtWK"><u>this baby-chip</u></a> is supported.</p>

<h2 id="smart-home-integration">Smart Home Integration</h2>

<p>With the hardware stacked and soldered, it was ready for the fun part - bringing it to life through ESPHome and tying it into Home Assistant, where we’ll write an automation to make the scanner react to different cards.</p>

<p>If you’re not already using <a href="https://www.home-assistant.io/">Home Assistant</a>, it’s an open-source smart-home platform that brings all your devices together - TVs, phones, sensors, air conditioners, and much more. You can easily run it on a Raspberry Pi, an old PC, or a virtual machine, so even if this is your first smart-home experiment, you can still install it just for this project</p>
<h3 id="esphome-config-basics">ESPHome Config Basics</h3>

<p>The scanner runs on <a href="https://esphome.io/"><u>ESPHome</u></a>, which makes connecting hardware like the PN532 reader almost trivial. Instead of writing firmware, you just declare the pins and components in YAML, and ESPHome takes care of the rest.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">esphome</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cardflix_scanner</span>
  <span class="na">platform</span><span class="pi">:</span> <span class="s">ESP8266</span>
  <span class="na">board</span><span class="pi">:</span> <span class="s">d1_mini</span>

<span class="na">i2c</span><span class="pi">:</span>
  <span class="na">sda</span><span class="pi">:</span> <span class="s">D8</span>  <span class="c1"># The pins we connected earlier</span>
  <span class="na">scl</span><span class="pi">:</span> <span class="s">D7</span>
  <span class="na">scan</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># optional, helps confirm wiring</span>

<span class="na">pn532_i2c</span><span class="pi">:</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s">nfc_reader</span>
</code></pre></div></div>

<p>(<a href="https://gist.github.com/Udinic/dd0198f7b6b6fc5699ca6cc5079ad70f"><u>Full ESPSHome config yaml code</u></a>)</p>

<p>“Installing” this config on our microcontroller involves connecting it to the computer and using 2 web tools that do everything. The first tool, <em>ESPHome Builder</em> (a Home Assistant Add-on), parses the yaml config and generates the firmware based on the info on that config. The second tool, <a href="https://web.esphome.io/?dashboard_wizard"><u>ESPHome Web</u></a>, connects to your device via USB cable and flashes the firmware onto it. There are plenty of good instructions for the process, such as <a href="https://www.youtube.com/watch?v=cfkW7ZmiMEw&amp;t=759s"><u>this youtube video</u></a> or the <a href="https://esphome.io/guides/getting_started_hassio/"><u>official ESPHome instructions</u></a>.</p>

<h3 id="from-esphome--home-assistant">From ESPHome → Home Assistant</h3>

<p>Once the firmware is loaded onto the Wemos D1 mini, Home Assistant automatically detects the device and prompts you to add it as an integration.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image5.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image5.png" /></a></p>
<div class="image-caption">
	Home Assistant integration setup screen
</div>

<p>From there, the scanner can report any NFC tags it detects. Home Assistant has an Event Listening feature under Developer Tools, a quick scan of any card, while listening to “tag_scanned” events, will show some useful data for the card and the tag scanner. <em>tag_id</em> is the card’s unique ID and <em>device_id</em> is the tag scanner’s unique ID.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image19.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image19.png" /></a></p>
<div class="image-caption">
	Event Listener showing tag_scanned event data
</div>

<p>We <em>could</em> also write data onto the cards, but we won’t do that here. There’s no need to complicate the process of onboarding new movie cards, since each card already has a permanent unique identifier (the <em>tag_id</em> we see above). We’ll design an automation that maps each card’s Tag ID to the content we need to play.</p>

<h3 id="writing-the-automation">Writing the Automation</h3>

<p>There are a few ways to set up the automation. I liked the structure Xavier at <a href="https://simplyexplained.com/blog/how-i-built-an-nfc-movie-library-for-my-kids/"><em><u>Simply Explained</u></em></a> shared, it keeps the mapping of Tag IDs to content easy to read and update.</p>

<p>I made a few changes of my own:</p>

<ul>
  <li>
    <p>Support for multiple scanners (so different rooms can have their own devices).</p>
  </li>
  <li>
    <p>Some tweaks to handle different types of content (Plex, Netflix, etc.).</p>
  </li>
</ul>

<p>Here’s how it works.</p>

<p><strong>1. The automation’s trigger - scanning a card.</strong><br />
The trigger is a <em>tag_scanned</em> event, the same one we saw earlier when testing the scanner using the Developer Tools. The automation will be triggered when such an event is fired.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image7.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image7.png" /></a></p>
<div class="image-caption">
	The Automation's trigger configuration for tag_scanned events
</div>

<p><strong>2. Defining the variables we need.</strong><br />
These are the variables the automation uses:</p>
<ul>
  <li><strong>SCANNER_MAPPING</strong> - A simple mapping between Scanner IDs to the TV entity they should operate on. This will ensure that the scanner in the bedroom will start any playback on the Bedroom TV and not other TVs. We can get the Scanner ID using the Event Listener tool we saw earlier.</li>
  <li><strong>TARGET_TV</strong> - This variable resolves to the TV entity the automation needs to target, based on the Scanner ID that was provided by the <em>tag_scanned</em> event (<em>trigger.event.data.device_id</em> = The Scanner ID). This also defines the default TV in case the scanner is not mapped to any specific TV (In this case, the default is Living Room TV).</li>
  <li><strong>CARD_MAPPING</strong> - Maps each card’s Tag ID to the content it should play.</li>
</ul>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image2.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image2.png" /></a></p>
<div class="image-caption">
	The automation's variables, we'll mostly update CARD_MAPPING with Tag IDs and content IDs
</div>

<p>Each card mapping includes the Tag ID, a name (just for readability) and the Content ID. The automation supports a few content types, for several streaming services and Plex. We’ll see below how we deep link to open the content.</p>

<p><strong>3. Turning on the TV, if needed</strong><br />
The TARGET_TV variable holds the TV we’re targeting, we’ll check its status and turn it on if needed.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image18.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image18.png" /></a></p>
<div class="image-caption">
	TV power control logic in the automation
</div>

<p><strong>4. Start the requested content using the content mapping defined in CARD_MAPPING</strong><br />
Each streaming service has its own Deep Link format. For each content we’ll check the streaming service it’s using, retrieve the correct deep link format and use it with the content’s ID to start the playback.</p>

<p>In the example below, looking up the Tag ID in CARD_MAPPING provided a “netflix_id”, which we used as part of the Netflix Deep Link URL, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.netflix.com/watch/&lt; CARD_MAPPING[trigger.event.data.tag_id].netflix_id &gt;
</code></pre></div></div>

<p>The URL is sent to my Apple TV as a “Play Media” request.</p>

<p>This URL works on an Apple TV, which is connected to my TV. It’s possible other media devices, such as Smart TVs, would have different requirements to deep link to a specific content.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image20.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image20.png" /></a></p>
<div class="image-caption">
	The flow of playing a Netflix content in the automation
</div>

<p>These are the main logic of the automation, the full yaml code is <a href="https://gist.github.com/Udinic/5686171f45b45baca0a10299ac2c6852"><u>available here</u></a>.</p>

<h4 id="deep-linking-to-content">Deep Linking to Content</h4>

<p>Deep links are URLs that open a specific content on a specific streaming service. Not all of them are properly documented and some of them might not work on every streaming device (e.g. Apple TV, Smart TVs, Roku device). These are the Deep Link URLs that I found to be working on an Apple TV:</p>

<table>
  <thead>
    <tr>
      <th><strong>Service</strong></th>
      <th><strong>URL Format</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Disney+</strong></td>
      <td><code class="language-plaintext highlighter-rouge">https://www.disneyplus.com/en-gb/play/&lt;Content ID&gt;</code></td>
    </tr>
    <tr>
      <td><strong>Netflix</strong></td>
      <td><code class="language-plaintext highlighter-rouge">https://www.netflix.com/watch/&lt;Content ID&gt;</code></td>
    </tr>
    <tr>
      <td><strong>Hulu</strong></td>
      <td><code class="language-plaintext highlighter-rouge">hulu://watch/&lt;Content ID&gt;</code></td>
    </tr>
    <tr>
      <td><strong>Plex Movie/TV</strong></td>
      <td><code class="language-plaintext highlighter-rouge">plex://play/?metadataKey=%2Flibrary%2Fmetadata%2F&lt;Content ID&gt;&amp;server=&lt;Plex server ID&gt;</code></td>
    </tr>
    <tr>
      <td><strong>Plex Playlist</strong></td>
      <td><code class="language-plaintext highlighter-rouge">plex://play/?metadataKey=%2Fplaylists%2F&lt;Content ID&gt;&amp;server=&lt;Plex server ID&gt;</code></td>
    </tr>
  </tbody>
</table>

<p>The Content ID can be retrieved by opening the content on your browser and checking the URL.</p>

<p>Tip: Using a Plex playlist is a great way to watch random episodes of some TV Show(s), perfect for shows the kids have already watched a hundred times. <a href="https://forums.plex.tv/t/tip-how-to-create-an-autoplaylist-with-random-sort/472823"><u>Instructions on how to do that</u></a>.</p>

<p>And here’s the automation in action:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/Z5VRNPnNeZE" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Demo video testing the automation
</div>

<h2 id="creating-the-content-cards">Creating the Content Cards</h2>

<p>The electronics and automations are only half the story — the real magic (and the part my kids loved most) was creating the movie cards themselves.</p>

<p>Each card is laminated with the TV/Movie’s artwork. The laminate not only makes the cards sturdy enough for repeated use, but also gives them that satisfying “real card” feel</p>

<p>We used <a href="https://fanart.tv/"><u>fanart.tv</u></a> as our main source for high-quality TV and movie artwork. It has a huge collection of posters, logos, and backgrounds that work perfectly for this kind of project. Once we picked the right art, we copied it into a Google Doc and resized it to the dimensions of a credit card (Tip: resize to Width 2.12 inch, Height: 3.36 inch, Ratio: 1.583333). We put a few posters on a single page and printed it.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image12.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image12.png" /></a></p>
<div class="image-caption">
	Arranging the movie posters for printing
</div>

<p>The printed poster we put on top of the card, slipped into a <a href="https://amzn.to/4htrRoL"><u>Laminating Pouch</u></a> and from there straight to the laminating machine. The <a href="https://amzn.to/47kbCad"><u>one I got</u></a> is cheap (under $20) and it served us well in several projects, definitely nice to have around the house.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image21.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image21.png" /></a></p>
<div class="image-caption">
	My daughter Emma is showing how we lamindate a movie card
</div>

<h3 id="onboarding-a-new-card">Onboarding a New Card</h3>

<p>Once the physical card is ready, the final step is onboarding it into Home Assistant. To make things easier, I’ve added to the automation a fallback in case we scan a card that’s not assigned to any content, which prints the card’s Tag ID to Home Assistant’s Logbook.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image1.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image1.png" /></a></p>
<div class="image-caption">
	The "Else" clause of the automation, printing the card's Tag ID to the Logbook
</div>

<p>This is how the Logbook entry looks like:</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image3.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image3.png" /></a></p>
<div class="image-caption">
	Home Assistant's Logbook entry detailing the Tag ID of a new card to onboard
</div>

<p>Then all we need is to add a new entry in the CARD_MAPPING variable inside our automation:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">CARD_MAPPING</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">3D-1A-D6-FD</span><span class="err">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Octonauts</span>
        <span class="na">netflix_id</span><span class="pi">:</span> <span class="m">80023363</span>
</code></pre></div></div>

<p>By streamlining this process we made it very easy to grow the collection. Every time we want to add a few new TV Shows or Movies - I would search the content IDs in the streaming services, while my kids handle the card laminating step and we would meet at the end by scanning the cards and adding the new mapping for each new card. We don’t need to leave the house for a fun family activity.</p>

<h2 id="3d-printing-the-enclosureand-more">3D Printing the Enclosure..and more</h2>

<p>With the electronics and cards ready, the last step was giving the scanner a proper home. I wanted it to be accessible for the kids while being subtle enough to blend into the room’s décor.</p>

<p>Instead of designing something from scratch, I started with an existing enclosure I found online and personalized it with a simple logo that ChatGPT helped create. The result was a clean, kid-friendly enclosure with a custom logo that makes it feel like a finished product.</p>

<p><a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image4.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image4.png" /></a></p>
<div class="image-caption">
	Desgining a 3D printed enclosure with a custom CardFlix logo on the BambuLab Slicer
</div>

<p>I printed the design on my Bambu Lab printer, using standard PLA. The compact stack of the electronics fit snugly inside, with just enough room for the wires and solder joints.</p>

<table class="side-by-side">
  <tr>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image15.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image15.jpg" /></a>
    </td>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image16.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image16.jpg" /></a>
    </td>
  </tr>
</table>
<div class="image-caption">
	3D printed enclosure assembly and final mounted scanner
</div>

<p>You can download the enclosure from <a href="https://makerworld.com/en/models/1924849-cardflix-enclosure#profileId-2065641"><u>here</u></a>.</p>

<p>To keep the cards organized and accessible I created 2 boxes - one to hold a large group of cards, another for holding a small group of “most favorite” cards next to the reader.</p>

<table class="side-by-side">
  <tr>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image8.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image8.png" /></a>
    </td>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image9.png"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image9.png" /></a>
    </td>
  </tr>
</table>
<div class="image-caption">
	Card storage boxes - large collection box and slim favorites box
</div>
<p>And in case you wonder, there are 4 Bluey cards in those boxes…</p>

<p>Links to the 3D models: <a href="https://makerworld.com/en/models/1924938-card-box-for-cardflix#profileId-2065737"><u>Cards box</u></a> / <a href="https://makerworld.com/en/models/1924909-card-box-for-cardflix-slim#profileId-2065705"><u>Cards box (slim)</u></a></p>

<h2 id="bringing-it-all-together">Bringing It All Together</h2>

<p>With the hardware soldered, the enclosure printed, the Movie Cards laminated, and the automation wired into Home Assistant - it was time for the payoff.</p>

<table class="side-by-side">
  <tr>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image13.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image13.jpg" /></a>
    </td>
    <td>
      <a href="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image14.jpg"><img src="/assets/images/2025-11-01-building-cardflix-a-modern-twist-on-the-old-movie-shelf/media/image14.jpg" /></a>
    </td>
  </tr>
</table>
<div class="image-caption">
	Complete CardFlix setup showing scanner and card collection
</div>

<p>Here’s a short demo of the scanner in action:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/jGjedY8tdiY" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Final demo video - this is how we usually play content, using the "most favorites" box.
</div>

<p>No menus, no remotes, no digging through apps. Just the card, the scanner, and the content.</p>

<p>It’s been a huge success in our house - my kids love the ritual of picking a card and watching it come to life, and it gives them a healthier, more intentional way to choose what to watch.</p>

<h2 id="closing-thoughts">Closing Thoughts</h2>

<p>This project started as a way to combine electronics tinkering with something useful for the family, and it turned into one of our favorite weekend builds. Between the hands-on soldering, designing the cards, and the 3D-printed enclosure, everyone got a part to play - and the end result is something truly useful.</p>

<p>If you’d like to build your own, all the relevant links to get you through that are below. And if you do make one - I’d love to hear about it!</p>

<h3 id="links">Links</h3>

<p>Electronics:</p>

<ul>
  <li>
    <p><a href="https://amzn.to/43rh8oU"><u>Microcontroller: WeMos D1 Mini</u></a></p>
  </li>
  <li>
    <p><a href="https://amzn.to/3L6np34"><u>NFC Reader: PN532</u></a></p>
  </li>
  <li>
    <p><a href="https://amzn.to/4nU79jk"><u>NFC Cards</u></a></p>
  </li>
</ul>

<p>Code:</p>

<ul>
  <li>
    <p><a href="https://gist.github.com/Udinic/dd0198f7b6b6fc5699ca6cc5079ad70f"><u>ESPHome config yaml</u></a></p>
  </li>
  <li>
    <p><a href="https://gist.github.com/Udinic/5686171f45b45baca0a10299ac2c6852"><u>Home Assistant Automation yaml</u></a></p>
  </li>
</ul>

<p>Lamination:</p>

<ul>
  <li>
    <p><a href="https://amzn.to/47kbCad"><u>Crenova Laminator Machine</u></a></p>
  </li>
  <li>
    <p><a href="https://amzn.to/4htrRoL"><u>Laminating Pouches, card-sized</u></a></p>
  </li>
</ul>

<p>3D Print Models:</p>

<ul>
  <li>
    <p><a href="https://makerworld.com/en/models/1924849-cardflix-enclosure#profileId-2065641"><u>Enclosure</u></a></p>
  </li>
  <li>
    <p><a href="https://makerworld.com/en/models/1924938-card-box-for-cardflix#profileId-2065737"><u>Card Box (Large)</u></a></p>
  </li>
  <li>
    <p><a href="https://makerworld.com/en/models/1924909-card-box-for-cardflix-slim#profileId-2065705"><u>Card Box (Slim)</u></a></p>
  </li>
</ul>

       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    January
    13th,
    
    2021
  </span>

  <h2>
    <a href="/2021/01/13/automating-balcony-shade-with-nfc/">Automating my balcony shade... with NFC!</a>
  </h2>

  <div>
    
    
       <p>These past few months I spent mostly at home, as everyone else, and decided to take on a project to improve my time there. With three kids at our cozy apartment, it’s no wonder I loved spending a lot of time on our balcony. While I like the breeze and the view, I hated lowering and raising the sun shade. It’s a heavy shade, so it took more effort and time to operate than a regular bedroom window shade/blinds. I challenged myself to automate this shade by any means necessary!</p>

<p>I found a strong motor, designed a circuit and programmed a microcontroller to run the show. I mounted a switch box with up/down buttons and used NFC to support “shade presets”. Finally, I got everything connected to the internet and respond to voice commands from Google Assistant. The result:</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/intro-circuit.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/intro-circuit.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The complete smart shade controller circuit
</div>

<p><br /></p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/f4yYC6kvG9Y" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Demo of the smart shade controller
</div>

<p>That was quite a journey.</p>

<p>I dived into the world of Arduino, where I learned how to design and program circuits. I also gained a better grasp on mechanical engineering concepts and got some experience applying them in real life. At the end, I had a polished Shade Controller that works reliably and safe for everyone to use, including my kids.</p>

<p>In this post I wanted to share my experience <strong>building a smart shade controller from scratch</strong>. Here’s an overview of the steps I’ll cover:</p>
<ul>
  <li>Finding a suitable motor and figuring out how to attach it to the shade.</li>
  <li>Building the circuit and testing it in my balcony.</li>
  <li>Taking automation to the next level by using NFC (Near-Field Communication).</li>
  <li>Improving the appearance of the shade controller.</li>
  <li>Supporting voice commands using Google Assistant.</li>
  <li>Tips and lessons learned.</li>
</ul>

<p>I think the creation process was a cool experience that’s worth the read on it’s own, but I also hope that some of my methods, research and learnings will help others undertake similar projects.</p>

<p><br /></p>

<h2 id="setting-up-the-motor">Setting up the Motor</h2>

<p>Building a custom smart shade/blinds is a pretty common project, but as I researched this subject I didn’t find a solution that fits the type of shade I have. In most of these examples, the motor was moving the blinds by pulling a chain or rotating a small twist shaft.</p>

<div class="outer-grid">
	<div class="inner-grid">
  		<a href="http://www.roberttrescott.com/shadesblinds.html">
  			<img src="/assets/images/automating-balcony-shade-with-nfc/other-shaft.jpg" /> 
  		</a>
	</div>
  	<div class="inner-grid">
		<a href="https://github.com/vietquocnguyen/NodeMCU-ESP8266-Servo-Smart-Blinds">
  			<img src="/assets/images/automating-balcony-shade-with-nfc/other-ballchain.jpg" />
  		</a>
  		<a href="http://energydefender.blogspot.com/2010/02/arduino-controlled-electric-blinds.html">
  			<img src="/assets/images/automating-balcony-shade-with-nfc/other-twist.jpg" style="padding-top: 8px;" />  	
  		</a>
  	</div>
</div>
<div class="image-caption">
	Examples for other smart shade projects. Click on each image to see the relevant project.
</div>

<p>The shade I installed in my balcony is much bigger and heavier than most of these shades. It’s 8 feet wide, weighs 8 pounds and uses a crank and a wand to operate.</p>

<div class="media-center">
	<a href="https://www.amazon.com/gp/product/B00IWMLEZS/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1">
		<img src="/assets/images/automating-balcony-shade-with-nfc/shade-amazon.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The shade I have on my balcony
</div>

<p>To start, I need to find a strong motor that can actually move this shade. There are ways to measure the force needed to move the shade (like using a <a href="https://www.engineeringtoolbox.com/torque-wrench-luggage-scale-d_1909.html">luggage scale</a>), but I ended up consulting my mechanical engineer brother, who helped me pick a motor that should be strong enough for the job. I found a <a href="https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/">Servo motor</a> that’s strong by itself, but it also comes inside a gearbox that increases its torque (and I could use all the torque I can get!). The gearbox has 2 gears in a 2:1 ratio, which produces half the speed of the original servo motor, but with twice the torque. To close or open the shade we need to rotate the crank 60 times, so with the 31 RPM the motor can do - it’ll take about 2 minutes. That’s reasonable enough.</p>

<p>Now that I have a motor, I needed to find a way to mount it on the roller and get it to rotate the crank. I took measurements and started researching…</p>

<div class="outer-grid">
	<div class="inner-grid">
		<img src="/assets/images/automating-balcony-shade-with-nfc/measure1.jpg" /> 
	</div>
	<div class="inner-grid">
		<img src="/assets/images/automating-balcony-shade-with-nfc/measure2.jpg" /> 
	</div>
	<div class="inner-grid">
		<img src="/assets/images/automating-balcony-shade-with-nfc/measure3.jpg" /> 
	</div>
</div>
<div class="image-caption">
	Taking measurements
</div>

<p>Connecting the motor to the crank and rotating it was also not trivial. I took some measurements, but I don’t have a 3D printer so I can’t just print a perfect adapter. Luckily, after some online searching I found a <a href="https://www.servocity.com/lightweight-linear-actuator-mounting-bracket/">bracket</a> that fits perfectly! To celebrate, I did an initial test to verify the motor can actually move the shade in both directions:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/FIFcKEm9gtY" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Testing the motor
</div>

<p>A successful mount of the motor needs to produce a smooth crank rotation while the motor spins, any misalignment between the rotation planes of the motor and the crank could cause friction that damages the shade’s mechanism or the motor. Getting this alignment right was found to be quite challenging.</p>

<p>Since I don’t have a 3D printer, I had to improvise a setup with existing structural components. I found <a href="https://www.servocity.com/">ServoCity</a>, a well-organized website that sells parts for projects like this. On the site, I found and ordered a bunch of different structural components that might help me. I used various metal plates and brackets to mount the motor in different ways, testing the crank’s rotation and making adjustments. After some trial and error, and a bunch of new holes in my wall, I eventually found an arrangement that worked.</p>

<div class="outer-grid">
	<div class="inner-grid">
		<a href="/assets/images/automating-balcony-shade-with-nfc/mount1.jpg">
			<img src="/assets/images/automating-balcony-shade-with-nfc/mount1.jpg" /> 
		</a>
	</div>
	<div class="inner-grid">
		<a href="/assets/images/automating-balcony-shade-with-nfc/mount2.jpg">
			<img src="/assets/images/automating-balcony-shade-with-nfc/mount2.jpg" /> 
		</a>
	</div>
</div>
<div class="image-caption">
	Mounting the motor. First attempt on the left, final position on the right.
</div>

<p>Cool, now that I have the motor in place - I need to build the circuit that controls it.</p>

<p><br /></p>

<h2 id="building-the-shade-controller-circuit">Building the Shade Controller Circuit</h2>

<p>My initial requirement for the shade controller was simple: have 2 buttons that can spin the motor in both directions. That was a great excuse to start tinkering with Arduino, something I wanted to do for a while.  So I dived right in.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/arduino-simple.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/arduino-simple.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Simple circuit to spin the motor in both directions.
</div>

<p>The 2 buttons are connected to the Arduino through the breadboard, each one is connected to a different pin on the Arduino board. The code constantly reads the value of these pins to detect when a button was pressed. By default, each pin returns the value HIGH but during the time a button is pressed the pin’s value will be LOW. The code ignores long presses and acts only when a button changes state, which is why we compare the current pin’s value to the previous one.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include</span> <span class="cpf">&lt;Servo.h&gt;</span><span class="c1"> </span><span class="cp">
</span>
<span class="c1">// Pin definitions</span>
<span class="cp">#define PIN_SERVO (13)
#define PIN_UP_BTN (5)
#define PIN_DOWN_BTN (15)
</span>
<span class="n">Servo</span> <span class="n">myServo</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Setting up the button with the pins they're wired to</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_UP_BTN</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_DOWN_BTN</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Main function that loops as long as the controller is powered on</span>
<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Reading the value in the pins connected to the buttons.</span>
  <span class="c1">// The default read will be HIGH, while pressing a button it's changed to LOW</span>
  <span class="n">btnUpCurr</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_UP_BTN</span><span class="p">);</span>
  <span class="n">btnDownCurr</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="n">PIN_DOWN_BTN</span><span class="p">);</span>

  <span class="c1">// The UP button is pressed </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">btnUpCurr</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">&amp;&amp;</span> <span class="n">btnUpPrev</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If the motor is already spinning - stop it</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">raisingShade</span> <span class="o">||</span> <span class="n">loweringShade</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stopShade</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">raiseShade</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>  

  <span class="c1">// The DOWN button is pressed  </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">btnDownCurr</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">&amp;&amp;</span> <span class="n">btnDownPrev</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">raisingShade</span> <span class="o">||</span> <span class="n">loweringShade</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stopShade</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">lowerShade</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">btnUpPrev</span> <span class="o">=</span> <span class="n">btnUpCurr</span><span class="p">;</span>
  <span class="n">btnDownPrev</span> <span class="o">=</span> <span class="n">btnDownCurr</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>The Servo motor is also connected to one of the Arduino’s pins, using the yellow/white wire. Controlling the motor is done using an API that’s part of a Servo library.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">lowerShade</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">PIN_SERVO</span><span class="p">);</span>
  <span class="c1">// Value smaller than 1500 will spin the motor counter-clockwise</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">writeMicroseconds</span><span class="p">(</span><span class="mi">850</span><span class="p">);</span>  
  <span class="n">loweringShade</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">raisingShade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">raiseShade</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">PIN_SERVO</span><span class="p">);</span>
  <span class="c1">// Value larger than 1500 will spin the motor clockwise</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">writeMicroseconds</span><span class="p">(</span><span class="mi">2100</span><span class="p">);</span>  
  <span class="n">raisingShade</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">loweringShade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">stopShade</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">raisingShade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">loweringShade</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Internally, the Servo library is controlling the motor by sending it signals in “different formats”, which contain the position and direction the motor should be spinning. For more on that, check out <a href="https://en.wikipedia.org/wiki/Servo_control">how Pulse-Width Modulation works</a>.</p>

<p>After getting this simple circuit to work, I decided to replace the Arduino board with a smaller microcontroller - the ESP32.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/esp32-comparison.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/esp32-comparison.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Arduino vs. ESP32
</div>

<p>Arduino is an open source hardware and software for electronics hobbyists. The board I have, the MEGA 2560, is Arduino-compatible. It was not manufactured by the Arduino company but it did use the same open source Arduino hardware design. This means I can use the Arduino IDE to program my board and utilize the great variety of Arduino libraries to integrate with external sensors and peripherals. The ESP32 hardware was not built by the same Arduino specification, but its software bridges the gap between the 2 hardware designs. This means we can program the ESP32 almost exactly the same as an Arduino board or an Arduino-compatible board, even though they are very different.</p>

<p>Why choose ESP32 over an Arduino board? Well, Arduino is great for beginners because it’s simpler to use and easier to get started. However, the ESP32 is more powerful, smaller, cheaper and supports Bluetooth and WiFI, which the Arduino doesn’t. To make it easier to work with, the ESP32 chip comes integrated in a small dev-board that has features like micro-USB connector and voltage regulator, as well as easier access to all its pins (like an Arduino board has).</p>

<p>I wanted my circuit to have a small footprint and I also had plans for using the WiFI feature, so I bought a couple of <a href="https://www.amazon.com/gp/product/B07Q576VWZ/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1">ESP32 dev boards</a>. I migrated my code to be compatible with ESP32, which basically was just updating to an ESP32-flavored Servo library.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/esp32-breadboard.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/esp32-breadboard.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Using an ESP32 to control the motor.
</div>

<p>I also updated the circuit to power the motor and the ESP32 from a single battery, but more on that later.</p>

<p>Now that I have the basic circuit for my shade controller, I can start testing it at my balcony. So far I tested my circuit on a breadboard, but I want something more reliable for my first prototype. I took out my soldering iron and built the circuit on a perfboard.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/soldering.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/soldering.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Soldering the components for the shade controller prototype.
</div>

<p>To test it, I hung the shade controller circuit next to the motor with zip-ties and connected the motor to it. The battery is also there at the back, inside a ziplock bag. Nothing too fancy for a first prototype.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/prototype-combina-big.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/prototype-combina-big.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The first shade controller prototype.
</div>

<p>I also added a 2-button remote, for a better accessibility when trying to operate the shade from my balcony chair.</p>

<p>Now that everything is in place, I can test the first prototype:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/rQhZ0Q_558M" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Testing the prototype
</div>

<p><br /></p>

<h2 id="the-first-prototype">The First Prototype</h2>
<p>It was a real treat using my prototype for a couple of weeks! The shade controller worked well - it was responsive and the motor raised that shade like a champ! There was only one problem I found, but before diving into that - let’s first get to know the prototype a little better.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/diagram-prototype.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/diagram-prototype.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Diagram of the shade controller prototype circuit.
</div>

<p>In the diagram on the right there’s the remote, with 2 buttons - up and down. Like we saw earlier in the basic circuit, each button is responsible to spin the motor in a different direction (i.e. clockwise/counter-clockwise). The motor receives the commands from the ESP32 using the cyan/yellow wire.</p>

<p>The circuit is powered by a single 7.4v battery. The motor can run with 5v, but it’ll run faster and provide more torque with a higher voltage. According to its <a href="https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/">spec</a>, the motor’s safest maximum voltage is 7.4v, which is why I picked a 7.4v battery for the job. The motor is connected directly to the battery, but the ESP32 is more sensitive and could be damaged by voltage too high. To be on the safe side, I added a <a href="https://www.adafruit.com/product/1385">DC step-down convertor</a> (a.k.a Buck Converter or BEC - Battery Eliminator Circuit) that will convert the battery’s 7.4v to a steady 5v that will power the ESP32.</p>

<p>The ESP32 chip itself is powered using 3.3v, but the dev-board it comes with has a built-in voltage regulator that can take a higher voltage and step it down to the needed 3.3v. That’s why it’s possible to power it via micro-USB, which provides 5v. When using an ESP32 dev-board, I can either connect a 3.3v power supply to the 3v3 pin, or I can connect 5v to the VIN pin which will first go through the built-in regulator. In the diagram, the DC step-down converter is connected to the battery on one side, where it receives 7.4v, and outputs 5v on the other side, which is connected to the VIN pin using the red wire.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/prototype-mounted-big.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/prototype-mounted-big.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The prototype with the battery powering it.
</div>

<p>After using the prototype for some time, I noticed a problem - the <strong>battery life isn’t great</strong>, a full battery lasted only 5 days.</p>

<p>I got a pretty strong battery, a 6200mAh LiPo 7.4v battery, which is intended for Remote Control race cars. The motor draws between 200mA-3000mA while running, which the battery can handle as it’s designed for operating strong race car motors, but the majority of time the circuit is on standby. While on standby, the ESP32 is powered on and waiting for input from one of the buttons, which consumes about 50mA. The battery’s capacity is 6200mAh, meaning it can power a 50mA device for 124 hours (6200 / 50 = 124), which is a little over 5 days. This aligns with what I saw in practice and explains why the battery doesn’t last that long.</p>

<p>I decided that the best solution is to simply ditch the battery. Why? I can’t see myself optimizing the battery consumption in a significant way. In addition, even if the battery will last a few weeks or a month, I still need to recharge it from time to time and risk having a dead battery when I need the shade. I don’t want to think about it, I want it to <strong>Just Work</strong>.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/circuit-barreljack.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/circuit-barreljack.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Connecting the circuit to a power adapter.
</div>

<p>To support a power adapter, I added a <a href="https://www.adafruit.com/product/373?gclid=Cj0KCQiArvX_BRCyARIsAKsnTxOEqPoVS5H8MBUYNwGpgpWzCSj7SRv3-nlrttM9-tQ5JrCaKR-fR9EaAu2mEALw_wcB">barrel-jack port</a> to my circuit and got a power adapter that supplies 7.5v. A pretty simple modification that means I don’t need to worry about sitting in the sun because I forgot to charge the battery in time.</p>

<p>That was the first modification I made to the shade controller’s circuit, but it was just the beginning. In the next section, I’ll go over a new feature for my shade controller that would require bigger changes, including communicating with an external chip.</p>

<p><br /></p>

<h2 id="supporting-automatic-stops-using-nfc">Supporting Automatic Stops Using NFC</h2>
<p>At this point of the project I got the minimal features for a fully working motorized shade, but I wanted to take this a step further. It takes a single button press to start lowering/raising the shade, but I still need to wait and press the button again in order to stop it.</p>

<p>In most cases, I want to fully lower the shade or fully open it, so it makes sense the controller should know when to stop instead of waiting for me to do it manually. In addition, the shade I have installed in my balcony is larger than the area it needs to cover, so I need to set clear boundaries and prevent lowering it too low or raising it higher than necessary. Otherwise, the motor or the shade’s roller could be damaged, or worse - my downstairs neighbor will come over to complain about the shade dangling above his head. By having a reliable way to know the shade’s position, I can <strong>program the shade controller to stop automatically when reaching a specific position</strong>.</p>

<p>There are several ways this can be accomplished. One way could be calibrating the controller with the time it takes to fully lower / raise the shade, then use this time to know how long the controller should spin the motor  before stopping it. This method is simple to implement but also unreliable, since the duration of lowering/raising the shade could skew over time and require frequent calibrations (e.g. strong winds could pull the shade and create resistance to the motor, which slows it down). Another option is to stick 2 magnets on the shade itself, one at the top and the other at the bottom, then use a <a href="https://www.electronics-tutorials.ws/electromagnetism/hall-effect.html">Hall effect sensor</a> to detect these magnets and stop the motor from rolling the shade past these points. While this could work for simple use cases, it won’t prevent moving the shade past the boundaries the magnets created. For example, pressing “down” will lower the shade until the magnet is reached, but afterwards I can press “down” again to lower the shade further, past the lowest position allowed.</p>

<p>I decided to try an interesting approach - using NFC to read position markers on the shade. The problem with the magnets approach is the fact they aren’t distinguishable, so the shade controller can’t know which magnet is caught by the Hall effect sensor. Using an NFC reader, the shade controller can read NFC tags placed on the shade in different places and decide whether to stop or continue raising/lowering the shade. The NFC tags are distinguishable by their ID, but they also allow writing data in them, which can be used for storing in each NFC tag the position it represents (e.g. “100% open”, “50% open”).</p>

<p>The PN532 is the most popular NFC/RFID chip. Pretty much all the mobile phones who support NFC use this chip, or other chips from the same company, to do things like wireless payments or sharing data between nearby devices. When I started tinkering with NFC I got the <a href="https://www.adafruit.com/product/364">Adafruit PN532 breakout board</a>, but I later got me a <a href="https://www.amazon.com/gp/product/B01I1J17LC/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1">much smaller PN532 module</a>, which works the same and will be easier to mount next to the shade controller.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/pn532.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/pn532.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The PN532 NFC Module.
</div>

<p>There are several ways to connect peripherals to microcontrollers such as the ESP32 or Arduino. A peripheral can be a temperature sensor, LCD display or an external NFC module such as the PN532. Both Arduino and ESP32 support 3 common communication protocols - UART, SPI and I2C. Each protocol has its own benefits/drawbacks and picking which one to use really depends on the use case. SPI for example is much faster than I2C, which means it’s probably better for communicating with LCD displays or sensors that are sampled frequently, but with I2C we can connect a lot more external devices at once.</p>

<p>I decided to connect the PN532 NFC module using I2C ( = inter-integrated circuit), because it’s a simpler connection but also for a reason I’ll cover a little later. Here’s a diagram showing how everything is connected:</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/diagram-final.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/diagram-final.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Diagram of the main circuit connected to the PN532 NFC module.
</div>

<p>There are 4 main wires necessary to connect the PN532 to the ESP32. First the power pins, VCC and GND, are connected using the blue and green wires to the 3v3 and GND pins on the ESP32. These will give the PN532 the 3v it needs to be powered. Next are the communication pins - for the I2C protocol we need to connect the SCL (clock line) and SDA (data line) pins to the equivalent pins on the microcontroller, which for the ESP32 are the D22 and D24 pins. In the diagram, these are represented by the white and purple wires. The orange wire is connected to the RESET pin, it’s optional and used to reset the device if needed. The yellow wire is connected to the IRQ pin, which will be discussed a bit later.</p>

<p>There’s another connection we need to make for the I2C interface to work properly - the SCL and SDA pins also need to be connected to the power line (i.e. the 3v3 pin). This is necessary due to the open drain design of I2C - during data transfer the SDA/SCL lines are pulled low, which is a problem if other devices also try to communicate. To make I2C work, we need to keep these lines high by allowing power from the 3v3 pin to come through. But, the power can be too strong, which is why I had to connect 1.5kΩ resistors per line (I didn’t have a single 1.5kΩ resistor, so I just connected 3 that totaled in 1.5kΩ). There’s more discussion on this subject <a href="https://forums.adafruit.com/viewtopic.php?f=19&amp;t=88591">here</a>.</p>

<p>Writing the code to interact with the NFC chip was pretty straightforward using the <a href="https://github.com/adafruit/Adafruit-PN532">Adafruit PN532 library</a> - there’s an API method that starts listening for cards/tags, waits for a card to come close to the reader and reads its data when that happens. It looks simple, but there’s one major problem for my use-case - the command that starts listening for NFC cards <strong>is a blocking call</strong>. This means my microcontroller, the ESP32, is essentially stuck waiting for NFC tags and can’t respond to other inputs, such as button presses. Here’s how this looks in the code:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Pin definitions</span>
<span class="cp">#define PN532_IRQ   (2)
#define PN532_RESET (4)
</span>
<span class="c1">// ...</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// ...</span>

  <span class="c1">// The DOWN button is pressed  </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">btnDownCurr</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">&amp;&amp;</span> <span class="n">btnDownPrev</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">raisingShade</span> <span class="o">||</span> <span class="n">loweringShade</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stopShade</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">lowerShade</span><span class="p">();</span>

      <span class="c1">// Wait for the NFC module to detect a card or a tag and read it.</span>
      <span class="c1">// This is a BLOCKING call.</span>
      <span class="n">success</span> <span class="o">=</span> <span class="n">nfc</span><span class="p">.</span><span class="n">readPassiveTargetID</span><span class="p">(</span><span class="n">PN532_MIFARE_ISO14443A</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uidLength</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get card ID and check if we need to stop the motor</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure>

<p>For example, say I press the “down” button to lower the shade all the way down. While the motor is running, the ESP32 will activate the NFC module and wait for the NFC tag that signals the end of the shade. But, during this time the buttons aren’t responsive, which means there’s nothing I can do to stop lowering the shade before it reaches the end.</p>

<p>I needed to find a way to make the microcontroller wait for NFC tags and <strong>still be responsive</strong> to new commands, but there were no API methods to help with that. I saw others use a second ESP32 with the sole purpose of waiting for NFC cards, then communicating that to the first ESP32. That’s probably an overkill.. I decided to dig a little deeper into the NFC module’s spec sheet and find a better solution.</p>

<p>According to the <a href="https://www.nxp.com/docs/en/user-guide/141520.pdf">PN532 user manual</a>, we can use the chip’s IRQ pin in order to be notified asynchronously when a card is detected. The IRQ line is an optional connection we can make between the host controller (i.e. The ESP32) and the PN532 NFC module. When everything is connected and working, the PN532 will continuously send high voltage in the IRQ line, which essentially means we’ll get a binary 1 value whenever we read from that pin. When the PN532 has some response it wants to notify the host controller about (e.g. new NFC card/tag was detected) - it momentarily drives this line low ( = sends a binary 0 instead of 1 for a short amount of time).</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/pn532-sequence.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/pn532-sequence.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Sequence diagram showing the changes in the IRQ line when messages are sent and received between the ESP32 and PN532.
</div>

<p>I connected the IRQ pin using the yellow wire in the diagram above, then updated my code to keep track of its value. The ability to use the IRQ line is the reason I chose the I2C protocol over SPI and UART - the Adafruit PN532 library supports the IRQ pin only when connected using I2C. However, this library didn’t include a non-blocking API to put the NFC module in a card detection state. So.. I just added new API methods myself! Here’s the updated code:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// API for the NFC module (PN532 chip)</span>
<span class="n">Adafruit_PN532</span> <span class="nf">nfc</span><span class="p">(</span><span class="n">PN532_IRQ</span><span class="p">,</span> <span class="n">PN532_RESET</span><span class="p">);</span>

<span class="c1">// Supported NFC tags for each shade position (0%, 100% etc.)</span>
<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">CARDID_100_PERCENT</span> <span class="o">=</span> <span class="mi">3952824665</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">CARDID_0_PERCENT</span> <span class="o">=</span> <span class="mi">913822226</span><span class="p">;</span>

<span class="c1">// ..</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PN532_IRQ</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>

  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Main function that loops as long as the controller is powered on</span>
<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">irqCurr</span> <span class="o">=</span> <span class="n">digitalRead</span><span class="p">(</span><span class="n">PN532_IRQ</span><span class="p">);</span>

  <span class="c1">// ...</span>

  <span class="c1">// The DOWN button is pressed</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">btnDownCurr</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">&amp;&amp;</span> <span class="n">btnDownPrev</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">raisingShade</span> <span class="o">||</span> <span class="n">loweringShade</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">stopShade</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">lowerShade</span><span class="p">();</span>

      <span class="c1">// Puts the NFC module on a listening mode, a NON-BLOCKING call</span>
      <span class="n">nfc</span><span class="p">.</span><span class="n">startPassiveTargetIDDetection</span><span class="p">(</span><span class="n">PN532_MIFARE_ISO14443A</span><span class="p">);</span>
      <span class="n">listeningToNFC</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// If the NFC module is currently listening and we’re notified via the</span>
  <span class="c1">// IRQ line that a card was detected</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">listeningToNFC</span> <span class="o">&amp;&amp;</span> <span class="n">irqCurr</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">&amp;&amp;</span> <span class="n">irqPrev</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Read the detected NFC tag's info</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">nfc</span><span class="p">.</span><span class="n">readDetectedPassiveTargetID</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uidLength</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If the tag is valid, we'll read its ID</span>
      <span class="kt">uint32_t</span> <span class="n">cardId</span> <span class="o">=</span> <span class="n">getCardId</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uidLength</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cardId</span> <span class="o">==</span> <span class="n">CARDID_0_PERCENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loweringShade</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Found the "0% open" position tag while lowering the shade, </span>
          <span class="c1">// we can stop because the shade is now fully closed</span>
          <span class="n">stopShade</span><span class="p">();</span>
          <span class="n">listeningToNFC</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raisingShade</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Ignoring.. </span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cardId</span> <span class="o">==</span> <span class="n">CARDID_100_PERCENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Similar implementation as above.</span>
        <span class="c1">// Stop raising the shade when the CARDID_100_PERCENT tag is detected, </span>
        <span class="c1">// since the shade is now fully open.</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// If we didn't stop the motor and still need to listen to NFC tags</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listeningToNFC</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

      <span class="c1">// Puts the NFC module on a listening mode again</span>
      <span class="n">nfc</span><span class="p">.</span><span class="n">startPassiveTargetIDDetection</span><span class="p">(</span><span class="n">PN532_MIFARE_ISO14443A</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure>

<p>Using the new API, I put the NFC module in a detection mode without blocking. During this time, if the IRQ value changes from HIGH to LOW - we know a card/tag was detected and it’s time to try reading it. Each NFC tag represents a shade position (e.g. 0% opened), which will help determine whether the motor needs to be stopped. We can attach more NFC tags to the shade and support more “shade presets”, like 50% or 25% open.</p>

<p>The new API methods I added were merged into the PN532 library, now everyone can use them! There’s more info in the  <a href="https://github.com/adafruit/Adafruit-PN532/pull/82">pull-request I made on Github</a>.</p>

<p>With these changes, the up/down buttons are always responsive and the motor can be stopped either by pressing any of the buttons or when the NFC module is reading the appropriate NFC tag. The next video demonstrate this in my development environment, note how I use a different NFC tag to stop each spin direction:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/5fkpSk1L73I" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Testing the new NFC-based auto-stop mechanism
</div>

<p>By the way, I could’ve used another Arduino feature called <a href="https://learn.sparkfun.com/tutorials/processor-interrupts-with-arduino/all">Interrupts</a> to listen and react to changes in the IRQ line. While interrupts might seem as a more elegant implementation, they also cause disruptions to the execution flow which made the shade controller unreliable in some situations. With more effort, I might be able to get interrupts to work for me, but for now I chose the approach above for its flexibility and consistency.</p>

<p>To test this NFC-based positioning system on my balcony shade, I need to put it close to the shade. For that, I got a plastic sheet <a href="https://www.amazon.com/gp/product/B07MG8KTBX/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;th=1">from Amazon</a> to hold the NFC module on one side and supports the shade on the other. The shade rests on this plastic sheet as it moves up or down, allowing the NFC module to read the NFC tag that’s on the shade. In my first test, I attached an NFC tag on the shade using 2 of my daughter’s hair clips (I couldn’t find a stapler ¯\_(ツ)_/¯ ), and verified the shade controller stops the motor after detecting the NFC tag.</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/pWtwcLzs28E" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Testing the shade controller auto-stops when reaching the end.
</div>

<p>The NFC module can read tags that are up to 2 inches away, which is more than enough for my setup, as long as the reader is aligned with the NFC tag attached to the shade.</p>

<p>Supporting automatic stops is a big step up for my shade controller. This new feature is making the shade controller more user friendly, robust and reliable. It’s also the foundation for the next major feature - voice command.</p>

<p><br /></p>

<h2 id="hardware-facelift">Hardware facelift</h2>
<p>My shade controller is more automatic now, but how about making it look more professional? It’s a little too fragile (especially with children around), not weather resistant and looks kinda hacky. Before adding more software features, I decided to spend some time polishing the hardware side, making it more user friendly and sustainable.</p>

<p>As a first step, I created a switch box to replace the remote I created earlier.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/improve-btns.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/improve-btns.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The old remote alongside the new waterproof switch box.
</div>

<p>I drilled a couple of holes into a waterproof plastic box, where I installed the 2 waterproof buttons. I organized all the wires inside cable channels to protect them from the rain, and more importantly - my kids. Besides the robustness of the new switch box, it’s also a lot nicer than that hacky-looking remote.</p>

<p>The main circuit used to sit inside its own box next to the motor, but that was before I added the NFC module. For a cleaner look, I put both of them in the same box and mounted it on that plastic sheet the shade is resting on. The NFC module is still positioned close enough to read NFC tags from the shade.</p>

<p>While I was doing that, I figured I could reduce the footprint even further by trimming the plastic sheet, since I don’t really need it to be this big. I took a hacksaw and removed a significant chunk of it.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/improve-main-before.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/improve-main-before.jpg" /> 
	</a>
</div>
<div class="image-spacer"></div>
<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/improve-main-after.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/improve-main-after.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Before and after the changes to the main circuit housing.
</div>

<p>Now I have the same shade controller, just better looking and with a much smaller footprint. This will be useful when I’ll need to explain all this to my wife</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/improve-wall.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/improve-wall.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Now that looks a lot nicer!.
</div>

<p>As one last improvement, I wanted to polish my circuit and create a PCB (Printed Circuit Board) to replace the perfboard I was using this far. Perfboards are a great way to quickly create and iterate on a prototype; they are less flexible than breadboards, but more sustainable and reliable. Now that I’m done with hardware changes, at least for the near future, a PCB will look a lot nicer and reduces the amount of loose wires that could be accidentally damaged.</p>

<p>I never designed PCBs before, but it was simpler than I thought. I found <a href="https://easyeda.com/">EasyEDA</a>, which is an online tool (and a Mac app) for designing PCBs and also ordering them directly from the tool. I started by creating the schematic design of my circuit:</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/easyeda-schematic.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/easyeda-schematic.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The schematic design of the shade controller circuit.
</div>

<p>The schematic is then used by EasyEDA to generate a PCB design. The design has all the components connected to each other, so I just moved components around to arrange them a little better, added labels and other small tweaks. Here’s what I came up with:</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/easyeda-pcb.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/easyeda-pcb.jpg" /> 
	</a>
</div>
<div class="image-spacer"></div>
<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/pcb-empty.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/pcb-empty.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The PCB design in EasyEDA and the PCB I received.
</div>

<p>The red and blue lines, in the PCB design, are the wires that connect the different components on the PCB and are generated based on the circuit’s schematic design. The reds are on the top layer of the PCB and the blues are on the bottom layer. This layer separation is necessary because the wires cannot cross each other and there isn’t always a way around to get the wire where it needs to go. Complex circuits might require moving components around in order to allow all the wires to be connected. There’s also an option to add images and text to the PCB, so I added a small logo and versioning information.</p>

<p>EasyEDA has the option to directly order the PCB from <a href="https://jlcpcb.com/">JLCPCB</a>, a Chinese company that manufactures PCBs. I picked the color I wanted (there are 6 options!) and paid the $2 the PCBs cost (+ $16 shipping to the US), then waited about a week until they arrived (min. of 5 PCBs per order). After some quality time with my soldering iron, I got me a slick new shade controller circuit:</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/pcb-migration-front.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/pcb-migration-front.jpg" /> 
	</a>
</div>
<div class="image-spacer"></div>
<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/pcb-migration-back.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/pcb-migration-back.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The old circuit compared to the PCB I designed.
</div>

<p>Improving the look and feel of a product is not just a cosmetic change best saved for last, it can be an important step in the testing phase. With these improvements, I made the shade controller more accessible and user friendly. I feel more confident letting my kids use it now, which might expose usage problems I didn’t see before. Plus, it’s nice to clean up a bit before moving forward, it’s more fun to use a polished product and it helps seeing potential problems more clearly.</p>

<p><br /></p>

<h2 id="supporting-voice-commands-via-google-assistant">Supporting Voice Commands via Google Assistant</h2>
<p>One of the reasons I switched very early on from an Arduino board to ESP32, is the WiFi support. This opens up new possibilities for my shade controller, the main one I was after is supporting Google Assistant and responding to voice commands. This is the change that will upgrade the shade controller to be a “smart shade controller” 😎.</p>

<p>There are a couple of ways I could use the WiFi support for controlling my circuit remotely. With a web server running on the ESP32, I can connect clients directly to it and communicate over HTTP requests/responses. The web server can be accessible on the internet or by a direct connection (<a href="https://randomnerdtutorials.com/esp32-client-server-wi-fi/">example project</a> that connects two ESP32s to each other without internet). While creating a web server on the ESP32 is a powerful feature, it has a few disadvantages such as a large overhead per message, speed and battery performance.</p>

<p>Another way to communicate with an ESP32 via WiFi is by using MQTT, a lightweight messaging protocol. MQTT is more performant and lightweight than HTTP, it also provides a simpler two-way communication mechanism between the ESP32 and its clients. For these reasons, MQTT is the preferred method for communicating with IoT devices. To use MQTT we first need an MQTT broker, which is a fancy name for an MQTT server. Any message sent to the broker needs to include a “topic”, then only clients subscribed to that topic will receive that message.</p>

<p>To set up MQTT for my shade controller, I can create an MQTT server in my local network (using <a href="https://mosquitto.org/">Mosquitto</a>) or use a cloud service such as <a href="https://blynk.io/">Blynk</a> or <a href="https://learn.adafruit.com/welcome-to-adafruit-io">Adafruit IO</a>. My needs are very simple and the free tier of a cloud service should suffice. I picked Adafruit IO, set up my account and added a new feed (i.e. MQTT Topic) for my project, called “shade-open”. In the web console, I can create a dashboard and see the latest value sent to that feed.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/adafruitio-dashboard.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/adafruitio-dashboard.jpg" /> 
	</a>
</div>
<div class="image-caption">
	My shade controller dashboard on Adafruit IO.
</div>

<p>To integrate and use Adafruit IO in the shade controller, I added their Arduino library into my project and made some changes:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#define IO_USERNAME  "&lt; AIO Username &gt;"
#define IO_KEY       "&lt; AIO KEY &gt;"
</span>
<span class="cp">#define WIFI_SSID "&lt; Wifi SSID &gt;"
#define WIFI_PASS "&lt; Wifi password &gt;"
</span>
<span class="cp">#include</span> <span class="cpf">"AdafruitIO_WiFi.h"</span><span class="cp">
</span>
<span class="n">AdafruitIO_WiFi</span> <span class="nf">io</span><span class="p">(</span><span class="n">IO_USERNAME</span><span class="p">,</span> <span class="n">IO_KEY</span><span class="p">,</span> <span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASS</span><span class="p">);</span>

<span class="c1">// Adafruit IO feed showing how much the shade should be open (either 0% or 100%)</span>
<span class="n">AdafruitIO_Feed</span> <span class="o">*</span><span class="n">balconyShade</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">feed</span><span class="p">(</span><span class="s">"shade-open"</span><span class="p">);</span>

<span class="n">boolean</span> <span class="n">connectingInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="c1">// …</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Keep the connection alive, if already connected.</span>
  <span class="c1">// Times-out after 400ms to keep the microcontroller responsive.</span>
  <span class="n">aio_status_t</span> <span class="n">ioStatus</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

  <span class="c1">// Connect to Adafruit IO, if connected then subscribe to the feed</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ioStatus</span> <span class="o">&lt;</span> <span class="n">AIO_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">connectingInProgress</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">connectingInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">io</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>       
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioStatus</span> <span class="o">&gt;=</span> <span class="n">AIO_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">connectingInProgress</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">connectingInProgress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	
    <span class="c1">// Subscribe to the "shade-open" feed</span>
    <span class="n">balconyShade</span><span class="o">-&gt;</span><span class="n">onMessage</span><span class="p">(</span><span class="n">handleShadeLevelMessage</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// This function is called when a new message is sent to the “shade-open” feed.</span>
<span class="kt">void</span> <span class="n">handleShadeLevelMessage</span><span class="p">(</span><span class="n">AdafruitIO_Data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Got a new message with the percent the shade should be open </span>
  <span class="kt">int</span> <span class="n">percentOpen</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
  
  <span class="c1">// If we're asked to open the shade to 100%, then raise it. Open to 0% means closing/lowering the shade.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">percentOpen</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">raiseShade</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">percentOpen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lowerShade</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span></code></pre></figure>

<p>The code connects to Adafruit IO cloud service and keeps the connection alive by calling the <em>io.run()</em> method in the main loop function. When a new message is posted to the “shade-open” feed, the callback function is called and sends the appropriate command to the motor.</p>

<p>I implemented the Adafruit IO integration a little bit differently than the examples they provide. In their <a href="https://github.com/adafruit/Adafruit_IO_Arduino/blob/master/examples/adafruitio_00_publish/adafruitio_00_publish.ino">examples</a>, the microcontroller is blocked from doing anything until it’s connected to the cloud. I didn’t like the fact I won’t be able to use the physical buttons to control the shade while the controller is trying to connect to the cloud (do I really need to sit in the sun if my network is down or very slow?!). The code I wrote is more responsive and allows the controller to work offline, while still trying to regain connectivity. I tested the integration worked by sending MQTT messages from the Adafruit IO web console and verified they were received by the ESP32.</p>

<p>Now let’s move to the final part - controlling the shade from Google Assistant. This was probably the easiest part of this entire project. The shade controller can already take commands from the web using MQTT, so if we want Google Assistant to control it - we need to connect the two.</p>

<p><a href="https://ifttt.com/adafruit">IFTTT</a> (If-this-then-that) is a great tool for connecting different web services and products to each other. It supports integrations with Google Assistance and  Adafruit IO, so all I needed to do is authenticate to both services and create rules (called “Applets”) to communicate between them. For my use case, I created an applet that reacts to a Google Assistant command to open or close the shade and sends data to a specific feed on my Adafruit IO account.</p>

<div class="outer-grid">
	<div class="inner-grid">
		<a href="/assets/images/automating-balcony-shade-with-nfc/ifttt1.png">
			<img src="/assets/images/automating-balcony-shade-with-nfc/ifttt1.png" /> 
		</a>
	</div>
	<div class="inner-grid">
		<a href="/assets/images/automating-balcony-shade-with-nfc/ifttt2.png">
			<img src="/assets/images/automating-balcony-shade-with-nfc/ifttt2.png" /> 
		</a>
	</div>
	<div class="inner-grid">
		<a href="/assets/images/automating-balcony-shade-with-nfc/ifttt3.png">
			<img src="/assets/images/automating-balcony-shade-with-nfc/ifttt3.png" /> 
		</a>
	</div>
</div>
<div class="image-caption">
	My IFTTT configuration for opening the shade from Google Assistant.
</div>

<p>When I say “OK Google, Open the balcony shade”, Google Assistant will send the value “100” to the “shade-open” feed. The shade controller receives this message through Adafruit IO and raises the shade until it reaches the NFC tag that signals the shade is 100% open.</p>

<p>Here’s everything in action:</p>

<div class="media-center">
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/lLbN8Sc2E9Q" width="540" height="960" frameborder="0" allowfullscreen="">
  </iframe>
</div>
</div>
<div class="video-caption">
	Testing voice command from Google Assistant.
</div>

<p>Nice!</p>

<p><br /></p>

<h2 id="final-thoughts-and-tips">Final thoughts and tips</h2>
<p>I spent weeks working on this project, I love how it turned out and what I gained from it. Operating my balcony shade is more convenient for sure, but that’s not even the most useful outcome of this project. For years, I’ve used software to improve different aspects of my life, but now I’ve gained the experience and confidence to build custom electrical products and unlocked a new type of solutions I can improve my life with. The potential is huge and I’m excited to see what I will do with it next.</p>

<p>I learned a lot of new things in this project, not all about electronics, and I think the best way to learn is to simply get your hands dirty and dig deeper as problems arise. I figured it’s worth mentioning a few quick tips from my experience working on this project, some I learned the hard way:</p>

<p>While I knew I wanted to add NFC support from the beginning, I went with an <strong>iterative approach</strong> - started with a simple circuit and made changes in steps. This might take a bit longer than completing the vision in one go, but it helps seeing and fixing problems early, before they become bigger or harder to pinpoint. The battery life problem is a good example for something I didn’t put too much thought into, but I was able to fix it before getting into the more complex NFC issues that came later.</p>

<p>I also recommend having a simple way to use the circuit in a <strong>development environment</strong>. After I mounted the motor and the switch box, I was still able to take the main circuit to my desk and debug problems using a simpler motor and remote. I also added a flag in the code for disabling the NFC, so I won’t have to connect an NFC module in my development environment unless I need to. This was really convenient and greatly improved my development process.</p>

<p><strong>Breadboards can be unreliable</strong>, take that into account when testing your circuits. I spent hours on a problem with the NFC module, which turned out to be a result of jumper cables that got momentarily disconnected and caused weird state issues. If the circuit is not expected to change much, consider doing it on a perfboard.</p>

<p>Soldering is an important skill and having the right tools can make a big difference. My circuits looked a lot more professional and less frustrating to make after I got me a <a href="https://www.amazon.com/gp/product/B07LGLWGZ5/ref=ppx_yo_dt_b_search_asin_image?ie=UTF8&amp;psc=1">helping hand</a> - a <strong>soldering tool</strong> with arms for holding the circuit and other components while soldering. It also includes a strong light and magnifying glass.</p>

<p>One more soldering tip - some components are just hard to solder straight (I’m looking at you headers!). I learned I can use <a href="https://www.amazon.com/dp/B074R75LH1/ref=cm_sw_em_r_mt_dp_Ogp7FbP40B436?_encoding=UTF8&amp;psc=1">sticky mounting tabs</a> to <strong>steadily position the components while soldering them</strong>. Really useful and made my circuits look more professional.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/tips-mounting-tabs.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/tips-mounting-tabs.jpg" /> 
	</a>
</div>
<div class="image-caption">
	Soldering headers with mounting tabs.
</div>

<p>There was a lot of drilling in this project, and I learned a lot about types of surfaces and drills, but I think the highlight is getting to know the <a href="https://www.amazon.com/dp/B07NKXLTCB/ref=cm_sw_em_r_mt_dp_R6xWFbNZJNW16">Step Drill</a> for <strong>drilling perfect round holes</strong> in plastic boxes. I found out about this awesome drill bit after spending way too much time drilling holes in the switch box, for inserting the 2 up/down buttons. The Step drill can make the same holes in seconds, and perfectly round too. I think it’s a must for projects like this.</p>

<div class="media-center">
	<a href="/assets/images/automating-balcony-shade-with-nfc/step-drill.jpg">
		<img src="/assets/images/automating-balcony-shade-with-nfc/step-drill.jpg" /> 
	</a>
</div>
<div class="image-caption">
	The Step drill bit and the clean hole I made with it.
</div>

<p>That’s all! The source code and designs are available in the Resources section below, in addition to the list of components I used and other useful resources for this and similar projects.</p>

<p><br /></p>

<h2 id="resources">Resources</h2>
<p>The source files are available on Github, including the Fritzing diagrams, PCB schematic and Gerber files.</p>

<p><a href="https://github.com/Udinic/smartShadeController">https://github.com/Udinic/smartShadeController</a></p>

<p>The full parts list:</p>
<ul>
  <li>ESP32 Dev-board [<a href="https://www.amazon.com/gp/product/B07Q576VWZ/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1&amp;fpw=alm">Amazon</a>]</li>
  <li>PN532 NFC module [<a href="https://www.amazon.com/HiLetgo-Communication-Arduino-Raspberry-Android/dp/B01I1J17LC/ref=sxts_sxwds-bia-wc-drs1_0?cv_ct_cx=pn532&amp;dchild=1&amp;keywords=pn532&amp;pd_rd_i=B01I1J17LC&amp;pd_rd_r=625c7ef6-462a-4aa4-9587-8b7ff990436d&amp;pd_rd_w=O7fj7&amp;pd_rd_wg=jacP8&amp;pf_rd_p=c33e4373-edb9-47f9-a7e6-5d3d6a7a4ad0&amp;pf_rd_r=AMD8MZN7FS1WPQTJGH86&amp;psc=1&amp;qid=1607317072&amp;sr=1-1-5e875a02-02b1-4426-9916-8a5c26cd5a14">Amazon</a>]</li>
  <li>Servo motor [<a href="https://www.servocity.com/sg12-series-servo-gearbox-2-1-ratio-continuous-rotation-700-oz-in-31-3-rpm/">ServoCity</a>]</li>
  <li>Waterproof plastic box [<a href="https://www.amazon.com/gp/product/B07C6W5MN4/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1">Amazon</a>]</li>
  <li>Bracket for connecting the motor to the crank [<a href="https://www.servocity.com/lightweight-linear-actuator-mounting-bracket/">ServoCity</a>]</li>
  <li>Structural components for mounting [<a href="https://www.servocity.com/structure/">ServoCity</a>]</li>
  <li>Servo extension cords [<a href="https://www.amazon.com/dp/B07BQMS1JV/ref=cm_sw_r_tw_dp_h5BZFbQ86XA19?_x_encoding=UTF8&amp;psc=1">Amazon</a>]</li>
  <li>Barrel jack connector [<a href="https://www.adafruit.com/product/373?gclid=CjwKCAiAn7L-BRBbEiwAl9UtkJhH8XqXyK7Sm-5B5ml_mp9IU7h-2Blk8scO0Ig0RNnKCLC5b1yfmxoCOhMQAvD_BwE">Adafruit</a>]</li>
  <li>2x 330Ω, 220Ω and1kΩ resistors [<a href="https://www.amazon.com/Elegoo-Values-Resistor-Assortment-Compliant/dp/B072BL2VX1/ref=sr_1_3?crid=3CIQCTPZLFIGO&amp;dchild=1&amp;keywords=resistors&amp;qid=1607317189&amp;s=industrial&amp;sprefix=resis%2Cindustrial%2C154&amp;sr=1-3">Amazon</a>]</li>
  <li>Buck Converter [<a href="https://www.adafruit.com/product/1385">Adafruit</a>]</li>
  <li>Headers [<a href="https://www.amazon.com/Header-Lystaii-Pin-Connector-Electronic/dp/B06ZZN8L9S/ref=sr_1_2?crid=2YEXP032IUD8O&amp;dchild=1&amp;keywords=headers+electronics&amp;qid=1607317221&amp;sprefix=headers+elec%2Caps%2C165&amp;sr=8-2">Amazon</a>]</li>
  <li>Terminal block [<a href="https://www.amazon.com/dp/B01MT4LC0F/ref=cm_sw_em_r_mt_dp_xEBZFbGJ0RPX3">Amazon</a>]</li>
  <li>Waterproof buttons [<a href="https://www.amazon.com/gp/product/B079HR5Q4R/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1&amp;fpw=alm">Amazon</a>]</li>
  <li>Switch box [<a href="https://www.amazon.com/gp/product/B07C6S4Y7D/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1&amp;fpw=alm">Amazon</a>]</li>
  <li>Acrylic sheet [<a href="https://www.amazon.com/gp/product/B07MG8KTBX/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1&amp;fpw=alm">Amazon</a>]</li>
  <li>Power adapter [<a href="https://www.amazon.com/gp/product/B01MT5WVCG/ref=ppx_yo_dt_b_search_asin_title?ie=UTF8&amp;psc=1&amp;fpw=alm">Amazon</a>]</li>
  <li>Perfboard [<a href="https://www.amazon.com/dp/B01KJMN7OY/ref=cm_sw_r_tw_dp_x_AQBZFb7THRB8W">Amazon</a>]</li>
</ul>

<p>A few useful places that helped me along the way:</p>

<p><a href="https://www.servocity.com/">ServoCity</a> - Where I bought the motor and a lot of other structural components that helped me mount the motor. Great site to look for interesting parts for different types of projects.</p>

<p><a href="https://www.adafruit.com/">Adafruit</a> - I got many of my components from Adafruit, they open-sourced great Arduino libraries and operate helpful forums. A must have for any hobbyist.</p>

<p><a href="https://www.sparkfun.com/">SparkFun</a> - I liked their <a href="https://learn.sparkfun.com/tutorials/where-do-i-start#starter-tutorials">“where do I start” tutorials</a>, which are a great refresher for the basics. SparkFun also makes and sells components, much like Adafruit.</p>


       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    October
    29th,
    
    2015
  </span>

  <h2>
    <a href="/2015/10/29/introducing-grabag/">Introducing "Grabag" - a simple way to watch TV.</a>
  </h2>

  <div>
    
    
       <p><em>UPDATE (09/2020): While I discontinued working on Grabag, this might still worth the read as the idea still lives on. To this day, I keep seeing this type of product being requested by people.</em></p>

<p>About a year ago, I cut the cords and canceled my cable subscription. I watch a lot of TV shows, but I stream everything anyway, and avoiding all the commercial breaks is a bliss.</p>

<p>But there was one thing I found hard to do after that - finding something random to watch.</p>

<p>I often like to watch an episode of something while eating dinner, or put in the background while I’m working on my computer. When I had cable, I would just put on a channel that plays South Park, Family Guy or some other light TV show episode. But without cable, I’d find myself open each streaming app and browse the episodes for the shows I like. In many occasions, I didn’t even care what should I watch, but the process still took me a few minutes each time (see <a href="http://www.ted.com/talks/barry_schwartz_on_the_paradox_of_choice">The Paradox of Choice</a>). That gave me the idea for an app that liberates me from making that decision over and over again, and that’s how Grabag was born.</p>

<p>Grabag (<a href="http://www.merriam-webster.com/dictionary/grab%20bag">Grab Bag</a>) is very simple - pick the shows you like, and the app will randomly select an episode for you, along with a short description and a direct link to open it on an app that streams it (e.g. Hulu, HBO Go, Google Play). Here’s the main screen, where all the selected shows are listed:</p>

<p><a href="/assets/images/introducing-grabag/main_screen.png"><img src="/assets/images/introducing-grabag/main_screen_sm.png" alt="img" class="center-image" /></a></p>

<p>Clicking on each banner will pick a random episode for that show, and picking a random episode from all the shows is done using the bottom-right “random” button. Here’s an example for an episode:</p>

<p><a href="/assets/images/introducing-grabag/episode-familyguy.png"><img src="/assets/images/introducing-grabag/episode-familyguy_sm.png" alt="img" class="center-image" /></a></p>

<p>Don’t like that one? No worries, just scroll right and get more.</p>

<p><a href="/assets/images/introducing-grabag/vid_episodes_scroll.gif"><img src="/assets/images/introducing-grabag/vid_episodes_scroll.gif" alt="img" class="center-image" /></a></p>

<p>To watch it, click on the streaming service button. That’s a direct link to play the episode on that app. You can later cast it to your TV, if you’d like.</p>

<p>There’s no sign-in requirement and the app is free.</p>

<p><br /></p>

<h2 id="beta-testing">Beta testing</h2>

<p>I’ve been working on this app for a while now, and I’ve used it myself many times. I decided to make a beta release, getting users’ feedback, and later release it to the public. If you’re interested in joining the beta, just use this link to become a tester and download the app:</p>

<p><br /></p>

<p style="font-size: 150%; text-align: center;"><a href="https://play.google.com/apps/testing/com.udinic.grabag">BECOME A TESTER</a></p>

<p><br /></p>

<p>Note: it takes a minute to be added to the beta testing program, so if you can’t download the app - try again in a minute or two.</p>

<p>Your feedback is very important to me, so I made it very simple for you. You can send your feedback in 2 ways:</p>

<ul>
  <li>From the app, press the feedback button and write a direct email to me.</li>
</ul>

<p><a href="/assets/images/introducing-grabag/feedback2.png"><img src="/assets/images/introducing-grabag/feedback2.png" alt="img" /></a></p>

<ul>
  <li>Using the Google+ <a href="https://plus.google.com/communities/113984360926167804714">Grabag Beta Testers community</a></li>
</ul>

<p><br /></p>

<p>The app currently supports only “Hulu” and “Google Play Movies”, but other streaming services will be added real soon.</p>

<p>I hope this app will make your TV shows watching experience much simpler and relaxed, as it did for me. If you have an idea how to make it even better - don’t hesitate to contact me.</p>

<p>Oh yeah - and tell your friends!</p>

       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    September
    15th,
    
    2015
  </span>

  <h2>
    <a href="/2015/09/15/speed-up-your-app/">Speed up your app (DroidCon Talk)</a>
  </h2>

  <div>
    
    
       <p>A few weeks ago, I gave a talk about Android Performance Optimization, at Droidcon NYC.</p>

<p>I invested a lot of time in this presentation, since I wanted to show real examples for performance issues, and how to identify them with the available tools. I had to cut down about a half of my slides because I didn’t have enough time to show everything. In this post, I’ll summarize everything I was talking about, and show examples I didn’t have time to go over.</p>

<p>The talk was recorded and you can watch it here:</p>
<div class="embed-container">
  <iframe src="https://www.youtube.com/embed/v3DlGOQAIbw" width="700" height="480" frameborder="0" allowfullscreen="">
  </iframe>
</div>

<p>The slides are also available:</p>

<div style="width: 70%">
<script async="" class="speakerdeck-embed" data-id="596740dd42254419935aa604d098f2d3" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>
</div>

<p>Now, Let’s go over some of the important things I was talking about, hopefully I can give a deeper explanation for everything, starting with the basic rules I follow when I work on optimizations:</p>


       
          <a class="btn-default btn" href="/2015/09/15/speed-up-your-app/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    June
    4th,
    
    2015
  </span>

  <h2>
    <a href="/2015/06/04/yet-another-blog-setup-post/">Yet another blog setup post</a>
  </h2>

  <div>
    
    
       <p>After several years of using Wordpress.com for my blog - I decided I need a change.</p>

<p>I wanted to move to something different for a while, but kept postponing it because that would require some time and effort to do. In this post, I’ll summarize my transition experience and elaborate on problems I had and how I solved them. Hopefully, this information will help others with similar ambitions.</p>


       
          <a class="btn-default btn" href="/2015/06/04/yet-another-blog-setup-post/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    July
    24th,
    
    2014
  </span>

  <h2>
    <a href="/2014/07/24/aosp-part-3-developing-efficiently/">AOSP Part 3: Developing Efficiently</a>
  </h2>

  <div>
    
    
       <p><img src="/assets/images/2014-07-24-aosp-part-3-developing-efficiently/turtle-computer-cuny.jpg" alt="Turtle-Computer-CUNY" class="center-image" /></p>

<p>The AOSP codebase in big.</p>

<p>Developing on the AOSP is not as simple as writing an app, where you execute a nice gradle target and poof! you see it on the device. So far in this series, we discussed how to <a href="http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">get the AOSP code into our environment</a>, and how to <a href="http://udinic.wordpress.com/2014/06/04/aosp-part-2-build-variants/">build this code into a sweet flashable Android image files</a>. We can now fill in the missing piece – how to <strong>efficiently</strong> develop for such an enormous system.</p>

<p>In this post, I will cover:</p>

<ul>
  <li>
    <p>Properly importing an AOSP repository into your source control</p>
  </li>
  <li>
    <p>Use better ways to build modules and deploy to the device</p>
  </li>
  <li>
    <p>Writing scripts for faster development process</p>
  </li>
</ul>

<p>I’ll use Git and Bash commands that you may not know, but can definitely search and learn as we go. You can also use this <a href="http://linuxconfig.org/bash-scripting-tutorial">simple Bash scripting tutorial</a> to get started.</p>


       
          <a class="btn-default btn" href="/2014/07/24/aosp-part-3-developing-efficiently/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    June
    4th,
    
    2014
  </span>

  <h2>
    <a href="/2014/06/04/aosp-part-2-build-variants/">AOSP Part 2: Build variants</a>
  </h2>

  <div>
    
    
       <p>On the <a href="http://udinic.wordpress.com/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">previous post</a>, we got the AOSP code into our environment and learned how that process works. The _repo _tool and the Manifest project goes hand-in-hand, managing the 200+ git repositories, all part of the AOSP.</p>

<p>Now that we have all the code locally, we need to get all those lines of code into a nice package we can eventually install on a device. The nice guys in Google brought us some nice utilities to help with that. To initialize your environment with those new functions and environment variables, you need to run the command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">source</span> &lt;working <span class="nb">dir</span><span class="o">&gt;</span>/build/envsetup.sh</code></pre></figure>

<p>Note: I’m using Mac OS with “<a href="http://ohmyz.sh/">oh-my-zsh</a>” and “zsh” as my default shell. When running this command from a shell other than “bash”, you’ll get a warning that only bash is supported. From my experience, I can tell that I never ran into a problem. If you know otherwise - let me know, otherwise - I highly recommend this configuration regardless of AOSP work.</p>

<p>Now, we can get this party started..</p>


       
          <a class="btn-default btn" href="/2014/06/04/aosp-part-2-build-variants/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    May
    24th,
    
    2014
  </span>

  <h2>
    <a href="/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">AOSP Part 1: Get the code using the Manifest and Repo tool</a>
  </h2>

  <div>
    
    
       <p>6 months ago, I <a href="https://plus.google.com/113156787654356910368/posts/EG9cFa4Zjhs">moved to New York</a>, the first city I lived in outside of Israel.</p>

<p>With a new job at a new place, I decided to also try a new laptop running a new platform - Mac OS. I always used Windows before that. I have used Linux as a VM and on servers I worked on, but as a primary OS - I sticked with Windows (with no particular reason).  After many recommendations, I decided to give Mac its big break. As one big advantage of Mac over Windows - I could build my own <a href="http://droidlessons.com/what-are-roms-for-android/">Android ROM</a> (Android operation system software, running on a device), which i’ve wanted to try and do for a long time.</p>

<p><img src="/assets/images/2014-05-24-aosp-part-1-get-the-code-using-the-manifest-and-repo/wpid-images-21.jpeg" alt="" class="center-image" /></p>

<p>It wasn’t an easy start..</p>


       
          <a class="btn-default btn" href="/2014/05/24/aosp-part-1-get-the-code-using-the-manifest-and-repo/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    September
    16th,
    
    2013
  </span>

  <h2>
    <a href="/2013/09/16/viewpager-and-hardware-acceleration/">ViewPager and Hardware acceleration</a>
  </h2>

  <div>
    
    
       <p>Last week, Romain Guy posted about <a href="http://www.curious-creature.org/2013/09/13/optimizing-hardware-layers/">Optimizing hardware layers</a>. He explained how hardware layers are a great way to boost the performance of your animations, but can also degrade it.</p>

<p>When your view is backed by a hardware layer, that layer will get updated every time the view itself will update, and after that the layer will be drawn to the screen. Meaning, if your view is altered during an animation – more work is done per frame and you’ll get a drop in your frame-rate. That’s why it’s not wise to change your animated view while it’s backed by a HW layer.</p>

<p>On his post, Romain suggested an easy way to spot such problems, using the “Show hardware layers updates” under the Developer Options. Every time a HW layer is updated – it’ll be highlighted in green.</p>

<p>So I tried it.</p>


       
          <a class="btn-default btn" href="/2013/09/16/viewpager-and-hardware-acceleration/">Read more --> </a>
       
    
    
  </div>

</article>

  
<article class="home">

  <span class="post-date">
    
    July
    24th,
    
    2013
  </span>

  <h2>
    <a href="/2013/07/24/write-your-own-android-sync-adapter/">Write your own Android Sync Adapter</a>
  </h2>

  <div>
    
    
       <p>On my last post on the subject, <em><a href="http://udinic.wordpress.com/2013/04/24/write-your-own-android-authenticator/">Write your own Android Authenticator</a></em>, we embarked on a journey to the unfamiliar part of authentication on Android. I received <strong>many</strong> positive responses about it from you all, and it seems I really helped a lot of people to get to know this feature well.</p>

<p>Since then, I had a lot of stuff going on in my life (getting married is one of them) which delayed the release of this obvious sequel. On this post, our journey continues to another not-well-documented area, which goes hand-in-hand with our own authenticator. It’s no other than the notorious <strong>SyncAdapter</strong>. I’ll show you how to make your app more efficient and robust when it comes to data synchronization, by using sync adapters. The web doesn’t have all the information I’d hope to find about it. I felt like I need to give this feature another one of my in-depth researches, see what this feature is all about, how it works, how to write one, and finally – report back.</p>

<p><a href="/assets/images/2013-07-24-write-your-own-android-sync-adapter/image2.png"><img src="/assets/images/2013-07-24-write-your-own-android-sync-adapter/image_thumb2.png" alt="" /></a></p>

<p>In the screenshot: That’s how a sync adapter looks on the account screen, under the device’s Settings screen.</p>

<p>First, I’ll explain the benefits of the sync adapter. Then, how it works and after that how to build and monitor it. Finally, I’ll introduce the sample app I wrote, demonstrating how the sync adapter works, and also allowing you to play with its settings to learn from experience.</p>


       
          <a class="btn-default btn" href="/2013/07/24/write-your-own-android-sync-adapter/">Read more --> </a>
       
    
    
  </div>

</article>


<ul class="pager"> 

  
  <li class="previous disabled">
    <a>&larr; Newer</a>
  </li>
  
  
  <li>
    <span class="page_number">Page: 1 of 4</span>
  </li>

  
  <li class="next">
    <a href="/page2">Older &rarr;</a>
  </li>
  

</ul>




		<footer>
			<p>
				&copy; 2025 Udi Cohen with Jekyll. Theme: Customized (based of <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek).
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

