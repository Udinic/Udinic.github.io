<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61317191-1', 'auto');
  ga('send', 'pageview');

</script>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Problem solving using the Android source code</title>
	
	<meta name="author" content="Udi Cohen">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">



	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/udinic">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/udinic">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a?s=35" class="img-circle" />
				
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
 		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/archives">Archives</a></li>
				<li><a href="/about">About</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
<!-- 	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>
 -->
	<div class="col-sm-3 sidebar hidden-xs">
		<! -- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<i class="fa fa-cube" ></i>
	</a>

</header>

<div class="text-center sidebar-title">
	UDI COHEN
</div>	


<div class="text-center sidebar-bio">
	My adventures
</div>


	<!-- <i class="fa fa-square"></i> -->

<div class="text-center sidebar-links">
	<a href="/">Home</a>
	| 
	<a href="/archives">Archives</a>	
	|
	<a href="/about">About</a>
</div>

<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm twitter" href="https://twitter.com/udinic">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm github" href="https://github.com/udinic">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm linkedin" href="https://linkedin.com/in/udinic">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm rss" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<! -- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3 main-content">
		<div class="page-header">
  <h1>Problem solving using the Android source code </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   January 
	   4th,
	   
	   2012
	 </span>
	  <div class="article_body">
	  <p>On one of my latest posts, I’ve showed how to download the Android source code, even if you work on Windows (The official instructions are for Linux to Mac). You can check that post <a href="http://udinic.wordpress.com/category/android/aosp/">here</a>. Having the Android source code can be useful not just to find bugs in the operation system, which I bet you do on your spare time, but can also help understand problems in your own code. To demonstrate, here’s a nice story about a problem I had while developing some layout, and found the problem using the Android source code:</p>

<p>I didn’t intend to make any complex layout, just a simple LinearLayout with 3 buttons. I wanted the buttons to be even by size, take all the space they can have and center the text inside of them. Sounds simple, right? I wrote the following layout:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;LinearLayout</span> <span class="na">android:layout_height=</span><span class="s">"70dip"</span>
 <span class="na">android:layout_width=</span><span class="s">"fill_parent"</span>
 <span class="na">android:background=</span><span class="s">"#ffffff"</span><span class="nt">&gt;</span>

<span class="nt">&lt;Button</span>
 <span class="na">android:layout_width=</span><span class="s">"0dip"</span>
 <span class="na">android:layout_height=</span><span class="s">"70dip"</span>
 <span class="na">android:gravity=</span><span class="s">"center"</span>
 <span class="na">android:layout_weight=</span><span class="s">"1"</span>
 <span class="na">android:textSize=</span><span class="s">"15sp"</span>
 <span class="na">android:text=</span><span class="s">"Udinic"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;Button</span>
 <span class="na">android:layout_width=</span><span class="s">"0dip"</span>
 <span class="na">android:layout_height=</span><span class="s">"70dip"</span>
 <span class="na">android:gravity=</span><span class="s">"center"</span>
 <span class="na">android:layout_weight=</span><span class="s">"1"</span>
 <span class="na">android:textSize=</span><span class="s">"15sp"</span>
 <span class="na">android:text=</span><span class="s">"Udinic with a long text"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;Button</span>
 <span class="na">android:layout_width=</span><span class="s">"0dip"</span>
 <span class="na">android:layout_height=</span><span class="s">"70dip"</span>
 <span class="na">android:gravity=</span><span class="s">"center"</span>
 <span class="na">android:layout_weight=</span><span class="s">"1"</span>
 <span class="na">android:textSize=</span><span class="s">"15sp"</span>
 <span class="na">android:text=</span><span class="s">"Chopi"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/LinearLayout&gt;</span></code></pre></figure>

<p>When I ran the code, that’s what I got:</p>

<p><a href="/assets/images/2012-01-04-problem-solving-using-the-android-source-code/1.png"><img src="/assets/images/2012-01-04-problem-solving-using-the-android-source-code/1.png" alt="" /></a></p>

<p>That’s odd…I gave the buttons the same height as the layout, why the hell the middle one got this gap above it?? Changing the layout_height to “fill_parent” to each of them will solve the problem on this example, but in my case it didn’t (I had a little more complex layout :)). Since it seems like it should be as it is in my head, I’ve decided to get to the bottom of this.</p>

<p>My first step was to check what arguments the <a href="http://developer.android.com/reference/android/view/View.html#onLayout(boolean, int, int, int, int)">onLayout()</a> gets. This method is basically in charge of assigning the views’ positions on the layout. Since we have a position problem, it’ll be square one for us. I’ve created a subclass to Button and override the onLayout() method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
 <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onLayout</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">changed</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">top</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bottom</span><span class="o">)</span> <span class="o">{</span>
 <span class="kd">super</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">changed</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">top</span><span class="o">,</span> <span class="n">right</span><span class="o">,</span> <span class="n">bottom</span><span class="o">);</span>
 <span class="o">}</span></code></pre></figure>

<p>I started debugging, not before adding a breakpoint on that method. A peek on the arguments showed me that the “top” argument is the bad boy here. It’s got a 9 instead of a plain 0, which causing this gap on top of the button. Using IntelliJ and the Android source code, I could get up the Call Stack for this method, and found the following code in the LinearLayout’s source:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">....</span>
<span class="k">switch</span> <span class="o">(</span><span class="n">gravity</span> <span class="o">&amp;</span> <span class="nc">Gravity</span><span class="o">.</span><span class="na">VERTICAL_GRAVITY_MASK</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Gravity</span><span class="o">.</span><span class="na">TOP</span><span class="o">:</span>
      <span class="n">childTop</span> <span class="o">=</span> <span class="n">paddingTop</span> <span class="o">+</span> <span class="n">lp</span><span class="o">.</span><span class="na">topMargin</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">childBaseline</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">childTop</span> <span class="o">+=</span> <span class="n">maxAscent</span><span class="o">[</span><span class="no">INDEX_TOP</span><span class="o">]</span> <span class="o">-</span> <span class="n">childBaseline</span><span class="o">;</span>
      <span class="o">}</span>
 <span class="o">....</span></code></pre></figure>

<p>The “childTop”, later to be know as just “top”, is getting its value from the childBaseline, which is calculated on the TextView class, and “Button” is extending it:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBaseline</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mLayout</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getBaseline</span><span class="o">();</span>
    <span class="o">}</span>

   <span class="kt">int</span> <span class="n">voffset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">mGravity</span> <span class="o">&amp;</span> <span class="nc">Gravity</span><span class="o">.</span><span class="na">VERTICAL_GRAVITY_MASK</span><span class="o">)</span> <span class="o">!=</span> <span class="nc">Gravity</span><span class="o">.</span><span class="na">TOP</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">voffset</span> <span class="o">=</span> <span class="n">getVerticalOffset</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

   <span class="k">return</span> <span class="nf">getExtendedPaddingTop</span><span class="o">()</span> <span class="o">+</span> <span class="n">voffset</span> <span class="o">+</span> <span class="n">mLayout</span><span class="o">.</span><span class="na">getLineBaseline</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
 <span class="o">}</span></code></pre></figure>

<p>Only the mLayout.getLineBaseline(0) was held responsible for the evil gap, and after exploring it a bit got me to realize that this is the baseline for the layout, in charge of making all the text in all the TextView/Buttons under it to be aligned to the same horizontal line! After looking closely at my phone, I could see that the text is really aligned to the same baseline (and in the real case, it wasn’t as obvious as on this example). This might be great for other applications of buttons inside a layout, but not for my case. Apparently the layout’s “baselineAligned” flag is always “true” unless told otherwise, which is kind of confusing if you’ll ask me. Adding the android:baselineAligned=”false” to the layout got rid of the problem:</p>

<p><a href="/assets/images/2012-01-04-problem-solving-using-the-android-source-code/2.png"><img src="/assets/images/2012-01-04-problem-solving-using-the-android-source-code/2.png" alt="" /></a></p>

<p>This experience can show you how you can, pretty easily, find problems in your code just by having the operation system’s code. Maybe a clearer behavior of the LinearLayout could be better, but sadly every framework, no matter how great it is, got its dark side.</p>

<p>Download the source code, attach it to your IDE, it’ll probably come in handy in the future.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Android-ref">
					Android</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#AOSP-ref">
					AOSP</span>
					
				</a></li>
			
		  
		</ul>
		  
		
		<ul class="tag_box list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#Android-ref">
					Android
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#AOSP-ref">
					AOSP
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#baseline-ref">
					baseline
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#baselineAligned-ref">
					baselineAligned
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#debug-ref">
					debug
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#gap-ref">
					gap
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#layout code-ref">
					layout code
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#LinearLayout-ref">
					LinearLayout
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#source-code-ref">
					source-code
					
					</a>
				</li>
			
		  
		  
		</ul>
		  


	<div align="center" class="author-container">
		<figure class="author-img-post">
			<img src="http://www.gravatar.com/avatar/107169775092a3ef4ae94fad5695613a" class="img-circle author-image" />			
		</figure>
        <h4 class="section-title">Written by Udi Cohen</h4>
	</div>
	<div class="share-container">					
      <section class="share" align="center">
        <p class="section-title">Share this post:</p>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Problem solving using the Android source code&via=udinic"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" 
           onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+window.location.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm reddit"
           onclick="window.open('http://www.reddit.com/submit?url='+window.location.href+'&title=Problem solving using the Android source code', 'reddit-share', 'width=580,height=530');return false;">
          <i class="fa fa-reddit fa-lg"></i>
          Reddit
        </a>
      </section>

    </div>

    <!-- <div class="clearfix"></div> -->

	<!-- <hr> -->
	
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'udinic-blog';
    var disqus_identifier = '/2012/01/04/problem-solving-using-the-android-source-code/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	</div>
	








</article>
<div class="clearfix"></div>



		<footer>
			<p>
				&copy; 2025 Udi Cohen with Jekyll. Theme: Customized (based of <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek).
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>

